\doxysection{bt\+Multi\+Body.\+cpp}
\hypertarget{bt_multi_body_8cpp_source}{}\label{bt_multi_body_8cpp_source}\index{C:/Users/Usuario/Documents/pruebas-\/c/Practica Animación/libraries/bullet-\/3.17/src/BulletDynamics/Featherstone/btMultiBody.cpp@{C:/Users/Usuario/Documents/pruebas-\/c/Practica Animación/libraries/bullet-\/3.17/src/BulletDynamics/Featherstone/btMultiBody.cpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{00002\ \textcolor{comment}{\ *\ PURPOSE:}}
\DoxyCodeLine{00003\ \textcolor{comment}{\ *\ \ \ Class\ representing\ an\ articulated\ rigid\ body.\ Stores\ the\ body's}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ *\ \ \ current\ state,\ allows\ forces\ and\ torques\ to\ be\ set,\ handles}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ *\ \ \ timestepping\ and\ implements\ Featherstone's\ algorithm.}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ *\ \ \ }}
\DoxyCodeLine{00007\ \textcolor{comment}{\ *\ COPYRIGHT:}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ *\ \ \ Copyright\ (C)\ Stephen\ Thompson,\ <stephen@solarflare.org.uk>,\ 2011-\/2013}}
\DoxyCodeLine{00009\ \textcolor{comment}{\ *\ \ \ Portions\ written\ By\ Erwin\ Coumans:\ connection\ to\ LCP\ solver,\ various\ multibody\ constraints,\ replacing\ Eigen\ math\ library\ by\ Bullet\ LinearMath\ and\ a\ dedicated\ 6x6\ matrix\ inverse\ (solveImatrix)}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ *\ \ \ Portions\ written\ By\ Jakub\ Stepien:\ support\ for\ multi-\/DOF\ constraints,\ introduction\ of\ spatial\ algebra\ and\ several\ other\ improvements}}
\DoxyCodeLine{00011\ \textcolor{comment}{}}
\DoxyCodeLine{00012\ \textcolor{comment}{\ This\ software\ is\ provided\ 'as-\/is',\ without\ any\ express\ or\ implied\ warranty.}}
\DoxyCodeLine{00013\ \textcolor{comment}{\ In\ no\ event\ will\ the\ authors\ be\ held\ liable\ for\ any\ damages\ arising\ from\ the\ use\ of\ this\ software.}}
\DoxyCodeLine{00014\ \textcolor{comment}{\ Permission\ is\ granted\ to\ anyone\ to\ use\ this\ software\ for\ any\ purpose,}}
\DoxyCodeLine{00015\ \textcolor{comment}{\ including\ commercial\ applications,\ and\ to\ alter\ it\ and\ redistribute\ it\ freely,}}
\DoxyCodeLine{00016\ \textcolor{comment}{\ subject\ to\ the\ following\ restrictions:}}
\DoxyCodeLine{00017\ \textcolor{comment}{\ }}
\DoxyCodeLine{00018\ \textcolor{comment}{\ 1.\ The\ origin\ of\ this\ software\ must\ not\ be\ misrepresented;\ you\ must\ not\ claim\ that\ you\ wrote\ the\ original\ software.\ If\ you\ use\ this\ software\ in\ a\ product,\ an\ acknowledgment\ in\ the\ product\ documentation\ would\ be\ appreciated\ but\ is\ not\ required.}}
\DoxyCodeLine{00019\ \textcolor{comment}{\ 2.\ Altered\ source\ versions\ must\ be\ plainly\ marked\ as\ such,\ and\ must\ not\ be\ misrepresented\ as\ being\ the\ original\ software.}}
\DoxyCodeLine{00020\ \textcolor{comment}{\ 3.\ This\ notice\ may\ not\ be\ removed\ or\ altered\ from\ any\ source\ distribution.}}
\DoxyCodeLine{00021\ \textcolor{comment}{\ }}
\DoxyCodeLine{00022\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00023\ }
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#include\ "{}btMultiBody.h"{}}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#include\ "{}btMultiBodyLink.h"{}}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#include\ "{}btMultiBodyLinkCollider.h"{}}}
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#include\ "{}btMultiBodyJointFeedback.h"{}}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#include\ "{}LinearMath/btTransformUtil.h"{}}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#include\ "{}LinearMath/btSerializer.h"{}}}
\DoxyCodeLine{00030\ \textcolor{comment}{//\#include\ "{}Bullet3Common/b3Logging.h"{}}}
\DoxyCodeLine{00031\ \textcolor{comment}{//\ \#define\ INCLUDE\_GYRO\_TERM}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \textcolor{keyword}{namespace}}
\DoxyCodeLine{00035\ \{}
\DoxyCodeLine{00036\ \textcolor{keyword}{const}\ btScalar\ INITIAL\_SLEEP\_EPSILON\ =\ btScalar(0.05);\ \ \textcolor{comment}{//\ this\ is\ a\ squared\ velocity\ (m\string^2\ s\string^-\/2)}}
\DoxyCodeLine{00037\ \textcolor{keyword}{const}\ btScalar\ INITIAL\_SLEEP\_TIMEOUT\ =\ btScalar(2);\ \ \ \ \ \textcolor{comment}{//\ in\ seconds}}
\DoxyCodeLine{00038\ \}\ \ \textcolor{comment}{//\ namespace}}
\DoxyCodeLine{00039\ }
\DoxyCodeLine{00040\ \textcolor{keywordtype}{void}\ btMultiBody::spatialTransform(\textcolor{keyword}{const}\ btMatrix3x3\ \&rotation\_matrix,\ \ \textcolor{comment}{//\ rotates\ vectors\ in\ 'from'\ frame\ to\ vectors\ in\ 'to'\ frame}}
\DoxyCodeLine{00041\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&displacement,\ \ \ \ \ \ \ \textcolor{comment}{//\ vector\ from\ origin\ of\ 'from'\ frame\ to\ origin\ of\ 'to'\ frame,\ in\ 'to'\ coordinates}}
\DoxyCodeLine{00042\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&top\_in,\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ top\ part\ of\ input\ vector}}
\DoxyCodeLine{00043\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&bottom\_in,\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ bottom\ part\ of\ input\ vector}}
\DoxyCodeLine{00044\ \ \ \ \ btVector3\ \&top\_out,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ top\ part\ of\ output\ vector}}
\DoxyCodeLine{00045\ \ \ \ \ btVector3\ \&bottom\_out)\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ bottom\ part\ of\ output\ vector}}
\DoxyCodeLine{00046\ \{}
\DoxyCodeLine{00047\ \ \ \ \ top\_out\ =\ rotation\_matrix\ *\ top\_in;}
\DoxyCodeLine{00048\ \ \ \ \ bottom\_out\ =\ -\/displacement.cross(top\_out)\ +\ rotation\_matrix\ *\ bottom\_in;}
\DoxyCodeLine{00049\ \}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \textcolor{keyword}{namespace}}
\DoxyCodeLine{00052\ \{}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#if\ 0}}
\DoxyCodeLine{00056\ \ \ \ \ \textcolor{keywordtype}{void}\ InverseSpatialTransform(\textcolor{keyword}{const}\ btMatrix3x3\ \&rotation\_matrix,}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&displacement,}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&top\_in,}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&bottom\_in,}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ \&top\_out,}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ \&bottom\_out)}
\DoxyCodeLine{00062\ \ \ \ \ \{}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ top\_out\ =\ rotation\_matrix.transpose()\ *\ top\_in;}
\DoxyCodeLine{00064\ \ \ \ \ \ \ \ \ bottom\_out\ =\ rotation\_matrix.transpose()\ *\ (bottom\_in\ +\ displacement.cross(top\_in));\ \ \ \ \ \ \ \ }
\DoxyCodeLine{00065\ \ \ \ \ \}}
\DoxyCodeLine{00066\ }
\DoxyCodeLine{00067\ \ \ \ \ btScalar\ SpatialDotProduct(\textcolor{keyword}{const}\ btVector3\ \&a\_top,}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&a\_bottom,}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&b\_top,}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&b\_bottom)}
\DoxyCodeLine{00071\ \ \ \ \ \{}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ a\_bottom.dot(b\_top)\ +\ a\_top.dot(b\_bottom);}
\DoxyCodeLine{00073\ \ \ \ \ \}}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordtype}{void}\ SpatialCrossProduct(\textcolor{keyword}{const}\ btVector3\ \&a\_top,}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&a\_bottom,}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&b\_top,}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&b\_bottom,}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ \&top\_out,}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ \&bottom\_out)}
\DoxyCodeLine{00081\ \ \ \ \ \{}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ top\_out\ =\ a\_top.cross(b\_top);}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ bottom\_out\ =\ a\_bottom.cross(b\_top)\ +\ a\_top.cross(b\_bottom);}
\DoxyCodeLine{00084\ \ \ \ \ \}}
\DoxyCodeLine{00085\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \}\ \ \textcolor{comment}{//\ namespace}}
\DoxyCodeLine{00088\ }
\DoxyCodeLine{00089\ \textcolor{comment}{//}}
\DoxyCodeLine{00090\ \textcolor{comment}{//\ Implementation\ of\ class\ btMultiBody}}
\DoxyCodeLine{00091\ \textcolor{comment}{//}}
\DoxyCodeLine{00092\ }
\DoxyCodeLine{00093\ btMultiBody::btMultiBody(\textcolor{keywordtype}{int}\ n\_links,}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ mass,}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&inertia,}
\DoxyCodeLine{00096\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ fixedBase,}
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ canSleep,}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ \textcolor{comment}{/*deprecatedUseMultiDof*/})}
\DoxyCodeLine{00099\ \ \ \ \ :\ m\_baseCollider(0),}
\DoxyCodeLine{00100\ \ \ \ \ \ \ m\_baseName(0),}
\DoxyCodeLine{00101\ \ \ \ \ \ \ m\_basePos(0,\ 0,\ 0),}
\DoxyCodeLine{00102\ \ \ \ \ \ \ m\_baseQuat(0,\ 0,\ 0,\ 1),}
\DoxyCodeLine{00103\ \ \ \ \ \ \ m\_basePos\_interpolate(0,\ 0,\ 0),}
\DoxyCodeLine{00104\ \ \ \ \ \ \ m\_baseQuat\_interpolate(0,\ 0,\ 0,\ 1),}
\DoxyCodeLine{00105\ \ \ \ \ \ \ m\_baseMass(mass),}
\DoxyCodeLine{00106\ \ \ \ \ \ \ m\_baseInertia(inertia),}
\DoxyCodeLine{00107\ }
\DoxyCodeLine{00108\ \ \ \ \ \ \ m\_fixedBase(fixedBase),}
\DoxyCodeLine{00109\ \ \ \ \ \ \ m\_awake(true),}
\DoxyCodeLine{00110\ \ \ \ \ \ \ m\_canSleep(canSleep),}
\DoxyCodeLine{00111\ \ \ \ \ \ \ m\_canWakeup(true),}
\DoxyCodeLine{00112\ \ \ \ \ \ \ m\_sleepTimer(0),}
\DoxyCodeLine{00113\ \ \ \ \ \ \ m\_sleepEpsilon(INITIAL\_SLEEP\_EPSILON),}
\DoxyCodeLine{00114\ \ \ \ \ \ \ m\_sleepTimeout(INITIAL\_SLEEP\_TIMEOUT),}
\DoxyCodeLine{00115\ }
\DoxyCodeLine{00116\ \ \ \ \ \ \ m\_userObjectPointer(0),}
\DoxyCodeLine{00117\ \ \ \ \ \ \ m\_userIndex2(-\/1),}
\DoxyCodeLine{00118\ \ \ \ \ \ \ m\_userIndex(-\/1),}
\DoxyCodeLine{00119\ \ \ \ \ \ \ m\_companionId(-\/1),}
\DoxyCodeLine{00120\ \ \ \ \ \ \ m\_linearDamping(0.04f),}
\DoxyCodeLine{00121\ \ \ \ \ \ \ m\_angularDamping(0.04f),}
\DoxyCodeLine{00122\ \ \ \ \ \ \ m\_useGyroTerm(true),}
\DoxyCodeLine{00123\ \ \ \ \ \ \ m\_maxAppliedImpulse(1000.f),}
\DoxyCodeLine{00124\ \ \ \ \ \ \ m\_maxCoordinateVelocity(100.f),}
\DoxyCodeLine{00125\ \ \ \ \ \ \ m\_hasSelfCollision(true),}
\DoxyCodeLine{00126\ \ \ \ \ \ \ \_\_posUpdated(false),}
\DoxyCodeLine{00127\ \ \ \ \ \ \ m\_dofCount(0),}
\DoxyCodeLine{00128\ \ \ \ \ \ \ m\_posVarCnt(0),}
\DoxyCodeLine{00129\ \ \ \ \ \ \ m\_useRK4(false),}
\DoxyCodeLine{00130\ \ \ \ \ \ \ m\_useGlobalVelocities(false),}
\DoxyCodeLine{00131\ \ \ \ \ \ \ m\_internalNeedsJointFeedback(false),}
\DoxyCodeLine{00132\ \ \ \ \ \ \ \ \ m\_kinematic\_calculate\_velocity(false)}
\DoxyCodeLine{00133\ \{}
\DoxyCodeLine{00134\ \ \ \ \ m\_cachedInertiaTopLeft.setValue(0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0);}
\DoxyCodeLine{00135\ \ \ \ \ m\_cachedInertiaTopRight.setValue(0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0);}
\DoxyCodeLine{00136\ \ \ \ \ m\_cachedInertiaLowerLeft.setValue(0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0);}
\DoxyCodeLine{00137\ \ \ \ \ m\_cachedInertiaLowerRight.setValue(0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0);}
\DoxyCodeLine{00138\ \ \ \ \ m\_cachedInertiaValid\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00139\ }
\DoxyCodeLine{00140\ \ \ \ \ m\_links.resize(n\_links);}
\DoxyCodeLine{00141\ \ \ \ \ m\_matrixBuf.resize(n\_links\ +\ 1);}
\DoxyCodeLine{00142\ }
\DoxyCodeLine{00143\ \ \ \ \ m\_baseForce.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00144\ \ \ \ \ m\_baseTorque.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ \ \ \ \ clearConstraintForces();}
\DoxyCodeLine{00147\ \ \ \ \ clearForcesAndTorques();}
\DoxyCodeLine{00148\ \}}
\DoxyCodeLine{00149\ }
\DoxyCodeLine{00150\ btMultiBody::\string~btMultiBody()}
\DoxyCodeLine{00151\ \{}
\DoxyCodeLine{00152\ \}}
\DoxyCodeLine{00153\ }
\DoxyCodeLine{00154\ \textcolor{keywordtype}{void}\ btMultiBody::setupFixed(\textcolor{keywordtype}{int}\ i,}
\DoxyCodeLine{00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ mass,}
\DoxyCodeLine{00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&inertia,}
\DoxyCodeLine{00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ parent,}
\DoxyCodeLine{00158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&rotParentToThis,}
\DoxyCodeLine{00159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&parentComToThisPivotOffset,}
\DoxyCodeLine{00160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&thisPivotToThisComOffset,\ \textcolor{keywordtype}{bool}\ \textcolor{comment}{/*deprecatedDisableParentCollision*/})}
\DoxyCodeLine{00161\ \{}
\DoxyCodeLine{00162\ \ \ \ \ m\_links[i].m\_mass\ =\ mass;}
\DoxyCodeLine{00163\ \ \ \ \ m\_links[i].m\_inertiaLocal\ =\ inertia;}
\DoxyCodeLine{00164\ \ \ \ \ m\_links[i].m\_parent\ =\ parent;}
\DoxyCodeLine{00165\ \ \ \ \ m\_links[i].setAxisTop(0,\ 0.,\ 0.,\ 0.);}
\DoxyCodeLine{00166\ \ \ \ \ m\_links[i].setAxisBottom(0,\ btVector3(0,\ 0,\ 0));}
\DoxyCodeLine{00167\ \ \ \ \ m\_links[i].m\_zeroRotParentToThis\ =\ rotParentToThis;}
\DoxyCodeLine{00168\ \ \ \ \ m\_links[i].m\_dVector\ =\ thisPivotToThisComOffset;}
\DoxyCodeLine{00169\ \ \ \ \ m\_links[i].m\_eVector\ =\ parentComToThisPivotOffset;}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \ \ \ \ m\_links[i].m\_jointType\ =\ btMultibodyLink::eFixed;}
\DoxyCodeLine{00172\ \ \ \ \ m\_links[i].m\_dofCount\ =\ 0;}
\DoxyCodeLine{00173\ \ \ \ \ m\_links[i].m\_posVarCount\ =\ 0;}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \ \ \ \ m\_links[i].m\_flags\ |=\ BT\_MULTIBODYLINKFLAGS\_DISABLE\_PARENT\_COLLISION;}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \ \ \ \ m\_links[i].updateCacheMultiDof();}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \ \ updateLinksDofOffsets();}
\DoxyCodeLine{00180\ \}}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \textcolor{keywordtype}{void}\ btMultiBody::setupPrismatic(\textcolor{keywordtype}{int}\ i,}
\DoxyCodeLine{00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ mass,}
\DoxyCodeLine{00184\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&inertia,}
\DoxyCodeLine{00185\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ parent,}
\DoxyCodeLine{00186\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&rotParentToThis,}
\DoxyCodeLine{00187\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&jointAxis,}
\DoxyCodeLine{00188\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&parentComToThisPivotOffset,}
\DoxyCodeLine{00189\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&thisPivotToThisComOffset,}
\DoxyCodeLine{00190\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ disableParentCollision)}
\DoxyCodeLine{00191\ \{}
\DoxyCodeLine{00192\ \ \ \ \ m\_dofCount\ +=\ 1;}
\DoxyCodeLine{00193\ \ \ \ \ m\_posVarCnt\ +=\ 1;}
\DoxyCodeLine{00194\ }
\DoxyCodeLine{00195\ \ \ \ \ m\_links[i].m\_mass\ =\ mass;}
\DoxyCodeLine{00196\ \ \ \ \ m\_links[i].m\_inertiaLocal\ =\ inertia;}
\DoxyCodeLine{00197\ \ \ \ \ m\_links[i].m\_parent\ =\ parent;}
\DoxyCodeLine{00198\ \ \ \ \ m\_links[i].m\_zeroRotParentToThis\ =\ rotParentToThis;}
\DoxyCodeLine{00199\ \ \ \ \ m\_links[i].setAxisTop(0,\ 0.,\ 0.,\ 0.);}
\DoxyCodeLine{00200\ \ \ \ \ m\_links[i].setAxisBottom(0,\ jointAxis);}
\DoxyCodeLine{00201\ \ \ \ \ m\_links[i].m\_eVector\ =\ parentComToThisPivotOffset;}
\DoxyCodeLine{00202\ \ \ \ \ m\_links[i].m\_dVector\ =\ thisPivotToThisComOffset;}
\DoxyCodeLine{00203\ \ \ \ \ m\_links[i].m\_cachedRotParentToThis\ =\ rotParentToThis;}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \ \ \ \ m\_links[i].m\_jointType\ =\ btMultibodyLink::ePrismatic;}
\DoxyCodeLine{00206\ \ \ \ \ m\_links[i].m\_dofCount\ =\ 1;}
\DoxyCodeLine{00207\ \ \ \ \ m\_links[i].m\_posVarCount\ =\ 1;}
\DoxyCodeLine{00208\ \ \ \ \ m\_links[i].m\_jointPos[0]\ =\ 0.f;}
\DoxyCodeLine{00209\ \ \ \ \ m\_links[i].m\_jointTorque[0]\ =\ 0.f;}
\DoxyCodeLine{00210\ }
\DoxyCodeLine{00211\ \ \ \ \ \textcolor{keywordflow}{if}\ (disableParentCollision)}
\DoxyCodeLine{00212\ \ \ \ \ \ \ \ \ m\_links[i].m\_flags\ |=\ BT\_MULTIBODYLINKFLAGS\_DISABLE\_PARENT\_COLLISION;}
\DoxyCodeLine{00213\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00214\ }
\DoxyCodeLine{00215\ \ \ \ \ m\_links[i].updateCacheMultiDof();}
\DoxyCodeLine{00216\ }
\DoxyCodeLine{00217\ \ \ \ \ updateLinksDofOffsets();}
\DoxyCodeLine{00218\ \}}
\DoxyCodeLine{00219\ }
\DoxyCodeLine{00220\ \textcolor{keywordtype}{void}\ btMultiBody::setupRevolute(\textcolor{keywordtype}{int}\ i,}
\DoxyCodeLine{00221\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ mass,}
\DoxyCodeLine{00222\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&inertia,}
\DoxyCodeLine{00223\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ parent,}
\DoxyCodeLine{00224\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&rotParentToThis,}
\DoxyCodeLine{00225\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&jointAxis,}
\DoxyCodeLine{00226\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&parentComToThisPivotOffset,}
\DoxyCodeLine{00227\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&thisPivotToThisComOffset,}
\DoxyCodeLine{00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ disableParentCollision)}
\DoxyCodeLine{00229\ \{}
\DoxyCodeLine{00230\ \ \ \ \ m\_dofCount\ +=\ 1;}
\DoxyCodeLine{00231\ \ \ \ \ m\_posVarCnt\ +=\ 1;}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \ \ \ \ m\_links[i].m\_mass\ =\ mass;}
\DoxyCodeLine{00234\ \ \ \ \ m\_links[i].m\_inertiaLocal\ =\ inertia;}
\DoxyCodeLine{00235\ \ \ \ \ m\_links[i].m\_parent\ =\ parent;}
\DoxyCodeLine{00236\ \ \ \ \ m\_links[i].m\_zeroRotParentToThis\ =\ rotParentToThis;}
\DoxyCodeLine{00237\ \ \ \ \ m\_links[i].setAxisTop(0,\ jointAxis);}
\DoxyCodeLine{00238\ \ \ \ \ m\_links[i].setAxisBottom(0,\ jointAxis.cross(thisPivotToThisComOffset));}
\DoxyCodeLine{00239\ \ \ \ \ m\_links[i].m\_dVector\ =\ thisPivotToThisComOffset;}
\DoxyCodeLine{00240\ \ \ \ \ m\_links[i].m\_eVector\ =\ parentComToThisPivotOffset;}
\DoxyCodeLine{00241\ }
\DoxyCodeLine{00242\ \ \ \ \ m\_links[i].m\_jointType\ =\ btMultibodyLink::eRevolute;}
\DoxyCodeLine{00243\ \ \ \ \ m\_links[i].m\_dofCount\ =\ 1;}
\DoxyCodeLine{00244\ \ \ \ \ m\_links[i].m\_posVarCount\ =\ 1;}
\DoxyCodeLine{00245\ \ \ \ \ m\_links[i].m\_jointPos[0]\ =\ 0.f;}
\DoxyCodeLine{00246\ \ \ \ \ m\_links[i].m\_jointTorque[0]\ =\ 0.f;}
\DoxyCodeLine{00247\ }
\DoxyCodeLine{00248\ \ \ \ \ \textcolor{keywordflow}{if}\ (disableParentCollision)}
\DoxyCodeLine{00249\ \ \ \ \ \ \ \ \ m\_links[i].m\_flags\ |=\ BT\_MULTIBODYLINKFLAGS\_DISABLE\_PARENT\_COLLISION;}
\DoxyCodeLine{00250\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00251\ \ \ \ \ m\_links[i].updateCacheMultiDof();}
\DoxyCodeLine{00252\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00253\ \ \ \ \ updateLinksDofOffsets();}
\DoxyCodeLine{00254\ \}}
\DoxyCodeLine{00255\ }
\DoxyCodeLine{00256\ \textcolor{keywordtype}{void}\ btMultiBody::setupSpherical(\textcolor{keywordtype}{int}\ i,}
\DoxyCodeLine{00257\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ mass,}
\DoxyCodeLine{00258\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&inertia,}
\DoxyCodeLine{00259\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ parent,}
\DoxyCodeLine{00260\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&rotParentToThis,}
\DoxyCodeLine{00261\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&parentComToThisPivotOffset,}
\DoxyCodeLine{00262\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&thisPivotToThisComOffset,}
\DoxyCodeLine{00263\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ disableParentCollision)}
\DoxyCodeLine{00264\ \{}
\DoxyCodeLine{00265\ \ \ \ \ m\_dofCount\ +=\ 3;}
\DoxyCodeLine{00266\ \ \ \ \ m\_posVarCnt\ +=\ 4;}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \ \ \ \ m\_links[i].m\_mass\ =\ mass;}
\DoxyCodeLine{00269\ \ \ \ \ m\_links[i].m\_inertiaLocal\ =\ inertia;}
\DoxyCodeLine{00270\ \ \ \ \ m\_links[i].m\_parent\ =\ parent;}
\DoxyCodeLine{00271\ \ \ \ \ m\_links[i].m\_zeroRotParentToThis\ =\ rotParentToThis;}
\DoxyCodeLine{00272\ \ \ \ \ m\_links[i].m\_dVector\ =\ thisPivotToThisComOffset;}
\DoxyCodeLine{00273\ \ \ \ \ m\_links[i].m\_eVector\ =\ parentComToThisPivotOffset;}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \ \ \ \ m\_links[i].m\_jointType\ =\ btMultibodyLink::eSpherical;}
\DoxyCodeLine{00276\ \ \ \ \ m\_links[i].m\_dofCount\ =\ 3;}
\DoxyCodeLine{00277\ \ \ \ \ m\_links[i].m\_posVarCount\ =\ 4;}
\DoxyCodeLine{00278\ \ \ \ \ m\_links[i].setAxisTop(0,\ 1.f,\ 0.f,\ 0.f);}
\DoxyCodeLine{00279\ \ \ \ \ m\_links[i].setAxisTop(1,\ 0.f,\ 1.f,\ 0.f);}
\DoxyCodeLine{00280\ \ \ \ \ m\_links[i].setAxisTop(2,\ 0.f,\ 0.f,\ 1.f);}
\DoxyCodeLine{00281\ \ \ \ \ m\_links[i].setAxisBottom(0,\ m\_links[i].getAxisTop(0).cross(thisPivotToThisComOffset));}
\DoxyCodeLine{00282\ \ \ \ \ m\_links[i].setAxisBottom(1,\ m\_links[i].getAxisTop(1).cross(thisPivotToThisComOffset));}
\DoxyCodeLine{00283\ \ \ \ \ m\_links[i].setAxisBottom(2,\ m\_links[i].getAxisTop(2).cross(thisPivotToThisComOffset));}
\DoxyCodeLine{00284\ \ \ \ \ m\_links[i].m\_jointPos[0]\ =\ m\_links[i].m\_jointPos[1]\ =\ m\_links[i].m\_jointPos[2]\ =\ 0.f;}
\DoxyCodeLine{00285\ \ \ \ \ m\_links[i].m\_jointPos[3]\ =\ 1.f;}
\DoxyCodeLine{00286\ \ \ \ \ m\_links[i].m\_jointTorque[0]\ =\ m\_links[i].m\_jointTorque[1]\ =\ m\_links[i].m\_jointTorque[2]\ =\ 0.f;}
\DoxyCodeLine{00287\ }
\DoxyCodeLine{00288\ \ \ \ \ \textcolor{keywordflow}{if}\ (disableParentCollision)}
\DoxyCodeLine{00289\ \ \ \ \ \ \ \ \ m\_links[i].m\_flags\ |=\ BT\_MULTIBODYLINKFLAGS\_DISABLE\_PARENT\_COLLISION;}
\DoxyCodeLine{00290\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00291\ \ \ \ \ m\_links[i].updateCacheMultiDof();}
\DoxyCodeLine{00292\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00293\ \ \ \ \ updateLinksDofOffsets();}
\DoxyCodeLine{00294\ \}}
\DoxyCodeLine{00295\ }
\DoxyCodeLine{00296\ \textcolor{keywordtype}{void}\ btMultiBody::setupPlanar(\textcolor{keywordtype}{int}\ i,}
\DoxyCodeLine{00297\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ mass,}
\DoxyCodeLine{00298\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&inertia,}
\DoxyCodeLine{00299\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ parent,}
\DoxyCodeLine{00300\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&rotParentToThis,}
\DoxyCodeLine{00301\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&rotationAxis,}
\DoxyCodeLine{00302\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&parentComToThisComOffset,}
\DoxyCodeLine{00303\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}\ disableParentCollision)}
\DoxyCodeLine{00304\ \{}
\DoxyCodeLine{00305\ \ \ \ \ m\_dofCount\ +=\ 3;}
\DoxyCodeLine{00306\ \ \ \ \ m\_posVarCnt\ +=\ 3;}
\DoxyCodeLine{00307\ }
\DoxyCodeLine{00308\ \ \ \ \ m\_links[i].m\_mass\ =\ mass;}
\DoxyCodeLine{00309\ \ \ \ \ m\_links[i].m\_inertiaLocal\ =\ inertia;}
\DoxyCodeLine{00310\ \ \ \ \ m\_links[i].m\_parent\ =\ parent;}
\DoxyCodeLine{00311\ \ \ \ \ m\_links[i].m\_zeroRotParentToThis\ =\ rotParentToThis;}
\DoxyCodeLine{00312\ \ \ \ \ m\_links[i].m\_dVector.setZero();}
\DoxyCodeLine{00313\ \ \ \ \ m\_links[i].m\_eVector\ =\ parentComToThisComOffset;}
\DoxyCodeLine{00314\ }
\DoxyCodeLine{00315\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00316\ \ \ \ \ btVector3\ vecNonParallelToRotAxis(1,\ 0,\ 0);}
\DoxyCodeLine{00317\ \ \ \ \ \textcolor{keywordflow}{if}\ (rotationAxis.normalized().dot(vecNonParallelToRotAxis)\ >\ 0.999)}
\DoxyCodeLine{00318\ \ \ \ \ \ \ \ \ vecNonParallelToRotAxis.setValue(0,\ 1,\ 0);}
\DoxyCodeLine{00319\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00320\ }
\DoxyCodeLine{00321\ \ \ \ \ m\_links[i].m\_jointType\ =\ btMultibodyLink::ePlanar;}
\DoxyCodeLine{00322\ \ \ \ \ m\_links[i].m\_dofCount\ =\ 3;}
\DoxyCodeLine{00323\ \ \ \ \ m\_links[i].m\_posVarCount\ =\ 3;}
\DoxyCodeLine{00324\ \ \ \ \ btVector3\ n\ =\ rotationAxis.normalized();}
\DoxyCodeLine{00325\ \ \ \ \ m\_links[i].setAxisTop(0,\ n[0],\ n[1],\ n[2]);}
\DoxyCodeLine{00326\ \ \ \ \ m\_links[i].setAxisTop(1,\ 0,\ 0,\ 0);}
\DoxyCodeLine{00327\ \ \ \ \ m\_links[i].setAxisTop(2,\ 0,\ 0,\ 0);}
\DoxyCodeLine{00328\ \ \ \ \ m\_links[i].setAxisBottom(0,\ 0,\ 0,\ 0);}
\DoxyCodeLine{00329\ \ \ \ \ btVector3\ cr\ =\ m\_links[i].getAxisTop(0).cross(vecNonParallelToRotAxis);}
\DoxyCodeLine{00330\ \ \ \ \ m\_links[i].setAxisBottom(1,\ cr[0],\ cr[1],\ cr[2]);}
\DoxyCodeLine{00331\ \ \ \ \ cr\ =\ m\_links[i].getAxisBottom(1).cross(m\_links[i].getAxisTop(0));}
\DoxyCodeLine{00332\ \ \ \ \ m\_links[i].setAxisBottom(2,\ cr[0],\ cr[1],\ cr[2]);}
\DoxyCodeLine{00333\ \ \ \ \ m\_links[i].m\_jointPos[0]\ =\ m\_links[i].m\_jointPos[1]\ =\ m\_links[i].m\_jointPos[2]\ =\ 0.f;}
\DoxyCodeLine{00334\ \ \ \ \ m\_links[i].m\_jointTorque[0]\ =\ m\_links[i].m\_jointTorque[1]\ =\ m\_links[i].m\_jointTorque[2]\ =\ 0.f;}
\DoxyCodeLine{00335\ }
\DoxyCodeLine{00336\ \ \ \ \ \textcolor{keywordflow}{if}\ (disableParentCollision)}
\DoxyCodeLine{00337\ \ \ \ \ \ \ \ \ m\_links[i].m\_flags\ |=\ BT\_MULTIBODYLINKFLAGS\_DISABLE\_PARENT\_COLLISION;}
\DoxyCodeLine{00338\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00339\ \ \ \ \ m\_links[i].updateCacheMultiDof();}
\DoxyCodeLine{00340\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00341\ \ \ \ \ updateLinksDofOffsets();}
\DoxyCodeLine{00342\ }
\DoxyCodeLine{00343\ \ \ \ \ m\_links[i].setAxisBottom(1,\ m\_links[i].getAxisBottom(1).normalized());}
\DoxyCodeLine{00344\ \ \ \ \ m\_links[i].setAxisBottom(2,\ m\_links[i].getAxisBottom(2).normalized());}
\DoxyCodeLine{00345\ \}}
\DoxyCodeLine{00346\ }
\DoxyCodeLine{00347\ \textcolor{keywordtype}{void}\ btMultiBody::finalizeMultiDof()}
\DoxyCodeLine{00348\ \{}
\DoxyCodeLine{00349\ \ \ \ \ m\_deltaV.resize(0);}
\DoxyCodeLine{00350\ \ \ \ \ m\_deltaV.resize(6\ +\ m\_dofCount);}
\DoxyCodeLine{00351\ \ \ \ \ m\_splitV.resize(0);}
\DoxyCodeLine{00352\ \ \ \ \ m\_splitV.resize(6\ +\ m\_dofCount);}
\DoxyCodeLine{00353\ \ \ \ \ m\_realBuf.resize(6\ +\ m\_dofCount\ +\ m\_dofCount\ *\ m\_dofCount\ +\ 6\ +\ m\_dofCount);\ \ \textcolor{comment}{//m\_dofCount\ for\ joint-\/space\ vels\ +\ m\_dofCount\string^2\ for\ "{}D"{}\ matrices\ +\ delta-\/pos\ vector\ (6\ base\ "{}vels"{}\ +\ joint\ "{}vels"{})}}
\DoxyCodeLine{00354\ \ \ \ \ m\_vectorBuf.resize(2\ *\ m\_dofCount);\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//two\ 3-\/vectors\ (i.e.\ one\ six-\/vector)\ for\ each\ system\ dof\ ("{}h"{}\ matrices)}}
\DoxyCodeLine{00355\ \ \ \ \ m\_matrixBuf.resize(m\_links.size()\ +\ 1);}
\DoxyCodeLine{00356\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ m\_vectorBuf.\mbox{\hyperlink{classbt_aligned_object_array_a31de8d83d29c6edd1493fc583091194c}{size}}();\ i++)}
\DoxyCodeLine{00357\ \ \ \ \ \{}
\DoxyCodeLine{00358\ \ \ \ \ \ \ \ \ m\_vectorBuf[i].setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00359\ \ \ \ \ \}}
\DoxyCodeLine{00360\ \ \ \ \ updateLinksDofOffsets();}
\DoxyCodeLine{00361\ \}}
\DoxyCodeLine{00362\ }
\DoxyCodeLine{00363\ \textcolor{keywordtype}{int}\ btMultiBody::getParent(\textcolor{keywordtype}{int}\ link\_num)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00364\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[link\_num].m\_parent;}
\DoxyCodeLine{00366\ \}}
\DoxyCodeLine{00367\ }
\DoxyCodeLine{00368\ btScalar\ btMultiBody::getLinkMass(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00369\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00370\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_mass;}
\DoxyCodeLine{00371\ \}}
\DoxyCodeLine{00372\ }
\DoxyCodeLine{00373\ \textcolor{keyword}{const}\ btVector3\ \&btMultiBody::getLinkInertia(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00374\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00375\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_inertiaLocal;}
\DoxyCodeLine{00376\ \}}
\DoxyCodeLine{00377\ }
\DoxyCodeLine{00378\ btScalar\ btMultiBody::getJointPos(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00379\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00380\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_jointPos[0];}
\DoxyCodeLine{00381\ \}}
\DoxyCodeLine{00382\ }
\DoxyCodeLine{00383\ btScalar\ btMultiBody::getJointVel(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00384\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00385\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_realBuf[6\ +\ m\_links[i].m\_dofOffset];}
\DoxyCodeLine{00386\ \}}
\DoxyCodeLine{00387\ }
\DoxyCodeLine{00388\ btScalar\ *btMultiBody::getJointPosMultiDof(\textcolor{keywordtype}{int}\ i)}
\DoxyCodeLine{00389\ \{}
\DoxyCodeLine{00390\ \ \ \ \ \textcolor{keywordflow}{return}\ \&m\_links[i].m\_jointPos[0];}
\DoxyCodeLine{00391\ \}}
\DoxyCodeLine{00392\ }
\DoxyCodeLine{00393\ btScalar\ *btMultiBody::getJointVelMultiDof(\textcolor{keywordtype}{int}\ i)}
\DoxyCodeLine{00394\ \{}
\DoxyCodeLine{00395\ \ \ \ \ \textcolor{keywordflow}{return}\ \&m\_realBuf[6\ +\ m\_links[i].m\_dofOffset];}
\DoxyCodeLine{00396\ \}}
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00398\ \textcolor{keyword}{const}\ btScalar\ *btMultiBody::getJointPosMultiDof(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00399\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00400\ \ \ \ \ \textcolor{keywordflow}{return}\ \&m\_links[i].m\_jointPos[0];}
\DoxyCodeLine{00401\ \}}
\DoxyCodeLine{00402\ }
\DoxyCodeLine{00403\ \textcolor{keyword}{const}\ btScalar\ *btMultiBody::getJointVelMultiDof(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00404\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00405\ \ \ \ \ \textcolor{keywordflow}{return}\ \&m\_realBuf[6\ +\ m\_links[i].m\_dofOffset];}
\DoxyCodeLine{00406\ \}}
\DoxyCodeLine{00407\ }
\DoxyCodeLine{00408\ \textcolor{keywordtype}{void}\ btMultiBody::setJointPos(\textcolor{keywordtype}{int}\ i,\ btScalar\ q)}
\DoxyCodeLine{00409\ \{}
\DoxyCodeLine{00410\ \ \ \ \ m\_links[i].m\_jointPos[0]\ =\ q;}
\DoxyCodeLine{00411\ \ \ \ \ m\_links[i].updateCacheMultiDof();}
\DoxyCodeLine{00412\ \}}
\DoxyCodeLine{00413\ }
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \textcolor{keywordtype}{void}\ btMultiBody::setJointPosMultiDof(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{double}\ *q)}
\DoxyCodeLine{00416\ \{}
\DoxyCodeLine{00417\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ pos\ =\ 0;\ pos\ <\ m\_links[i].m\_posVarCount;\ ++pos)}
\DoxyCodeLine{00418\ \ \ \ \ \ \ \ \ m\_links[i].m\_jointPos[pos]\ =\ (btScalar)q[pos];}
\DoxyCodeLine{00419\ }
\DoxyCodeLine{00420\ \ \ \ \ m\_links[i].updateCacheMultiDof();}
\DoxyCodeLine{00421\ \}}
\DoxyCodeLine{00422\ }
\DoxyCodeLine{00423\ \textcolor{keywordtype}{void}\ btMultiBody::setJointPosMultiDof(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{float}\ *q)}
\DoxyCodeLine{00424\ \{}
\DoxyCodeLine{00425\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ pos\ =\ 0;\ pos\ <\ m\_links[i].m\_posVarCount;\ ++pos)}
\DoxyCodeLine{00426\ \ \ \ \ \ \ \ \ m\_links[i].m\_jointPos[pos]\ =\ (btScalar)q[pos];}
\DoxyCodeLine{00427\ }
\DoxyCodeLine{00428\ \ \ \ \ m\_links[i].updateCacheMultiDof();}
\DoxyCodeLine{00429\ \}}
\DoxyCodeLine{00430\ }
\DoxyCodeLine{00431\ }
\DoxyCodeLine{00432\ }
\DoxyCodeLine{00433\ \textcolor{keywordtype}{void}\ btMultiBody::setJointVel(\textcolor{keywordtype}{int}\ i,\ btScalar\ qdot)}
\DoxyCodeLine{00434\ \{}
\DoxyCodeLine{00435\ \ \ \ \ m\_realBuf[6\ +\ m\_links[i].m\_dofOffset]\ =\ qdot;}
\DoxyCodeLine{00436\ \}}
\DoxyCodeLine{00437\ }
\DoxyCodeLine{00438\ \textcolor{keywordtype}{void}\ btMultiBody::setJointVelMultiDof(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{double}\ *qdot)}
\DoxyCodeLine{00439\ \{}
\DoxyCodeLine{00440\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{00441\ \ \ \ \ \ \ \ \ m\_realBuf[6\ +\ m\_links[i].m\_dofOffset\ +\ dof]\ =\ (btScalar)qdot[dof];}
\DoxyCodeLine{00442\ \}}
\DoxyCodeLine{00443\ }
\DoxyCodeLine{00444\ \textcolor{keywordtype}{void}\ btMultiBody::setJointVelMultiDof(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{float}*\ qdot)}
\DoxyCodeLine{00445\ \{}
\DoxyCodeLine{00446\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{00447\ \ \ \ \ \ \ \ \ m\_realBuf[6\ +\ m\_links[i].m\_dofOffset\ +\ dof]\ =\ (btScalar)qdot[dof];}
\DoxyCodeLine{00448\ \}}
\DoxyCodeLine{00449\ }
\DoxyCodeLine{00450\ \textcolor{keyword}{const}\ btVector3\ \&btMultiBody::getRVector(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00451\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00452\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_cachedRVector;}
\DoxyCodeLine{00453\ \}}
\DoxyCodeLine{00454\ }
\DoxyCodeLine{00455\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&btMultiBody::getParentToLocalRot(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00456\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00457\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_cachedRotParentToThis;}
\DoxyCodeLine{00458\ \}}
\DoxyCodeLine{00459\ }
\DoxyCodeLine{00460\ \textcolor{keyword}{const}\ btVector3\ \&btMultiBody::getInterpolateRVector(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00461\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00462\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_cachedRVector\_interpolate;}
\DoxyCodeLine{00463\ \}}
\DoxyCodeLine{00464\ }
\DoxyCodeLine{00465\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&btMultiBody::getInterpolateParentToLocalRot(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00466\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00467\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_cachedRotParentToThis\_interpolate;}
\DoxyCodeLine{00468\ \}}
\DoxyCodeLine{00469\ }
\DoxyCodeLine{00470\ btVector3\ btMultiBody::localPosToWorld(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btVector3\ \&local\_pos)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00471\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00472\ \ \ \ \ btAssert(i\ >=\ -\/1);}
\DoxyCodeLine{00473\ \ \ \ \ btAssert(i\ <\ m\_links.size());}
\DoxyCodeLine{00474\ \ \ \ \ \textcolor{keywordflow}{if}\ ((i\ <\ -\/1)\ ||\ (i\ >=\ m\_links.size()))}
\DoxyCodeLine{00475\ \ \ \ \ \{}
\DoxyCodeLine{00476\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ btVector3(SIMD\_INFINITY,\ SIMD\_INFINITY,\ SIMD\_INFINITY);}
\DoxyCodeLine{00477\ \ \ \ \ \}}
\DoxyCodeLine{00478\ }
\DoxyCodeLine{00479\ \ \ \ \ btVector3\ result\ =\ local\_pos;}
\DoxyCodeLine{00480\ \ \ \ \ \textcolor{keywordflow}{while}\ (i\ !=\ -\/1)}
\DoxyCodeLine{00481\ \ \ \ \ \{}
\DoxyCodeLine{00482\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 'result'\ is\ in\ frame\ i.\ transform\ it\ to\ frame\ parent(i)}}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \ \ result\ +=\ getRVector(i);}
\DoxyCodeLine{00484\ \ \ \ \ \ \ \ \ result\ =\ quatRotate(getParentToLocalRot(i).inverse(),\ result);}
\DoxyCodeLine{00485\ \ \ \ \ \ \ \ \ i\ =\ getParent(i);}
\DoxyCodeLine{00486\ \ \ \ \ \}}
\DoxyCodeLine{00487\ }
\DoxyCodeLine{00488\ \ \ \ \ \textcolor{comment}{//\ 'result'\ is\ now\ in\ the\ base\ frame.\ transform\ it\ to\ world\ frame}}
\DoxyCodeLine{00489\ \ \ \ \ result\ =\ quatRotate(getWorldToBaseRot().inverse(),\ result);}
\DoxyCodeLine{00490\ \ \ \ \ result\ +=\ getBasePos();}
\DoxyCodeLine{00491\ }
\DoxyCodeLine{00492\ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00493\ \}}
\DoxyCodeLine{00494\ }
\DoxyCodeLine{00495\ btVector3\ btMultiBody::worldPosToLocal(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btVector3\ \&world\_pos)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00496\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00497\ \ \ \ \ btAssert(i\ >=\ -\/1);}
\DoxyCodeLine{00498\ \ \ \ \ btAssert(i\ <\ m\_links.size());}
\DoxyCodeLine{00499\ \ \ \ \ \textcolor{keywordflow}{if}\ ((i\ <\ -\/1)\ ||\ (i\ >=\ m\_links.size()))}
\DoxyCodeLine{00500\ \ \ \ \ \{}
\DoxyCodeLine{00501\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ btVector3(SIMD\_INFINITY,\ SIMD\_INFINITY,\ SIMD\_INFINITY);}
\DoxyCodeLine{00502\ \ \ \ \ \}}
\DoxyCodeLine{00503\ }
\DoxyCodeLine{00504\ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ -\/1)}
\DoxyCodeLine{00505\ \ \ \ \ \{}
\DoxyCodeLine{00506\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ world\ to\ base}}
\DoxyCodeLine{00507\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ quatRotate(getWorldToBaseRot(),\ (world\_pos\ -\/\ getBasePos()));}
\DoxyCodeLine{00508\ \ \ \ \ \}}
\DoxyCodeLine{00509\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00510\ \ \ \ \ \{}
\DoxyCodeLine{00511\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ find\ position\ in\ parent\ frame,\ then\ transform\ to\ current\ frame}}
\DoxyCodeLine{00512\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ quatRotate(getParentToLocalRot(i),\ worldPosToLocal(getParent(i),\ world\_pos))\ -\/\ getRVector(i);}
\DoxyCodeLine{00513\ \ \ \ \ \}}
\DoxyCodeLine{00514\ \}}
\DoxyCodeLine{00515\ }
\DoxyCodeLine{00516\ btVector3\ btMultiBody::localDirToWorld(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btVector3\ \&local\_dir)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00517\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00518\ \ \ \ \ btAssert(i\ >=\ -\/1);}
\DoxyCodeLine{00519\ \ \ \ \ btAssert(i\ <\ m\_links.size());}
\DoxyCodeLine{00520\ \ \ \ \ \textcolor{keywordflow}{if}\ ((i\ <\ -\/1)\ ||\ (i\ >=\ m\_links.size()))}
\DoxyCodeLine{00521\ \ \ \ \ \{}
\DoxyCodeLine{00522\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ btVector3(SIMD\_INFINITY,\ SIMD\_INFINITY,\ SIMD\_INFINITY);}
\DoxyCodeLine{00523\ \ \ \ \ \}}
\DoxyCodeLine{00524\ }
\DoxyCodeLine{00525\ \ \ \ \ btVector3\ result\ =\ local\_dir;}
\DoxyCodeLine{00526\ \ \ \ \ \textcolor{keywordflow}{while}\ (i\ !=\ -\/1)}
\DoxyCodeLine{00527\ \ \ \ \ \{}
\DoxyCodeLine{00528\ \ \ \ \ \ \ \ \ result\ =\ quatRotate(getParentToLocalRot(i).inverse(),\ result);}
\DoxyCodeLine{00529\ \ \ \ \ \ \ \ \ i\ =\ getParent(i);}
\DoxyCodeLine{00530\ \ \ \ \ \}}
\DoxyCodeLine{00531\ \ \ \ \ result\ =\ quatRotate(getWorldToBaseRot().inverse(),\ result);}
\DoxyCodeLine{00532\ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00533\ \}}
\DoxyCodeLine{00534\ }
\DoxyCodeLine{00535\ btVector3\ btMultiBody::worldDirToLocal(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btVector3\ \&world\_dir)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00536\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00537\ \ \ \ \ btAssert(i\ >=\ -\/1);}
\DoxyCodeLine{00538\ \ \ \ \ btAssert(i\ <\ m\_links.size());}
\DoxyCodeLine{00539\ \ \ \ \ \textcolor{keywordflow}{if}\ ((i\ <\ -\/1)\ ||\ (i\ >=\ m\_links.size()))}
\DoxyCodeLine{00540\ \ \ \ \ \{}
\DoxyCodeLine{00541\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ btVector3(SIMD\_INFINITY,\ SIMD\_INFINITY,\ SIMD\_INFINITY);}
\DoxyCodeLine{00542\ \ \ \ \ \}}
\DoxyCodeLine{00543\ }
\DoxyCodeLine{00544\ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ -\/1)}
\DoxyCodeLine{00545\ \ \ \ \ \{}
\DoxyCodeLine{00546\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ quatRotate(getWorldToBaseRot(),\ world\_dir);}
\DoxyCodeLine{00547\ \ \ \ \ \}}
\DoxyCodeLine{00548\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00549\ \ \ \ \ \{}
\DoxyCodeLine{00550\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ quatRotate(getParentToLocalRot(i),\ worldDirToLocal(getParent(i),\ world\_dir));}
\DoxyCodeLine{00551\ \ \ \ \ \}}
\DoxyCodeLine{00552\ \}}
\DoxyCodeLine{00553\ }
\DoxyCodeLine{00554\ btMatrix3x3\ btMultiBody::localFrameToWorld(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btMatrix3x3\ \&local\_frame)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00555\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00556\ \ \ \ \ btMatrix3x3\ result\ =\ local\_frame;}
\DoxyCodeLine{00557\ \ \ \ \ btVector3\ frameInWorld0\ =\ localDirToWorld(i,\ local\_frame.getColumn(0));}
\DoxyCodeLine{00558\ \ \ \ \ btVector3\ frameInWorld1\ =\ localDirToWorld(i,\ local\_frame.getColumn(1));}
\DoxyCodeLine{00559\ \ \ \ \ btVector3\ frameInWorld2\ =\ localDirToWorld(i,\ local\_frame.getColumn(2));}
\DoxyCodeLine{00560\ \ \ \ \ result.setValue(frameInWorld0[0],\ frameInWorld1[0],\ frameInWorld2[0],\ frameInWorld0[1],\ frameInWorld1[1],\ frameInWorld2[1],\ frameInWorld0[2],\ frameInWorld1[2],\ frameInWorld2[2]);}
\DoxyCodeLine{00561\ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00562\ \}}
\DoxyCodeLine{00563\ }
\DoxyCodeLine{00564\ \textcolor{keywordtype}{void}\ btMultiBody::compTreeLinkVelocities(btVector3\ *omega,\ btVector3\ *vel)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00565\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00566\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{00567\ \ \ \ \ \textcolor{comment}{//\ Calculates\ the\ velocities\ of\ each\ link\ (and\ the\ base)\ in\ its\ local\ frame}}
\DoxyCodeLine{00568\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\&\ base\_rot\ =\ getWorldToBaseRot();}
\DoxyCodeLine{00569\ \ \ \ \ omega[0]\ =\ quatRotate(base\_rot,\ getBaseOmega());}
\DoxyCodeLine{00570\ \ \ \ \ vel[0]\ =\ quatRotate(base\_rot,\ getBaseVel());}
\DoxyCodeLine{00571\ }
\DoxyCodeLine{00572\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{00573\ \ \ \ \ \{}
\DoxyCodeLine{00574\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_multibody_link}{btMultibodyLink}}\&\ link\ =\ getLink(i);}
\DoxyCodeLine{00575\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ link.m\_parent;}
\DoxyCodeLine{00576\ }
\DoxyCodeLine{00577\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ transform\ parent\ vel\ into\ this\ frame,\ store\ in\ omega[i+1],\ vel[i+1]}}
\DoxyCodeLine{00578\ \ \ \ \ \ \ \ \ spatialTransform(btMatrix3x3(link.m\_cachedRotParentToThis),\ link.m\_cachedRVector,}
\DoxyCodeLine{00579\ \ \ \ \ \ \ \ \ \ \ \ \ omega[parent\ +\ 1],\ vel[parent\ +\ 1],}
\DoxyCodeLine{00580\ \ \ \ \ \ \ \ \ \ \ \ \ omega[i\ +\ 1],\ vel[i\ +\ 1]);}
\DoxyCodeLine{00581\ }
\DoxyCodeLine{00582\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ now\ add\ qidot\ *\ shat\_i}}
\DoxyCodeLine{00583\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btScalar*\ jointVel\ =\ getJointVelMultiDof(i);}
\DoxyCodeLine{00584\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ link.m\_dofCount;\ ++dof)}
\DoxyCodeLine{00585\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00586\ \ \ \ \ \ \ \ \ \ \ \ \ omega[i\ +\ 1]\ +=\ jointVel[dof]\ *\ link.getAxisTop(dof);}
\DoxyCodeLine{00587\ \ \ \ \ \ \ \ \ \ \ \ \ vel[i\ +\ 1]\ +=\ jointVel[dof]\ *\ link.getAxisBottom(dof);}
\DoxyCodeLine{00588\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00589\ \ \ \ \ \}}
\DoxyCodeLine{00590\ \}}
\DoxyCodeLine{00591\ }
\DoxyCodeLine{00592\ }
\DoxyCodeLine{00593\ \textcolor{keywordtype}{void}\ btMultiBody::clearConstraintForces()}
\DoxyCodeLine{00594\ \{}
\DoxyCodeLine{00595\ \ \ \ \ m\_baseConstraintForce.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00596\ \ \ \ \ m\_baseConstraintTorque.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00597\ }
\DoxyCodeLine{00598\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ getNumLinks();\ ++i)}
\DoxyCodeLine{00599\ \ \ \ \ \{}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \ \ m\_links[i].m\_appliedConstraintForce.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \ \ m\_links[i].m\_appliedConstraintTorque.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00602\ \ \ \ \ \}}
\DoxyCodeLine{00603\ \}}
\DoxyCodeLine{00604\ \textcolor{keywordtype}{void}\ btMultiBody::clearForcesAndTorques()}
\DoxyCodeLine{00605\ \{}
\DoxyCodeLine{00606\ \ \ \ \ m\_baseForce.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00607\ \ \ \ \ m\_baseTorque.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00608\ }
\DoxyCodeLine{00609\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ getNumLinks();\ ++i)}
\DoxyCodeLine{00610\ \ \ \ \ \{}
\DoxyCodeLine{00611\ \ \ \ \ \ \ \ \ m\_links[i].m\_appliedForce.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00612\ \ \ \ \ \ \ \ \ m\_links[i].m\_appliedTorque.setValue(0,\ 0,\ 0);}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \ \ m\_links[i].m\_jointTorque[0]\ =\ m\_links[i].m\_jointTorque[1]\ =\ m\_links[i].m\_jointTorque[2]\ =\ m\_links[i].m\_jointTorque[3]\ =\ m\_links[i].m\_jointTorque[4]\ =\ m\_links[i].m\_jointTorque[5]\ =\ 0.f;}
\DoxyCodeLine{00614\ \ \ \ \ \}}
\DoxyCodeLine{00615\ \}}
\DoxyCodeLine{00616\ }
\DoxyCodeLine{00617\ \textcolor{keywordtype}{void}\ btMultiBody::clearVelocities()}
\DoxyCodeLine{00618\ \{}
\DoxyCodeLine{00619\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 6\ +\ getNumDofs();\ ++i)}
\DoxyCodeLine{00620\ \ \ \ \ \{}
\DoxyCodeLine{00621\ \ \ \ \ \ \ \ \ m\_realBuf[i]\ =\ 0.f;}
\DoxyCodeLine{00622\ \ \ \ \ \}}
\DoxyCodeLine{00623\ \}}
\DoxyCodeLine{00624\ \textcolor{keywordtype}{void}\ btMultiBody::addLinkForce(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btVector3\ \&f)}
\DoxyCodeLine{00625\ \{}
\DoxyCodeLine{00626\ \ \ \ \ m\_links[i].m\_appliedForce\ +=\ f;}
\DoxyCodeLine{00627\ \}}
\DoxyCodeLine{00628\ }
\DoxyCodeLine{00629\ \textcolor{keywordtype}{void}\ btMultiBody::addLinkTorque(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btVector3\ \&t)}
\DoxyCodeLine{00630\ \{}
\DoxyCodeLine{00631\ \ \ \ \ m\_links[i].m\_appliedTorque\ +=\ t;}
\DoxyCodeLine{00632\ \}}
\DoxyCodeLine{00633\ }
\DoxyCodeLine{00634\ \textcolor{keywordtype}{void}\ btMultiBody::addLinkConstraintForce(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btVector3\ \&f)}
\DoxyCodeLine{00635\ \{}
\DoxyCodeLine{00636\ \ \ \ \ m\_links[i].m\_appliedConstraintForce\ +=\ f;}
\DoxyCodeLine{00637\ \}}
\DoxyCodeLine{00638\ }
\DoxyCodeLine{00639\ \textcolor{keywordtype}{void}\ btMultiBody::addLinkConstraintTorque(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btVector3\ \&t)}
\DoxyCodeLine{00640\ \{}
\DoxyCodeLine{00641\ \ \ \ \ m\_links[i].m\_appliedConstraintTorque\ +=\ t;}
\DoxyCodeLine{00642\ \}}
\DoxyCodeLine{00643\ }
\DoxyCodeLine{00644\ \textcolor{keywordtype}{void}\ btMultiBody::addJointTorque(\textcolor{keywordtype}{int}\ i,\ btScalar\ Q)}
\DoxyCodeLine{00645\ \{}
\DoxyCodeLine{00646\ \ \ \ \ m\_links[i].m\_jointTorque[0]\ +=\ Q;}
\DoxyCodeLine{00647\ \}}
\DoxyCodeLine{00648\ }
\DoxyCodeLine{00649\ \textcolor{keywordtype}{void}\ btMultiBody::addJointTorqueMultiDof(\textcolor{keywordtype}{int}\ i,\ \textcolor{keywordtype}{int}\ dof,\ btScalar\ Q)}
\DoxyCodeLine{00650\ \{}
\DoxyCodeLine{00651\ \ \ \ \ m\_links[i].m\_jointTorque[dof]\ +=\ Q;}
\DoxyCodeLine{00652\ \}}
\DoxyCodeLine{00653\ }
\DoxyCodeLine{00654\ \textcolor{keywordtype}{void}\ btMultiBody::addJointTorqueMultiDof(\textcolor{keywordtype}{int}\ i,\ \textcolor{keyword}{const}\ btScalar\ *Q)}
\DoxyCodeLine{00655\ \{}
\DoxyCodeLine{00656\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{00657\ \ \ \ \ \ \ \ \ m\_links[i].m\_jointTorque[dof]\ =\ Q[dof];}
\DoxyCodeLine{00658\ \}}
\DoxyCodeLine{00659\ }
\DoxyCodeLine{00660\ \textcolor{keyword}{const}\ btVector3\ \&btMultiBody::getLinkForce(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00661\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00662\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_appliedForce;}
\DoxyCodeLine{00663\ \}}
\DoxyCodeLine{00664\ }
\DoxyCodeLine{00665\ \textcolor{keyword}{const}\ btVector3\ \&btMultiBody::getLinkTorque(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00666\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00667\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_appliedTorque;}
\DoxyCodeLine{00668\ \}}
\DoxyCodeLine{00669\ }
\DoxyCodeLine{00670\ btScalar\ btMultiBody::getJointTorque(\textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{00671\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00672\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_jointTorque[0];}
\DoxyCodeLine{00673\ \}}
\DoxyCodeLine{00674\ }
\DoxyCodeLine{00675\ btScalar\ *btMultiBody::getJointTorqueMultiDof(\textcolor{keywordtype}{int}\ i)}
\DoxyCodeLine{00676\ \{}
\DoxyCodeLine{00677\ \ \ \ \ \textcolor{keywordflow}{return}\ \&m\_links[i].m\_jointTorque[0];}
\DoxyCodeLine{00678\ \}}
\DoxyCodeLine{00679\ }
\DoxyCodeLine{00680\ \textcolor{keywordtype}{bool}\ btMultiBody::hasFixedBase()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00681\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00682\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_fixedBase\ ||\ (getBaseCollider()\ \&\&\ getBaseCollider()-\/>isStaticObject());}
\DoxyCodeLine{00683\ \}}
\DoxyCodeLine{00684\ }
\DoxyCodeLine{00685\ \textcolor{keywordtype}{bool}\ btMultiBody::isBaseStaticOrKinematic()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00686\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00687\ \ \ \ \ \textcolor{keywordflow}{return}\ m\_fixedBase\ ||\ (getBaseCollider()\ \&\&\ getBaseCollider()-\/>isStaticOrKinematicObject());}
\DoxyCodeLine{00688\ \}}
\DoxyCodeLine{00689\ }
\DoxyCodeLine{00690\ \textcolor{keywordtype}{bool}\ btMultiBody::isBaseKinematic()\textcolor{keyword}{\ const}}
\DoxyCodeLine{00691\ \textcolor{keyword}{}\{}
\DoxyCodeLine{00692\ \ \ \ \ \textcolor{keywordflow}{return}\ getBaseCollider()\ \&\&\ getBaseCollider()-\/>isKinematicObject();}
\DoxyCodeLine{00693\ \}}
\DoxyCodeLine{00694\ }
\DoxyCodeLine{00695\ \textcolor{keywordtype}{void}\ btMultiBody::setBaseDynamicType(\textcolor{keywordtype}{int}\ dynamicType)}
\DoxyCodeLine{00696\ \{}
\DoxyCodeLine{00697\ \ \ \ \ \textcolor{keywordflow}{if}(getBaseCollider())\ \{}
\DoxyCodeLine{00698\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ oldFlags\ =\ getBaseCollider()-\/>getCollisionFlags();}
\DoxyCodeLine{00699\ \ \ \ \ \ \ \ \ oldFlags\ \&=\ \string~(btCollisionObject::CF\_STATIC\_OBJECT\ |\ btCollisionObject::CF\_KINEMATIC\_OBJECT);}
\DoxyCodeLine{00700\ \ \ \ \ \ \ \ \ getBaseCollider()-\/>setCollisionFlags(oldFlags\ |\ dynamicType);}
\DoxyCodeLine{00701\ \ \ \ \ \}}
\DoxyCodeLine{00702\ \}}
\DoxyCodeLine{00703\ }
\DoxyCodeLine{00704\ \textcolor{keyword}{inline}\ btMatrix3x3\ outerProduct(\textcolor{keyword}{const}\ btVector3\ \&v0,\ \textcolor{keyword}{const}\ btVector3\ \&v1)\ \ \textcolor{comment}{//renamed\ it\ from\ vecMulVecTranspose\ (http://en.wikipedia.org/wiki/Outer\_product);\ maybe\ it\ should\ be\ moved\ to\ btVector3\ like\ dot\ and\ cross?}}
\DoxyCodeLine{00705\ \{}
\DoxyCodeLine{00706\ \ \ \ \ btVector3\ row0\ =\ btVector3(}
\DoxyCodeLine{00707\ \ \ \ \ \ \ \ \ v0.x()\ *\ v1.x(),}
\DoxyCodeLine{00708\ \ \ \ \ \ \ \ \ v0.x()\ *\ v1.y(),}
\DoxyCodeLine{00709\ \ \ \ \ \ \ \ \ v0.x()\ *\ v1.z());}
\DoxyCodeLine{00710\ \ \ \ \ btVector3\ row1\ =\ btVector3(}
\DoxyCodeLine{00711\ \ \ \ \ \ \ \ \ v0.y()\ *\ v1.x(),}
\DoxyCodeLine{00712\ \ \ \ \ \ \ \ \ v0.y()\ *\ v1.y(),}
\DoxyCodeLine{00713\ \ \ \ \ \ \ \ \ v0.y()\ *\ v1.z());}
\DoxyCodeLine{00714\ \ \ \ \ btVector3\ row2\ =\ btVector3(}
\DoxyCodeLine{00715\ \ \ \ \ \ \ \ \ v0.z()\ *\ v1.x(),}
\DoxyCodeLine{00716\ \ \ \ \ \ \ \ \ v0.z()\ *\ v1.y(),}
\DoxyCodeLine{00717\ \ \ \ \ \ \ \ \ v0.z()\ *\ v1.z());}
\DoxyCodeLine{00718\ }
\DoxyCodeLine{00719\ \ \ \ \ btMatrix3x3\ m(row0[0],\ row0[1],\ row0[2],}
\DoxyCodeLine{00720\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ row1[0],\ row1[1],\ row1[2],}
\DoxyCodeLine{00721\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ row2[0],\ row2[1],\ row2[2]);}
\DoxyCodeLine{00722\ \ \ \ \ \textcolor{keywordflow}{return}\ m;}
\DoxyCodeLine{00723\ \}}
\DoxyCodeLine{00724\ }
\DoxyCodeLine{00725\ \textcolor{preprocessor}{\#define\ vecMulVecTranspose(v0,\ v1Transposed)\ outerProduct(v0,\ v1Transposed)}}
\DoxyCodeLine{00726\ \textcolor{comment}{//}}
\DoxyCodeLine{00727\ }
\DoxyCodeLine{00728\ \textcolor{keywordtype}{void}\ btMultiBody::computeAccelerationsArticulatedBodyAlgorithmMultiDof(btScalar\ dt,}
\DoxyCodeLine{00729\ \ \ \ \ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btScalar>}}\ \&scratch\_r,}
\DoxyCodeLine{00730\ \ \ \ \ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btVector3>}}\ \&scratch\_v,}
\DoxyCodeLine{00731\ \ \ \ \ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btMatrix3x3>}}\ \&scratch\_m,}
\DoxyCodeLine{00732\ \ \ \ \ \textcolor{keywordtype}{bool}\ isConstraintPass,}
\DoxyCodeLine{00733\ \ \ \ \ \textcolor{keywordtype}{bool}\ jointFeedbackInWorldSpace,}
\DoxyCodeLine{00734\ \ \ \ \ \textcolor{keywordtype}{bool}\ jointFeedbackInJointFrame)}
\DoxyCodeLine{00735\ \{}
\DoxyCodeLine{00736\ \ \ \ \ \textcolor{comment}{//\ Implement\ Featherstone's\ algorithm\ to\ calculate\ joint\ accelerations\ (q\_double\_dot)}}
\DoxyCodeLine{00737\ \ \ \ \ \textcolor{comment}{//\ and\ the\ base\ linear\ \&\ angular\ accelerations.}}
\DoxyCodeLine{00738\ }
\DoxyCodeLine{00739\ \ \ \ \ \textcolor{comment}{//\ We\ apply\ damping\ forces\ in\ this\ routine\ as\ well\ as\ any\ external\ forces\ specified\ by\ the}}
\DoxyCodeLine{00740\ \ \ \ \ \textcolor{comment}{//\ caller\ (via\ addBaseForce\ etc).}}
\DoxyCodeLine{00741\ }
\DoxyCodeLine{00742\ \ \ \ \ \textcolor{comment}{//\ output\ should\ point\ to\ an\ array\ of\ 6\ +\ num\_links\ reals.}}
\DoxyCodeLine{00743\ \ \ \ \ \textcolor{comment}{//\ Format\ is:\ 3\ angular\ accelerations\ (in\ world\ frame),\ 3\ linear\ accelerations\ (in\ world\ frame),}}
\DoxyCodeLine{00744\ \ \ \ \ \textcolor{comment}{//\ num\_links\ joint\ acceleration\ values.}}
\DoxyCodeLine{00745\ }
\DoxyCodeLine{00746\ \ \ \ \ \textcolor{comment}{//\ We\ added\ support\ for\ multi\ degree\ of\ freedom\ (multi\ dof)\ joints.}}
\DoxyCodeLine{00747\ \ \ \ \ \textcolor{comment}{//\ In\ addition\ we\ also\ can\ compute\ the\ joint\ reaction\ forces.\ This\ is\ performed\ in\ a\ second\ pass,}}
\DoxyCodeLine{00748\ \ \ \ \ \textcolor{comment}{//\ so\ that\ we\ can\ include\ the\ effect\ of\ the\ constraint\ solver\ forces\ (computed\ in\ the\ PGS\ LCP\ solver)}}
\DoxyCodeLine{00749\ }
\DoxyCodeLine{00750\ \ \ \ \ m\_internalNeedsJointFeedback\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00751\ }
\DoxyCodeLine{00752\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{00753\ }
\DoxyCodeLine{00754\ \ \ \ \ \textcolor{keyword}{const}\ btScalar\ DAMPING\_K1\_LINEAR\ =\ m\_linearDamping;}
\DoxyCodeLine{00755\ \ \ \ \ \textcolor{keyword}{const}\ btScalar\ DAMPING\_K2\_LINEAR\ =\ m\_linearDamping;}
\DoxyCodeLine{00756\ }
\DoxyCodeLine{00757\ \ \ \ \ \textcolor{keyword}{const}\ btScalar\ DAMPING\_K1\_ANGULAR\ =\ m\_angularDamping;}
\DoxyCodeLine{00758\ \ \ \ \ \textcolor{keyword}{const}\ btScalar\ DAMPING\_K2\_ANGULAR\ =\ m\_angularDamping;}
\DoxyCodeLine{00759\ }
\DoxyCodeLine{00760\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ base\_vel\ =\ getBaseVel();}
\DoxyCodeLine{00761\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ base\_omega\ =\ getBaseOmega();}
\DoxyCodeLine{00762\ }
\DoxyCodeLine{00763\ \ \ \ \ \textcolor{comment}{//\ Temporary\ matrices/vectors\ -\/-\/\ use\ scratch\ space\ from\ caller}}
\DoxyCodeLine{00764\ \ \ \ \ \textcolor{comment}{//\ so\ that\ we\ don't\ have\ to\ keep\ reallocating\ every\ frame}}
\DoxyCodeLine{00765\ }
\DoxyCodeLine{00766\ \ \ \ \ scratch\_r.resize(2\ *\ m\_dofCount\ +\ 7);\ \ \textcolor{comment}{//multidof?\ ("{}Y"{}s\ use\ it\ and\ it\ is\ used\ to\ store\ qdd)\ =>\ 2\ x\ m\_dofCount}}
\DoxyCodeLine{00767\ \ \ \ \ scratch\_v.resize(8\ *\ num\_links\ +\ 6);}
\DoxyCodeLine{00768\ \ \ \ \ scratch\_m.resize(4\ *\ num\_links\ +\ 4);}
\DoxyCodeLine{00769\ }
\DoxyCodeLine{00770\ \ \ \ \ \textcolor{comment}{//btScalar\ *\ r\_ptr\ =\ \&scratch\_r[0];}}
\DoxyCodeLine{00771\ \ \ \ \ btScalar\ *output\ =\ \&scratch\_r[m\_dofCount];\ \ \textcolor{comment}{//\ "{}output"{}\ holds\ the\ q\_double\_dot\ results}}
\DoxyCodeLine{00772\ \ \ \ \ btVector3\ *v\_ptr\ =\ \&scratch\_v[0];}
\DoxyCodeLine{00773\ }
\DoxyCodeLine{00774\ \ \ \ \ \textcolor{comment}{//\ vhat\_i\ \ (top\ =\ angular,\ bottom\ =\ linear\ part)}}
\DoxyCodeLine{00775\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ *spatVel\ =\ (\mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ *)v\_ptr;}
\DoxyCodeLine{00776\ \ \ \ \ v\_ptr\ +=\ num\_links\ *\ 2\ +\ 2;}
\DoxyCodeLine{00777\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00778\ \ \ \ \ \textcolor{comment}{//\ zhat\_i\string^A}}
\DoxyCodeLine{00779\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ *zeroAccSpatFrc\ =\ (\mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ *)v\_ptr;}
\DoxyCodeLine{00780\ \ \ \ \ v\_ptr\ +=\ num\_links\ *\ 2\ +\ 2;}
\DoxyCodeLine{00781\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00782\ \ \ \ \ \textcolor{comment}{//\ chat\_i\ \ (note\ NOT\ defined\ for\ the\ base)}}
\DoxyCodeLine{00783\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ *spatCoriolisAcc\ =\ (\mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ *)v\_ptr;}
\DoxyCodeLine{00784\ \ \ \ \ v\_ptr\ +=\ num\_links\ *\ 2;}
\DoxyCodeLine{00785\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00786\ \ \ \ \ \textcolor{comment}{//\ Ihat\_i\string^A.}}
\DoxyCodeLine{00787\ \ \ \ \ \mbox{\hyperlink{structbt_symmetric_spatial_dyad}{btSymmetricSpatialDyad}}\ *spatInertia\ =\ (\mbox{\hyperlink{structbt_symmetric_spatial_dyad}{btSymmetricSpatialDyad}}\ *)\&scratch\_m[num\_links\ +\ 1];}
\DoxyCodeLine{00788\ }
\DoxyCodeLine{00789\ \ \ \ \ \textcolor{comment}{//\ Cached\ 3x3\ rotation\ matrices\ from\ parent\ frame\ to\ this\ frame.}}
\DoxyCodeLine{00790\ \ \ \ \ btMatrix3x3\ *rot\_from\_parent\ =\ \&m\_matrixBuf[0];}
\DoxyCodeLine{00791\ \ \ \ \ btMatrix3x3\ *rot\_from\_world\ =\ \&scratch\_m[0];}
\DoxyCodeLine{00792\ }
\DoxyCodeLine{00793\ \ \ \ \ \textcolor{comment}{//\ hhat\_i,\ ahat\_i}}
\DoxyCodeLine{00794\ \ \ \ \ \textcolor{comment}{//\ hhat\ is\ NOT\ stored\ for\ the\ base\ (but\ ahat\ is)}}
\DoxyCodeLine{00795\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ *h\ =\ (\mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ *)(m\_dofCount\ >\ 0\ ?\ \&m\_vectorBuf[0]\ :\ 0);}
\DoxyCodeLine{00796\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ *spatAcc\ =\ (\mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ *)v\_ptr;}
\DoxyCodeLine{00797\ \ \ \ \ v\_ptr\ +=\ num\_links\ *\ 2\ +\ 2;}
\DoxyCodeLine{00798\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00799\ \ \ \ \ \textcolor{comment}{//\ Y\_i,\ invD\_i}}
\DoxyCodeLine{00800\ \ \ \ \ btScalar\ *invD\ =\ m\_dofCount\ >\ 0\ ?\ \&m\_realBuf[6\ +\ m\_dofCount]\ :\ 0;}
\DoxyCodeLine{00801\ \ \ \ \ btScalar\ *Y\ =\ \&scratch\_r[0];}
\DoxyCodeLine{00802\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00803\ \ \ \ \ \textcolor{comment}{//aux\ variables}}
\DoxyCodeLine{00804\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ spatJointVel;\ \ \ \ \ \ \ \ \ \textcolor{comment}{//spatial\ velocity\ due\ to\ the\ joint\ motion\ (i.e.\ without\ predecessors'\ influence)}}
\DoxyCodeLine{00805\ \ \ \ \ btScalar\ D[36];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//"{}D"{}\ matrix;\ it's\ dofxdof\ for\ each\ body\ so\ asingle\ 6x6\ D\ matrix\ will\ do}}
\DoxyCodeLine{00806\ \ \ \ \ btScalar\ invD\_times\_Y[6];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//D\string^\{-\/1\}\ *\ Y\ [dofxdof\ x\ dofx1\ =\ dofx1]\ <=>\ D\string^\{-\/1\}\ *\ u;\ better\ moved\ to\ buffers\ since\ it\ is\ recalced\ in\ calcAccelerationDeltasMultiDof;\ num\_dof\ of\ btScalar\ would\ cover\ all\ bodies}}
\DoxyCodeLine{00807\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ result;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//holds\ results\ of\ the\ SolveImatrix\ op;\ it\ is\ a\ spatial\ motion\ vector\ (accel)}}
\DoxyCodeLine{00808\ \ \ \ \ btScalar\ Y\_minus\_hT\_a[6];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//Y\ -\/\ h\string^\{T\}\ *\ a;\ it's\ dofx1\ for\ each\ body\ so\ a\ single\ 6x1\ temp\ is\ enough}}
\DoxyCodeLine{00809\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ spatForceVecTemps[6];\ \ \textcolor{comment}{//6\ temporary\ spatial\ force\ vectors}}
\DoxyCodeLine{00810\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_transformation_matrix}{btSpatialTransformationMatrix}}\ fromParent;\ \ \ \textcolor{comment}{//spatial\ transform\ from\ parent\ to\ child}}
\DoxyCodeLine{00811\ \ \ \ \ \mbox{\hyperlink{structbt_symmetric_spatial_dyad}{btSymmetricSpatialDyad}}\ dyadTemp;\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//inertia\ matrix\ temp}}
\DoxyCodeLine{00812\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_transformation_matrix}{btSpatialTransformationMatrix}}\ fromWorld;}
\DoxyCodeLine{00813\ \ \ \ \ fromWorld.m\_trnVec.setZero();}
\DoxyCodeLine{00815\ }
\DoxyCodeLine{00816\ \ \ \ \ \textcolor{comment}{//\ ptr\ to\ the\ joint\ accel\ part\ of\ the\ output}}
\DoxyCodeLine{00817\ \ \ \ \ btScalar\ *joint\_accel\ =\ output\ +\ 6;}
\DoxyCodeLine{00818\ }
\DoxyCodeLine{00819\ \ \ \ \ \textcolor{comment}{//\ Start\ of\ the\ algorithm\ proper.}}
\DoxyCodeLine{00820\ }
\DoxyCodeLine{00821\ \ \ \ \ \textcolor{comment}{//\ First\ 'upward'\ loop.}}
\DoxyCodeLine{00822\ \ \ \ \ \textcolor{comment}{//\ Combines\ CompTreeLinkVelocities\ and\ InitTreeLinks\ from\ Mirtich.}}
\DoxyCodeLine{00823\ }
\DoxyCodeLine{00824\ \ \ \ \ rot\_from\_parent[0]\ =\ btMatrix3x3(m\_baseQuat);\ \ \textcolor{comment}{//m\_baseQuat\ assumed\ to\ be\ alias!?}}
\DoxyCodeLine{00825\ }
\DoxyCodeLine{00826\ \ \ \ \ \textcolor{comment}{//create\ the\ vector\ of\ spatial\ velocity\ of\ the\ base\ by\ transforming\ global-\/coor\ linear\ and\ angular\ velocities\ into\ base-\/local\ coordinates}}
\DoxyCodeLine{00827\ \ \ \ \ spatVel[0].setVector(rot\_from\_parent[0]\ *\ base\_omega,\ rot\_from\_parent[0]\ *\ base\_vel);}
\DoxyCodeLine{00828\ }
\DoxyCodeLine{00829\ \ \ \ \ \textcolor{keywordflow}{if}\ (isBaseStaticOrKinematic())}
\DoxyCodeLine{00830\ \ \ \ \ \{}
\DoxyCodeLine{00831\ \ \ \ \ \ \ \ \ zeroAccSpatFrc[0].setZero();}
\DoxyCodeLine{00832\ \ \ \ \ \}}
\DoxyCodeLine{00833\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00834\ \ \ \ \ \{}
\DoxyCodeLine{00835\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&baseForce\ =\ isConstraintPass\ ?\ m\_baseConstraintForce\ :\ m\_baseForce;}
\DoxyCodeLine{00836\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&baseTorque\ =\ isConstraintPass\ ?\ m\_baseConstraintTorque\ :\ m\_baseTorque;}
\DoxyCodeLine{00837\ \ \ \ \ \ \ \ \ \textcolor{comment}{//external\ forces}}
\DoxyCodeLine{00838\ \ \ \ \ \ \ \ \ zeroAccSpatFrc[0].setVector(-\/(rot\_from\_parent[0]\ *\ baseTorque),\ -\/(rot\_from\_parent[0]\ *\ baseForce));}
\DoxyCodeLine{00839\ }
\DoxyCodeLine{00840\ \ \ \ \ \ \ \ \ \textcolor{comment}{//adding\ damping\ terms\ (only)}}
\DoxyCodeLine{00841\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btScalar\ linDampMult\ =\ 1.,\ angDampMult\ =\ 1.;}
\DoxyCodeLine{00842\ \ \ \ \ \ \ \ \ zeroAccSpatFrc[0].addVector(angDampMult\ *\ m\_baseInertia\ *\ spatVel[0].getAngular()\ *\ (DAMPING\_K1\_ANGULAR\ +\ DAMPING\_K2\_ANGULAR\ *\ spatVel[0].getAngular().safeNorm()),}
\DoxyCodeLine{00843\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ linDampMult\ *\ m\_baseMass\ *\ spatVel[0].getLinear()\ *\ (DAMPING\_K1\_LINEAR\ +\ DAMPING\_K2\_LINEAR\ *\ spatVel[0].getLinear().safeNorm()));}
\DoxyCodeLine{00844\ }
\DoxyCodeLine{00845\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00846\ \ \ \ \ \ \ \ \ \textcolor{comment}{//p\ +=\ vhat\ x\ Ihat\ vhat\ -\/\ done\ in\ a\ simpler\ way}}
\DoxyCodeLine{00847\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_useGyroTerm)}
\DoxyCodeLine{00848\ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[0].addAngular(spatVel[0].getAngular().cross(m\_baseInertia\ *\ spatVel[0].getAngular()));}
\DoxyCodeLine{00849\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00850\ \ \ \ \ \ \ \ \ zeroAccSpatFrc[0].addLinear(m\_baseMass\ *\ spatVel[0].getAngular().cross(spatVel[0].getLinear()));}
\DoxyCodeLine{00851\ \ \ \ \ \}}
\DoxyCodeLine{00852\ }
\DoxyCodeLine{00853\ \ \ \ \ \textcolor{comment}{//init\ the\ spatial\ AB\ inertia\ (it\ has\ the\ simple\ form\ thanks\ to\ choosing\ local\ body\ frames\ origins\ at\ their\ COMs)}}
\DoxyCodeLine{00854\ \ \ \ \ spatInertia[0].setMatrix(btMatrix3x3(0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0),}
\DoxyCodeLine{00855\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00856\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btMatrix3x3(m\_baseMass,\ 0,\ 0,}
\DoxyCodeLine{00857\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ m\_baseMass,\ 0,}
\DoxyCodeLine{00858\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ 0,\ m\_baseMass),}
\DoxyCodeLine{00859\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00860\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btMatrix3x3(m\_baseInertia[0],\ 0,\ 0,}
\DoxyCodeLine{00861\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ m\_baseInertia[1],\ 0,}
\DoxyCodeLine{00862\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ 0,\ m\_baseInertia[2]));}
\DoxyCodeLine{00863\ }
\DoxyCodeLine{00864\ \ \ \ \ rot\_from\_world[0]\ =\ rot\_from\_parent[0];}
\DoxyCodeLine{00865\ }
\DoxyCodeLine{00866\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00867\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{00868\ \ \ \ \ \{}
\DoxyCodeLine{00869\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ m\_links[i].m\_parent;}
\DoxyCodeLine{00870\ \ \ \ \ \ \ \ \ rot\_from\_parent[i\ +\ 1]\ =\ btMatrix3x3(m\_links[i].m\_cachedRotParentToThis);}
\DoxyCodeLine{00871\ \ \ \ \ \ \ \ \ rot\_from\_world[i\ +\ 1]\ =\ rot\_from\_parent[i\ +\ 1]\ *\ rot\_from\_world[parent\ +\ 1];}
\DoxyCodeLine{00872\ }
\DoxyCodeLine{00873\ \ \ \ \ \ \ \ \ fromParent.m\_rotMat\ =\ rot\_from\_parent[i\ +\ 1];}
\DoxyCodeLine{00874\ \ \ \ \ \ \ \ \ fromParent.m\_trnVec\ =\ m\_links[i].m\_cachedRVector;}
\DoxyCodeLine{00875\ \ \ \ \ \ \ \ \ fromWorld.m\_rotMat\ =\ rot\_from\_world[i\ +\ 1];}
\DoxyCodeLine{00876\ \ \ \ \ \ \ \ \ fromParent.transform(spatVel[parent\ +\ 1],\ spatVel[i\ +\ 1]);}
\DoxyCodeLine{00877\ }
\DoxyCodeLine{00878\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ now\ set\ vhat\_i\ to\ its\ true\ value\ by\ doing}}
\DoxyCodeLine{00879\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ vhat\_i\ +=\ qidot\ *\ shat\_i}}
\DoxyCodeLine{00880\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_useGlobalVelocities)}
\DoxyCodeLine{00881\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00882\ \ \ \ \ \ \ \ \ \ \ \ \ spatJointVel.setZero();}
\DoxyCodeLine{00883\ }
\DoxyCodeLine{00884\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{00885\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ spatJointVel\ +=\ m\_links[i].m\_axes[dof]\ *\ getJointVelMultiDof(i)[dof];}
\DoxyCodeLine{00886\ }
\DoxyCodeLine{00887\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ remember\ vhat\_i\ is\ really\ vhat\_p(i)\ (but\ in\ current\ frame)\ at\ this\ point\ =>\ we\ need\ to\ add\ velocity\ across\ the\ inboard\ joint}}
\DoxyCodeLine{00888\ \ \ \ \ \ \ \ \ \ \ \ \ spatVel[i\ +\ 1]\ +=\ spatJointVel;}
\DoxyCodeLine{00889\ }
\DoxyCodeLine{00890\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00891\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ vhat\_i\ is\ vhat\_p(i)\ transformed\ to\ local\ coors\ +\ the\ velocity\ across\ the\ i-\/th\ inboard\ joint}}
\DoxyCodeLine{00892\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//spatVel[i+1]\ =\ fromParent\ *\ spatVel[parent+1]\ +\ spatJointVel;}}
\DoxyCodeLine{00893\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00894\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00895\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00896\ \ \ \ \ \ \ \ \ \ \ \ \ fromWorld.transformRotationOnly(m\_links[i].m\_absFrameTotVelocity,\ spatVel[i\ +\ 1]);}
\DoxyCodeLine{00897\ \ \ \ \ \ \ \ \ \ \ \ \ fromWorld.transformRotationOnly(m\_links[i].m\_absFrameLocVelocity,\ spatJointVel);}
\DoxyCodeLine{00898\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00899\ }
\DoxyCodeLine{00900\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ we\ can\ now\ calculate\ chat\_i}}
\DoxyCodeLine{00901\ \ \ \ \ \ \ \ \ spatVel[i\ +\ 1].cross(spatJointVel,\ spatCoriolisAcc[i]);}
\DoxyCodeLine{00902\ }
\DoxyCodeLine{00903\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ calculate\ zhat\_i\string^A}}
\DoxyCodeLine{00904\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00905\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isLinkAndAllAncestorsKinematic(i))}
\DoxyCodeLine{00906\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00907\ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i].setZero();}
\DoxyCodeLine{00908\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00909\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{00910\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//external\ forces}}
\DoxyCodeLine{00911\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ linkAppliedForce\ =\ isConstraintPass\ ?\ m\_links[i].m\_appliedConstraintForce\ :\ m\_links[i].m\_appliedForce;}
\DoxyCodeLine{00912\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ linkAppliedTorque\ =\ isConstraintPass\ ?\ m\_links[i].m\_appliedConstraintTorque\ :\ m\_links[i].m\_appliedTorque;}
\DoxyCodeLine{00913\ }
\DoxyCodeLine{00914\ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i\ +\ 1].setVector(-\/(rot\_from\_world[i\ +\ 1]\ *\ linkAppliedTorque),\ -\/(rot\_from\_world[i\ +\ 1]\ *\ linkAppliedForce));}
\DoxyCodeLine{00915\ }
\DoxyCodeLine{00916\ \textcolor{preprocessor}{\#if\ 0\ \ \ }}
\DoxyCodeLine{00917\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00918\ }
\DoxyCodeLine{00919\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ b3Printf(\textcolor{stringliteral}{"{}stepVelocitiesMultiDof\ zeroAccSpatFrc[\%d]\ linear:\%f,\%f,\%f,\ angular:\%f,\%f,\%f"{}},}
\DoxyCodeLine{00920\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ i+1,}
\DoxyCodeLine{00921\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i+1].m\_topVec[0],}
\DoxyCodeLine{00922\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i+1].m\_topVec[1],}
\DoxyCodeLine{00923\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i+1].m\_topVec[2],}
\DoxyCodeLine{00924\ }
\DoxyCodeLine{00925\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i+1].m\_bottomVec[0],}
\DoxyCodeLine{00926\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i+1].m\_bottomVec[1],}
\DoxyCodeLine{00927\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i+1].m\_bottomVec[2]);}
\DoxyCodeLine{00928\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00929\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00930\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00931\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//adding\ damping\ terms\ (only)}}
\DoxyCodeLine{00932\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ linDampMult\ =\ 1.,\ angDampMult\ =\ 1.;}
\DoxyCodeLine{00933\ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i\ +\ 1].addVector(angDampMult\ *\ m\_links[i].m\_inertiaLocal\ *\ spatVel[i\ +\ 1].getAngular()\ *\ (DAMPING\_K1\_ANGULAR\ +\ DAMPING\_K2\_ANGULAR\ *\ spatVel[i\ +\ 1].getAngular().safeNorm()),}
\DoxyCodeLine{00934\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ linDampMult\ *\ m\_links[i].m\_mass\ *\ spatVel[i\ +\ 1].getLinear()\ *\ (DAMPING\_K1\_LINEAR\ +\ DAMPING\_K2\_LINEAR\ *\ spatVel[i\ +\ 1].getLinear().safeNorm()));}
\DoxyCodeLine{00935\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//p\ +=\ vhat\ x\ Ihat\ vhat\ -\/\ done\ in\ a\ simpler\ way}}
\DoxyCodeLine{00936\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_useGyroTerm)}
\DoxyCodeLine{00937\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i\ +\ 1].addAngular(spatVel[i\ +\ 1].getAngular().cross(m\_links[i].m\_inertiaLocal\ *\ spatVel[i\ +\ 1].getAngular()));}
\DoxyCodeLine{00938\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00939\ \ \ \ \ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i\ +\ 1].addLinear(m\_links[i].m\_mass\ *\ spatVel[i\ +\ 1].getAngular().cross(spatVel[i\ +\ 1].getLinear()));}
\DoxyCodeLine{00940\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00941\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//btVector3\ temp\ =\ m\_links[i].m\_mass\ *\ spatVel[i+1].getAngular().cross(spatVel[i+1].getLinear());}}
\DoxyCodeLine{00943\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//btScalar\ parOmegaMod\ =\ temp.length();}}
\DoxyCodeLine{00944\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//btScalar\ parOmegaModMax\ =\ 1000;}}
\DoxyCodeLine{00945\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//if(parOmegaMod\ >\ parOmegaModMax)}}
\DoxyCodeLine{00946\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ temp\ *=\ parOmegaModMax\ /\ parOmegaMod;}}
\DoxyCodeLine{00947\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//zeroAccSpatFrc[i+1].addLinear(temp);}}
\DoxyCodeLine{00948\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}|zeroAccSpatFrc[\%d]|\ =\ \%.4f\(\backslash\)n"{},\ i+1,\ temp.length());}}
\DoxyCodeLine{00949\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//temp\ =\ spatCoriolisAcc[i].getLinear();}}
\DoxyCodeLine{00950\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}|spatCoriolisAcc[\%d]|\ =\ \%.4f\(\backslash\)n"{},\ i+1,\ temp.length());}}
\DoxyCodeLine{00951\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00952\ }
\DoxyCodeLine{00953\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ calculate\ Ihat\_i\string^A}}
\DoxyCodeLine{00954\ \ \ \ \ \ \ \ \ \textcolor{comment}{//init\ the\ spatial\ AB\ inertia\ (it\ has\ the\ simple\ form\ thanks\ to\ choosing\ local\ body\ frames\ origins\ at\ their\ COMs)}}
\DoxyCodeLine{00955\ \ \ \ \ \ \ \ \ spatInertia[i\ +\ 1].setMatrix(btMatrix3x3(0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0,\ 0),}
\DoxyCodeLine{00956\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00957\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btMatrix3x3(m\_links[i].m\_mass,\ 0,\ 0,}
\DoxyCodeLine{00958\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ m\_links[i].m\_mass,\ 0,}
\DoxyCodeLine{00959\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ 0,\ m\_links[i].m\_mass),}
\DoxyCodeLine{00960\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00961\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btMatrix3x3(m\_links[i].m\_inertiaLocal[0],\ 0,\ 0,}
\DoxyCodeLine{00962\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ m\_links[i].m\_inertiaLocal[1],\ 0,}
\DoxyCodeLine{00963\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ 0,\ m\_links[i].m\_inertiaLocal[2]));}
\DoxyCodeLine{00964\ }
\DoxyCodeLine{00965\ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}w[\%d]\ =\ [\%.4f\ \%.4f\ \%.4f]\(\backslash\)n"{},\ i,\ vel\_top\_angular[i+1].x(),\ vel\_top\_angular[i+1].y(),\ vel\_top\_angular[i+1].z());}}
\DoxyCodeLine{00966\ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}v[\%d]\ =\ [\%.4f\ \%.4f\ \%.4f]\(\backslash\)n"{},\ i,\ vel\_bottom\_linear[i+1].x(),\ vel\_bottom\_linear[i+1].y(),\ vel\_bottom\_linear[i+1].z());}}
\DoxyCodeLine{00967\ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}c[\%d]\ =\ [\%.4f\ \%.4f\ \%.4f]\(\backslash\)n"{},\ i,\ coriolis\_bottom\_linear[i].x(),\ coriolis\_bottom\_linear[i].y(),\ coriolis\_bottom\_linear[i].z());}}
\DoxyCodeLine{00968\ \ \ \ \ \}}
\DoxyCodeLine{00969\ }
\DoxyCodeLine{00970\ \ \ \ \ \textcolor{comment}{//\ 'Downward'\ loop.}}
\DoxyCodeLine{00971\ \ \ \ \ \textcolor{comment}{//\ (part\ of\ TreeForwardDynamics\ in\ Mirtich.)}}
\DoxyCodeLine{00972\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ num\_links\ -\/\ 1;\ i\ >=\ 0;\ -\/-\/i)}
\DoxyCodeLine{00973\ \ \ \ \ \{}
\DoxyCodeLine{00974\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(isLinkAndAllAncestorsKinematic(i))}
\DoxyCodeLine{00975\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00976\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ m\_links[i].m\_parent;}
\DoxyCodeLine{00977\ \ \ \ \ \ \ \ \ fromParent.m\_rotMat\ =\ rot\_from\_parent[i\ +\ 1];}
\DoxyCodeLine{00978\ \ \ \ \ \ \ \ \ fromParent.m\_trnVec\ =\ m\_links[i].m\_cachedRVector;}
\DoxyCodeLine{00979\ }
\DoxyCodeLine{00980\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{00981\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00982\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&hDof\ =\ h[m\_links[i].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{00983\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00984\ \ \ \ \ \ \ \ \ \ \ \ \ hDof\ =\ spatInertia[i\ +\ 1]\ *\ m\_links[i].m\_axes[dof];}
\DoxyCodeLine{00985\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{00986\ \ \ \ \ \ \ \ \ \ \ \ \ Y[m\_links[i].m\_dofOffset\ +\ dof]\ =\ m\_links[i].m\_jointTorque[dof]\ -\/\ m\_links[i].m\_axes[dof].dot(zeroAccSpatFrc[i\ +\ 1])\ -\/\ spatCoriolisAcc[i].dot(hDof);}
\DoxyCodeLine{00987\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00988\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{00989\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00990\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ *D\_row\ =\ \&D[dof\ *\ m\_links[i].m\_dofCount];}
\DoxyCodeLine{00991\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof2\ =\ 0;\ dof2\ <\ m\_links[i].m\_dofCount;\ ++dof2)}
\DoxyCodeLine{00992\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{00993\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&hDof2\ =\ h[m\_links[i].m\_dofOffset\ +\ dof2];}
\DoxyCodeLine{00994\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ D\_row[dof2]\ =\ m\_links[i].m\_axes[dof].dot(hDof2);}
\DoxyCodeLine{00995\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00996\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00997\ }
\DoxyCodeLine{00998\ \ \ \ \ \ \ \ \ btScalar\ *invDi\ =\ \&invD[m\_links[i].m\_dofOffset\ *\ m\_links[i].m\_dofOffset];}
\DoxyCodeLine{00999\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (m\_links[i].m\_jointType)}
\DoxyCodeLine{01000\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01001\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePrismatic:}
\DoxyCodeLine{01002\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eRevolute:}
\DoxyCodeLine{01003\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01004\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (D[0]\ >=\ SIMD\_EPSILON)}
\DoxyCodeLine{01005\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01006\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ invDi[0]\ =\ 1.0f\ /\ D[0];}
\DoxyCodeLine{01007\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01008\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01009\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01010\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ invDi[0]\ =\ 0;}
\DoxyCodeLine{01011\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01012\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01013\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01014\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eSpherical:}
\DoxyCodeLine{01015\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePlanar:}
\DoxyCodeLine{01016\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01017\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btMatrix3x3\ D3x3(D[0],\ D[1],\ D[2],\ D[3],\ D[4],\ D[5],\ D[6],\ D[7],\ D[8]);}
\DoxyCodeLine{01018\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btMatrix3x3\ invD3x3(D3x3.inverse());}
\DoxyCodeLine{01019\ }
\DoxyCodeLine{01020\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//unroll\ the\ loop?}}
\DoxyCodeLine{01021\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ row\ =\ 0;\ \mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}}\ <\ 3;\ ++\mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}})}
\DoxyCodeLine{01022\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01023\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ col\ =\ 0;\ col\ <\ 3;\ ++col)}
\DoxyCodeLine{01024\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01025\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ invDi[\mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}}\ *\ 3\ +\ col]\ =\ invD3x3[\mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}}][col];}
\DoxyCodeLine{01026\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01027\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01028\ }
\DoxyCodeLine{01029\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01030\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01031\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01032\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01033\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01034\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01035\ }
\DoxyCodeLine{01036\ \ \ \ \ \ \ \ \ \textcolor{comment}{//determine\ h*D\string^\{-\/1\}}}
\DoxyCodeLine{01037\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01038\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01039\ \ \ \ \ \ \ \ \ \ \ \ \ spatForceVecTemps[dof].setZero();}
\DoxyCodeLine{01040\ }
\DoxyCodeLine{01041\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof2\ =\ 0;\ dof2\ <\ m\_links[i].m\_dofCount;\ ++dof2)}
\DoxyCodeLine{01042\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01043\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&hDof2\ =\ h[m\_links[i].m\_dofOffset\ +\ dof2];}
\DoxyCodeLine{01044\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01045\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ spatForceVecTemps[dof]\ +=\ hDof2\ *\ invDi[dof2\ *\ m\_links[i].m\_dofCount\ +\ dof];}
\DoxyCodeLine{01046\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01047\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01048\ }
\DoxyCodeLine{01049\ \ \ \ \ \ \ \ \ dyadTemp\ =\ spatInertia[i\ +\ 1];}
\DoxyCodeLine{01050\ }
\DoxyCodeLine{01051\ \ \ \ \ \ \ \ \ \textcolor{comment}{//determine\ (h*D\string^\{-\/1\})\ *\ h\string^\{T\}}}
\DoxyCodeLine{01052\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01053\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01054\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&hDof\ =\ h[m\_links[i].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{01055\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01056\ \ \ \ \ \ \ \ \ \ \ \ \ dyadTemp\ -\/=\ symmetricSpatialOuterProduct(hDof,\ spatForceVecTemps[dof]);}
\DoxyCodeLine{01057\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01058\ }
\DoxyCodeLine{01059\ \ \ \ \ \ \ \ \ fromParent.transformInverse(dyadTemp,\ spatInertia[parent\ +\ 1],\ btSpatialTransformationMatrix::Add);}
\DoxyCodeLine{01060\ }
\DoxyCodeLine{01061\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01062\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01063\ \ \ \ \ \ \ \ \ \ \ \ \ invD\_times\_Y[dof]\ =\ 0.f;}
\DoxyCodeLine{01064\ }
\DoxyCodeLine{01065\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof2\ =\ 0;\ dof2\ <\ m\_links[i].m\_dofCount;\ ++dof2)}
\DoxyCodeLine{01066\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01067\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ invD\_times\_Y[dof]\ +=\ invDi[dof\ *\ m\_links[i].m\_dofCount\ +\ dof2]\ *\ Y[m\_links[i].m\_dofOffset\ +\ dof2];}
\DoxyCodeLine{01068\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01069\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01070\ }
\DoxyCodeLine{01071\ \ \ \ \ \ \ \ \ spatForceVecTemps[0]\ =\ zeroAccSpatFrc[i\ +\ 1]\ +\ spatInertia[i\ +\ 1]\ *\ spatCoriolisAcc[i];}
\DoxyCodeLine{01072\ }
\DoxyCodeLine{01073\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01074\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01075\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&hDof\ =\ h[m\_links[i].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{01076\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01077\ \ \ \ \ \ \ \ \ \ \ \ \ spatForceVecTemps[0]\ +=\ hDof\ *\ invD\_times\_Y[dof];}
\DoxyCodeLine{01078\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01079\ }
\DoxyCodeLine{01080\ \ \ \ \ \ \ \ \ fromParent.transformInverse(spatForceVecTemps[0],\ spatForceVecTemps[1]);}
\DoxyCodeLine{01081\ }
\DoxyCodeLine{01082\ \ \ \ \ \ \ \ \ zeroAccSpatFrc[parent\ +\ 1]\ +=\ spatForceVecTemps[1];}
\DoxyCodeLine{01083\ \ \ \ \ \}}
\DoxyCodeLine{01084\ }
\DoxyCodeLine{01085\ \ \ \ \ \textcolor{comment}{//\ Second\ 'upward'\ loop}}
\DoxyCodeLine{01086\ \ \ \ \ \textcolor{comment}{//\ (part\ of\ TreeForwardDynamics\ in\ Mirtich)}}
\DoxyCodeLine{01087\ }
\DoxyCodeLine{01088\ \ \ \ \ \textcolor{keywordflow}{if}\ (isBaseStaticOrKinematic())}
\DoxyCodeLine{01089\ \ \ \ \ \{}
\DoxyCodeLine{01090\ \ \ \ \ \ \ \ \ spatAcc[0].setZero();}
\DoxyCodeLine{01091\ \ \ \ \ \}}
\DoxyCodeLine{01092\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01093\ \ \ \ \ \{}
\DoxyCodeLine{01094\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_links\ >\ 0)}
\DoxyCodeLine{01095\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01096\ \ \ \ \ \ \ \ \ \ \ \ \ m\_cachedInertiaValid\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01097\ \ \ \ \ \ \ \ \ \ \ \ \ m\_cachedInertiaTopLeft\ =\ spatInertia[0].m\_topLeftMat;}
\DoxyCodeLine{01098\ \ \ \ \ \ \ \ \ \ \ \ \ m\_cachedInertiaTopRight\ =\ spatInertia[0].m\_topRightMat;}
\DoxyCodeLine{01099\ \ \ \ \ \ \ \ \ \ \ \ \ m\_cachedInertiaLowerLeft\ =\ spatInertia[0].m\_bottomLeftMat;}
\DoxyCodeLine{01100\ \ \ \ \ \ \ \ \ \ \ \ \ m\_cachedInertiaLowerRight\ =\ spatInertia[0].m\_topLeftMat.transpose();}
\DoxyCodeLine{01101\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01102\ }
\DoxyCodeLine{01103\ \ \ \ \ \ \ \ \ solveImatrix(zeroAccSpatFrc[0],\ result);}
\DoxyCodeLine{01104\ \ \ \ \ \ \ \ \ spatAcc[0]\ =\ -\/result;}
\DoxyCodeLine{01105\ \ \ \ \ \}}
\DoxyCodeLine{01106\ }
\DoxyCodeLine{01107\ \ \ \ \ \textcolor{comment}{//\ now\ do\ the\ loop\ over\ the\ m\_links}}
\DoxyCodeLine{01108\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{01109\ \ \ \ \ \{}
\DoxyCodeLine{01110\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ qdd\ =\ D\string^\{-\/1\}\ *\ (Y\ -\/\ h\string^\{T\}*apar)\ =\ (S\string^\{T\}*I*S)\string^\{-\/1\}\ *\ (tau\ -\/\ S\string^\{T\}*I*cor\ -\/\ S\string^\{T\}*zeroAccFrc\ -\/\ S\string^\{T\}*I*apar)}}
\DoxyCodeLine{01111\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ a\ =\ apar\ +\ cor\ +\ Sqdd}}
\DoxyCodeLine{01112\ \ \ \ \ \ \ \ \ \textcolor{comment}{//or}}
\DoxyCodeLine{01113\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ qdd\ =\ D\string^\{-\/1\}\ *\ (Y\ -\/\ h\string^\{T\}*(apar+cor))}}
\DoxyCodeLine{01114\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ a\ =\ apar\ +\ Sqdd}}
\DoxyCodeLine{01115\ }
\DoxyCodeLine{01116\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ m\_links[i].m\_parent;}
\DoxyCodeLine{01117\ \ \ \ \ \ \ \ \ fromParent.m\_rotMat\ =\ rot\_from\_parent[i\ +\ 1];}
\DoxyCodeLine{01118\ \ \ \ \ \ \ \ \ fromParent.m\_trnVec\ =\ m\_links[i].m\_cachedRVector;}
\DoxyCodeLine{01119\ }
\DoxyCodeLine{01120\ \ \ \ \ \ \ \ \ fromParent.transform(spatAcc[parent\ +\ 1],\ spatAcc[i\ +\ 1]);}
\DoxyCodeLine{01121\ }
\DoxyCodeLine{01122\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!isLinkAndAllAncestorsKinematic(i))}
\DoxyCodeLine{01123\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01124\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01125\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&hDof\ =\ h[m\_links[i].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{01127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Y\_minus\_hT\_a[dof]\ =\ Y[m\_links[i].m\_dofOffset\ +\ dof]\ -\/\ spatAcc[i\ +\ 1].dot(hDof);}
\DoxyCodeLine{01129\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01130\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ *invDi\ =\ \&invD[m\_links[i].m\_dofOffset\ *\ m\_links[i].m\_dofOffset];}
\DoxyCodeLine{01131\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//D\string^\{-\/1\}\ *\ (Y\ -\/\ h\string^\{T\}*apar)}}
\DoxyCodeLine{01132\ \ \ \ \ \ \ \ \ \ \ \ \ mulMatrix(invDi,\ Y\_minus\_hT\_a,\ m\_links[i].m\_dofCount,\ m\_links[i].m\_dofCount,\ m\_links[i].m\_dofCount,\ 1,\ \&joint\_accel[m\_links[i].m\_dofOffset]);}
\DoxyCodeLine{01133\ }
\DoxyCodeLine{01134\ \ \ \ \ \ \ \ \ \ \ \ \ spatAcc[i\ +\ 1]\ +=\ spatCoriolisAcc[i];}
\DoxyCodeLine{01135\ }
\DoxyCodeLine{01136\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ spatAcc[i\ +\ 1]\ +=\ m\_links[i].m\_axes[dof]\ *\ joint\_accel[m\_links[i].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{01138\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01139\ }
\DoxyCodeLine{01140\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_links[i].m\_jointFeedback)}
\DoxyCodeLine{01141\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01142\ \ \ \ \ \ \ \ \ \ \ \ \ m\_internalNeedsJointFeedback\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01143\ }
\DoxyCodeLine{01144\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ angularBotVec\ =\ (spatInertia[i\ +\ 1]\ *\ spatAcc[i\ +\ 1]\ +\ zeroAccSpatFrc[i\ +\ 1]).m\_bottomVec;}
\DoxyCodeLine{01145\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ linearTopVec\ =\ (spatInertia[i\ +\ 1]\ *\ spatAcc[i\ +\ 1]\ +\ zeroAccSpatFrc[i\ +\ 1]).m\_topVec;}
\DoxyCodeLine{01146\ }
\DoxyCodeLine{01147\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (jointFeedbackInJointFrame)}
\DoxyCodeLine{01148\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//shift\ the\ reaction\ forces\ to\ the\ joint\ frame}}
\DoxyCodeLine{01150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//linear\ (force)\ component\ is\ the\ same}}
\DoxyCodeLine{01151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//shift\ the\ angular\ (torque,\ moment)\ component\ using\ the\ relative\ position,\ \ m\_links[i].m\_dVector}}
\DoxyCodeLine{01152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ angularBotVec\ =\ angularBotVec\ -\/\ linearTopVec.cross(m\_links[i].m\_dVector);}
\DoxyCodeLine{01153\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01154\ }
\DoxyCodeLine{01155\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (jointFeedbackInWorldSpace)}
\DoxyCodeLine{01156\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isConstraintPass)}
\DoxyCodeLine{01158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_jointFeedback-\/>m\_reactionForces.m\_bottomVec\ +=\ m\_links[i].m\_cachedWorldTransform.getBasis()\ *\ angularBotVec;}
\DoxyCodeLine{01160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_jointFeedback-\/>m\_reactionForces.m\_topVec\ +=\ m\_links[i].m\_cachedWorldTransform.getBasis()\ *\ linearTopVec;}
\DoxyCodeLine{01161\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01162\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01163\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_jointFeedback-\/>m\_reactionForces.m\_bottomVec\ =\ m\_links[i].m\_cachedWorldTransform.getBasis()\ *\ angularBotVec;}
\DoxyCodeLine{01165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_jointFeedback-\/>m\_reactionForces.m\_topVec\ =\ m\_links[i].m\_cachedWorldTransform.getBasis()\ *\ linearTopVec;}
\DoxyCodeLine{01166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01167\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01168\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01169\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (isConstraintPass)}
\DoxyCodeLine{01171\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01172\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_jointFeedback-\/>m\_reactionForces.m\_bottomVec\ +=\ angularBotVec;}
\DoxyCodeLine{01173\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_jointFeedback-\/>m\_reactionForces.m\_topVec\ +=\ linearTopVec;}
\DoxyCodeLine{01174\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01175\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01176\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01177\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_jointFeedback-\/>m\_reactionForces.m\_bottomVec\ =\ angularBotVec;}
\DoxyCodeLine{01178\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_jointFeedback-\/>m\_reactionForces.m\_topVec\ =\ linearTopVec;}
\DoxyCodeLine{01179\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01180\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01181\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01182\ \ \ \ \ \}}
\DoxyCodeLine{01183\ }
\DoxyCodeLine{01184\ \ \ \ \ \textcolor{comment}{//\ transform\ base\ accelerations\ back\ to\ the\ world\ frame.}}
\DoxyCodeLine{01185\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ omegadot\_out\ =\ rot\_from\_parent[0].transpose()\ *\ spatAcc[0].getAngular();}
\DoxyCodeLine{01186\ \ \ \ \ output[0]\ =\ omegadot\_out[0];}
\DoxyCodeLine{01187\ \ \ \ \ output[1]\ =\ omegadot\_out[1];}
\DoxyCodeLine{01188\ \ \ \ \ output[2]\ =\ omegadot\_out[2];}
\DoxyCodeLine{01189\ }
\DoxyCodeLine{01190\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ vdot\_out\ =\ rot\_from\_parent[0].transpose()\ *\ (spatAcc[0].getLinear()\ +\ spatVel[0].getAngular().cross(spatVel[0].getLinear()));}
\DoxyCodeLine{01191\ \ \ \ \ output[3]\ =\ vdot\_out[0];}
\DoxyCodeLine{01192\ \ \ \ \ output[4]\ =\ vdot\_out[1];}
\DoxyCodeLine{01193\ \ \ \ \ output[5]\ =\ vdot\_out[2];}
\DoxyCodeLine{01194\ }
\DoxyCodeLine{01196\ \ \ \ \ \textcolor{comment}{//printf("{}q\ =\ ["{});}}
\DoxyCodeLine{01197\ \ \ \ \ \textcolor{comment}{//printf("{}\%.6f,\ \%.6f,\ \%.6f,\ \%.6f,\ \%.6f,\ \%.6f,\ \%.6f\ "{},\ m\_baseQuat.x(),\ m\_baseQuat.y(),\ m\_baseQuat.z(),\ m\_baseQuat.w(),\ m\_basePos.x(),\ m\_basePos.y(),\ m\_basePos.z());}}
\DoxyCodeLine{01198\ \ \ \ \ \textcolor{comment}{//for(int\ link\ =\ 0;\ link\ <\ getNumLinks();\ ++link)}}
\DoxyCodeLine{01199\ \ \ \ \ \textcolor{comment}{//\ \ for(int\ dof\ =\ 0;\ dof\ <\ m\_links[link].m\_dofCount;\ ++dof)}}
\DoxyCodeLine{01200\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ printf("{}\%.6f\ "{},\ m\_links[link].m\_jointPos[dof]);}}
\DoxyCodeLine{01201\ \ \ \ \ \textcolor{comment}{//printf("{}]\(\backslash\)n"{});}}
\DoxyCodeLine{01203\ \ \ \ \ \textcolor{comment}{//printf("{}qd\ =\ ["{});}}
\DoxyCodeLine{01204\ \ \ \ \ \textcolor{comment}{//for(int\ dof\ =\ 0;\ dof\ <\ getNumDofs()\ +\ 6;\ ++dof)}}
\DoxyCodeLine{01205\ \ \ \ \ \textcolor{comment}{//\ \ printf("{}\%.6f\ "{},\ m\_realBuf[dof]);}}
\DoxyCodeLine{01206\ \ \ \ \ \textcolor{comment}{//printf("{}]\(\backslash\)n"{});}}
\DoxyCodeLine{01207\ \ \ \ \ \textcolor{comment}{//printf("{}qdd\ =\ ["{});}}
\DoxyCodeLine{01208\ \ \ \ \ \textcolor{comment}{//for(int\ dof\ =\ 0;\ dof\ <\ getNumDofs()\ +\ 6;\ ++dof)}}
\DoxyCodeLine{01209\ \ \ \ \ \textcolor{comment}{//\ \ printf("{}\%.6f\ "{},\ output[dof]);}}
\DoxyCodeLine{01210\ \ \ \ \ \textcolor{comment}{//printf("{}]\(\backslash\)n"{});}}
\DoxyCodeLine{01212\ }
\DoxyCodeLine{01213\ \ \ \ \ \textcolor{comment}{//\ Final\ step:\ add\ the\ accelerations\ (times\ dt)\ to\ the\ velocities.}}
\DoxyCodeLine{01214\ }
\DoxyCodeLine{01215\ \ \ \ \ \textcolor{keywordflow}{if}\ (!isConstraintPass)}
\DoxyCodeLine{01216\ \ \ \ \ \{}
\DoxyCodeLine{01217\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (dt\ >\ 0.)}
\DoxyCodeLine{01218\ \ \ \ \ \ \ \ \ \ \ \ \ applyDeltaVeeMultiDof(output,\ dt);}
\DoxyCodeLine{01219\ \ \ \ \ \}}
\DoxyCodeLine{01221\ \ \ \ \ \textcolor{comment}{//btScalar\ angularThres\ =\ 1;}}
\DoxyCodeLine{01222\ \ \ \ \ \textcolor{comment}{//btScalar\ maxAngVel\ =\ 0.;}}
\DoxyCodeLine{01223\ \ \ \ \ \textcolor{comment}{//bool\ scaleDown\ =\ 1.;}}
\DoxyCodeLine{01224\ \ \ \ \ \textcolor{comment}{//for(int\ link\ =\ 0;\ link\ <\ m\_links.size();\ ++link)}}
\DoxyCodeLine{01225\ \ \ \ \ \textcolor{comment}{//\{}}
\DoxyCodeLine{01226\ \ \ \ \ \textcolor{comment}{//\ \ if(spatVel[link+1].getAngular().length()\ >\ maxAngVel)}}
\DoxyCodeLine{01227\ \ \ \ \ \textcolor{comment}{//\ \ \{}}
\DoxyCodeLine{01228\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ maxAngVel\ =\ spatVel[link+1].getAngular().length();}}
\DoxyCodeLine{01229\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ scaleDown\ =\ angularThres\ /\ spatVel[link+1].getAngular().length();}}
\DoxyCodeLine{01230\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ break;}}
\DoxyCodeLine{01231\ \ \ \ \ \textcolor{comment}{//\ \ \}}}
\DoxyCodeLine{01232\ \ \ \ \ \textcolor{comment}{//\}}}
\DoxyCodeLine{01233\ }
\DoxyCodeLine{01234\ \ \ \ \ \textcolor{comment}{//if(scaleDown\ !=\ 1.)}}
\DoxyCodeLine{01235\ \ \ \ \ \textcolor{comment}{//\{}}
\DoxyCodeLine{01236\ \ \ \ \ \textcolor{comment}{//\ \ for(int\ link\ =\ 0;\ link\ <\ m\_links.size();\ ++link)}}
\DoxyCodeLine{01237\ \ \ \ \ \textcolor{comment}{//\ \ \{}}
\DoxyCodeLine{01238\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ if(m\_links[link].m\_jointType\ ==\ btMultibodyLink::eRevolute\ ||\ m\_links[link].m\_jointType\ ==\ btMultibodyLink::eSpherical)}}
\DoxyCodeLine{01239\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \{}}
\DoxyCodeLine{01240\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ for(int\ dof\ =\ 0;\ dof\ <\ m\_links[link].m\_dofCount;\ ++dof)}}
\DoxyCodeLine{01241\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ getJointVelMultiDof(link)[dof]\ *=\ scaleDown;}}
\DoxyCodeLine{01242\ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \}}}
\DoxyCodeLine{01243\ \ \ \ \ \textcolor{comment}{//\ \ \}}}
\DoxyCodeLine{01244\ \ \ \ \ \textcolor{comment}{//\}}}
\DoxyCodeLine{01246\ }
\DoxyCodeLine{01248\ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_useGlobalVelocities)}
\DoxyCodeLine{01249\ \ \ \ \ \{}
\DoxyCodeLine{01250\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{01251\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01252\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ m\_links[i].m\_parent;}
\DoxyCodeLine{01253\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//rot\_from\_parent[i+1]\ =\ btMatrix3x3(m\_links[i].m\_cachedRotParentToThis);\ \ \ \ ///\ <-\/\ done}}
\DoxyCodeLine{01254\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//rot\_from\_world[i+1]\ =\ rot\_from\_parent[i+1]\ *\ rot\_from\_world[parent+1];\ \ \ \ \ \ \ \ ///\ <-\/\ done}}
\DoxyCodeLine{01255\ }
\DoxyCodeLine{01256\ \ \ \ \ \ \ \ \ \ \ \ \ fromParent.m\_rotMat\ =\ rot\_from\_parent[i\ +\ 1];}
\DoxyCodeLine{01257\ \ \ \ \ \ \ \ \ \ \ \ \ fromParent.m\_trnVec\ =\ m\_links[i].m\_cachedRVector;}
\DoxyCodeLine{01258\ \ \ \ \ \ \ \ \ \ \ \ \ fromWorld.m\_rotMat\ =\ rot\_from\_world[i\ +\ 1];}
\DoxyCodeLine{01259\ }
\DoxyCodeLine{01260\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ vhat\_i\ =\ i\_xhat\_p(i)\ *\ vhat\_p(i)}}
\DoxyCodeLine{01261\ \ \ \ \ \ \ \ \ \ \ \ \ fromParent.transform(spatVel[parent\ +\ 1],\ spatVel[i\ +\ 1]);}
\DoxyCodeLine{01262\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//nice\ alternative\ below\ (using\ operator\ *)\ but\ it\ generates\ temps}}
\DoxyCodeLine{01264\ }
\DoxyCodeLine{01265\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ now\ set\ vhat\_i\ to\ its\ true\ value\ by\ doing}}
\DoxyCodeLine{01266\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ vhat\_i\ +=\ qidot\ *\ shat\_i}}
\DoxyCodeLine{01267\ \ \ \ \ \ \ \ \ \ \ \ \ spatJointVel.setZero();}
\DoxyCodeLine{01268\ }
\DoxyCodeLine{01269\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01270\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ spatJointVel\ +=\ m\_links[i].m\_axes[dof]\ *\ getJointVelMultiDof(i)[dof];}
\DoxyCodeLine{01271\ }
\DoxyCodeLine{01272\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ remember\ vhat\_i\ is\ really\ vhat\_p(i)\ (but\ in\ current\ frame)\ at\ this\ point\ =>\ we\ need\ to\ add\ velocity\ across\ the\ inboard\ joint}}
\DoxyCodeLine{01273\ \ \ \ \ \ \ \ \ \ \ \ \ spatVel[i\ +\ 1]\ +=\ spatJointVel;}
\DoxyCodeLine{01274\ }
\DoxyCodeLine{01275\ \ \ \ \ \ \ \ \ \ \ \ \ fromWorld.transformInverseRotationOnly(spatVel[i\ +\ 1],\ m\_links[i].m\_absFrameTotVelocity);}
\DoxyCodeLine{01276\ \ \ \ \ \ \ \ \ \ \ \ \ fromWorld.transformInverseRotationOnly(spatJointVel,\ m\_links[i].m\_absFrameLocVelocity);}
\DoxyCodeLine{01277\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01278\ \ \ \ \ \}}
\DoxyCodeLine{01279\ \}}
\DoxyCodeLine{01280\ }
\DoxyCodeLine{01281\ \textcolor{keywordtype}{void}\ btMultiBody::solveImatrix(\textcolor{keyword}{const}\ btVector3\ \&rhs\_top,\ \textcolor{keyword}{const}\ btVector3\ \&rhs\_bot,\ btScalar\ result[6])\textcolor{keyword}{\ const}}
\DoxyCodeLine{01282\ \textcolor{keyword}{}\{}
\DoxyCodeLine{01283\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{01285\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_links\ ==\ 0)}
\DoxyCodeLine{01286\ \ \ \ \ \{}
\DoxyCodeLine{01287\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ in\ the\ case\ of\ 0\ m\_links\ (i.e.\ a\ plain\ rigid\ body,\ not\ a\ multibody)\ rhs\ *\ invI\ is\ easier}}
\DoxyCodeLine{01288\ }
\DoxyCodeLine{01289\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((m\_baseInertia[0]\ >=\ SIMD\_EPSILON)\ \&\&\ (m\_baseInertia[1]\ >=\ SIMD\_EPSILON)\ \&\&\ (m\_baseInertia[2]\ >=\ SIMD\_EPSILON))}
\DoxyCodeLine{01290\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01291\ \ \ \ \ \ \ \ \ \ \ \ \ result[0]\ =\ rhs\_bot[0]\ /\ m\_baseInertia[0];}
\DoxyCodeLine{01292\ \ \ \ \ \ \ \ \ \ \ \ \ result[1]\ =\ rhs\_bot[1]\ /\ m\_baseInertia[1];}
\DoxyCodeLine{01293\ \ \ \ \ \ \ \ \ \ \ \ \ result[2]\ =\ rhs\_bot[2]\ /\ m\_baseInertia[2];}
\DoxyCodeLine{01294\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01295\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01296\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01297\ \ \ \ \ \ \ \ \ \ \ \ \ result[0]\ =\ 0;}
\DoxyCodeLine{01298\ \ \ \ \ \ \ \ \ \ \ \ \ result[1]\ =\ 0;}
\DoxyCodeLine{01299\ \ \ \ \ \ \ \ \ \ \ \ \ result[2]\ =\ 0;}
\DoxyCodeLine{01300\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01301\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_baseMass\ >=\ SIMD\_EPSILON)}
\DoxyCodeLine{01302\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01303\ \ \ \ \ \ \ \ \ \ \ \ \ result[3]\ =\ rhs\_top[0]\ /\ m\_baseMass;}
\DoxyCodeLine{01304\ \ \ \ \ \ \ \ \ \ \ \ \ result[4]\ =\ rhs\_top[1]\ /\ m\_baseMass;}
\DoxyCodeLine{01305\ \ \ \ \ \ \ \ \ \ \ \ \ result[5]\ =\ rhs\_top[2]\ /\ m\_baseMass;}
\DoxyCodeLine{01306\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01307\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01308\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01309\ \ \ \ \ \ \ \ \ \ \ \ \ result[3]\ =\ 0;}
\DoxyCodeLine{01310\ \ \ \ \ \ \ \ \ \ \ \ \ result[4]\ =\ 0;}
\DoxyCodeLine{01311\ \ \ \ \ \ \ \ \ \ \ \ \ result[5]\ =\ 0;}
\DoxyCodeLine{01312\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01313\ \ \ \ \ \}}
\DoxyCodeLine{01314\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01315\ \ \ \ \ \{}
\DoxyCodeLine{01316\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_cachedInertiaValid)}
\DoxyCodeLine{01317\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01318\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 6;\ i++)}
\DoxyCodeLine{01319\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01320\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ result[i]\ =\ 0.f;}
\DoxyCodeLine{01321\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01322\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01323\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01326\ \ \ \ \ \ \ \ \ btMatrix3x3\ Binv\ =\ m\_cachedInertiaTopRight.inverse()\ *\ -\/1.f;}
\DoxyCodeLine{01327\ \ \ \ \ \ \ \ \ btMatrix3x3\ tmp\ =\ m\_cachedInertiaLowerRight\ *\ Binv;}
\DoxyCodeLine{01328\ \ \ \ \ \ \ \ \ btMatrix3x3\ invIupper\_right\ =\ (tmp\ *\ m\_cachedInertiaTopLeft\ +\ m\_cachedInertiaLowerLeft).inverse();}
\DoxyCodeLine{01329\ \ \ \ \ \ \ \ \ tmp\ =\ invIupper\_right\ *\ m\_cachedInertiaLowerRight;}
\DoxyCodeLine{01330\ \ \ \ \ \ \ \ \ btMatrix3x3\ invI\_upper\_left\ =\ (tmp\ *\ Binv);}
\DoxyCodeLine{01331\ \ \ \ \ \ \ \ \ btMatrix3x3\ invI\_lower\_right\ =\ (invI\_upper\_left).transpose();}
\DoxyCodeLine{01332\ \ \ \ \ \ \ \ \ tmp\ =\ m\_cachedInertiaTopLeft\ *\ invI\_upper\_left;}
\DoxyCodeLine{01333\ \ \ \ \ \ \ \ \ tmp[0][0]\ -\/=\ 1.0;}
\DoxyCodeLine{01334\ \ \ \ \ \ \ \ \ tmp[1][1]\ -\/=\ 1.0;}
\DoxyCodeLine{01335\ \ \ \ \ \ \ \ \ tmp[2][2]\ -\/=\ 1.0;}
\DoxyCodeLine{01336\ \ \ \ \ \ \ \ \ btMatrix3x3\ invI\_lower\_left\ =\ (Binv\ *\ tmp);}
\DoxyCodeLine{01337\ }
\DoxyCodeLine{01338\ \ \ \ \ \ \ \ \ \textcolor{comment}{//multiply\ result\ =\ invI\ *\ rhs}}
\DoxyCodeLine{01339\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01340\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ vtop\ =\ invI\_upper\_left\ *\ rhs\_top;}
\DoxyCodeLine{01341\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ tmp;}
\DoxyCodeLine{01342\ \ \ \ \ \ \ \ \ \ \ \ \ tmp\ =\ invIupper\_right\ *\ rhs\_bot;}
\DoxyCodeLine{01343\ \ \ \ \ \ \ \ \ \ \ \ \ vtop\ +=\ tmp;}
\DoxyCodeLine{01344\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ vbot\ =\ invI\_lower\_left\ *\ rhs\_top;}
\DoxyCodeLine{01345\ \ \ \ \ \ \ \ \ \ \ \ \ tmp\ =\ invI\_lower\_right\ *\ rhs\_bot;}
\DoxyCodeLine{01346\ \ \ \ \ \ \ \ \ \ \ \ \ vbot\ +=\ tmp;}
\DoxyCodeLine{01347\ \ \ \ \ \ \ \ \ \ \ \ \ result[0]\ =\ vtop[0];}
\DoxyCodeLine{01348\ \ \ \ \ \ \ \ \ \ \ \ \ result[1]\ =\ vtop[1];}
\DoxyCodeLine{01349\ \ \ \ \ \ \ \ \ \ \ \ \ result[2]\ =\ vtop[2];}
\DoxyCodeLine{01350\ \ \ \ \ \ \ \ \ \ \ \ \ result[3]\ =\ vbot[0];}
\DoxyCodeLine{01351\ \ \ \ \ \ \ \ \ \ \ \ \ result[4]\ =\ vbot[1];}
\DoxyCodeLine{01352\ \ \ \ \ \ \ \ \ \ \ \ \ result[5]\ =\ vbot[2];}
\DoxyCodeLine{01353\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01354\ \ \ \ \ \}}
\DoxyCodeLine{01355\ \}}
\DoxyCodeLine{01356\ \textcolor{keywordtype}{void}\ btMultiBody::solveImatrix(\textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&rhs,\ \mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ \&result)\textcolor{keyword}{\ const}}
\DoxyCodeLine{01357\ \textcolor{keyword}{}\{}
\DoxyCodeLine{01358\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{01360\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_links\ ==\ 0)}
\DoxyCodeLine{01361\ \ \ \ \ \{}
\DoxyCodeLine{01362\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ in\ the\ case\ of\ 0\ m\_links\ (i.e.\ a\ plain\ rigid\ body,\ not\ a\ multibody)\ rhs\ *\ invI\ is\ easier}}
\DoxyCodeLine{01363\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((m\_baseInertia[0]\ >=\ SIMD\_EPSILON)\ \&\&\ (m\_baseInertia[1]\ >=\ SIMD\_EPSILON)\ \&\&\ (m\_baseInertia[2]\ >=\ SIMD\_EPSILON))}
\DoxyCodeLine{01364\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01365\ \ \ \ \ \ \ \ \ \ \ \ \ result.setAngular(rhs.getAngular()\ /\ m\_baseInertia);}
\DoxyCodeLine{01366\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01367\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01368\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01369\ \ \ \ \ \ \ \ \ \ \ \ \ result.setAngular(btVector3(0,\ 0,\ 0));}
\DoxyCodeLine{01370\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01371\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_baseMass\ >=\ SIMD\_EPSILON)}
\DoxyCodeLine{01372\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01373\ \ \ \ \ \ \ \ \ \ \ \ \ result.setLinear(rhs.getLinear()\ /\ m\_baseMass);}
\DoxyCodeLine{01374\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01375\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01376\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01377\ \ \ \ \ \ \ \ \ \ \ \ \ result.setLinear(btVector3(0,\ 0,\ 0));}
\DoxyCodeLine{01378\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01379\ \ \ \ \ \}}
\DoxyCodeLine{01380\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01381\ \ \ \ \ \{}
\DoxyCodeLine{01384\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_cachedInertiaValid)}
\DoxyCodeLine{01385\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01386\ \ \ \ \ \ \ \ \ \ \ \ \ result.setLinear(btVector3(0,\ 0,\ 0));}
\DoxyCodeLine{01387\ \ \ \ \ \ \ \ \ \ \ \ \ result.setAngular(btVector3(0,\ 0,\ 0));}
\DoxyCodeLine{01388\ \ \ \ \ \ \ \ \ \ \ \ \ result.setVector(btVector3(0,\ 0,\ 0),\ btVector3(0,\ 0,\ 0));}
\DoxyCodeLine{01389\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{01390\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01391\ \ \ \ \ \ \ \ \ btMatrix3x3\ Binv\ =\ m\_cachedInertiaTopRight.inverse()\ *\ -\/1.f;}
\DoxyCodeLine{01392\ \ \ \ \ \ \ \ \ btMatrix3x3\ tmp\ =\ m\_cachedInertiaLowerRight\ *\ Binv;}
\DoxyCodeLine{01393\ \ \ \ \ \ \ \ \ btMatrix3x3\ invIupper\_right\ =\ (tmp\ *\ m\_cachedInertiaTopLeft\ +\ m\_cachedInertiaLowerLeft).inverse();}
\DoxyCodeLine{01394\ \ \ \ \ \ \ \ \ tmp\ =\ invIupper\_right\ *\ m\_cachedInertiaLowerRight;}
\DoxyCodeLine{01395\ \ \ \ \ \ \ \ \ btMatrix3x3\ invI\_upper\_left\ =\ (tmp\ *\ Binv);}
\DoxyCodeLine{01396\ \ \ \ \ \ \ \ \ btMatrix3x3\ invI\_lower\_right\ =\ (invI\_upper\_left).transpose();}
\DoxyCodeLine{01397\ \ \ \ \ \ \ \ \ tmp\ =\ m\_cachedInertiaTopLeft\ *\ invI\_upper\_left;}
\DoxyCodeLine{01398\ \ \ \ \ \ \ \ \ tmp[0][0]\ -\/=\ 1.0;}
\DoxyCodeLine{01399\ \ \ \ \ \ \ \ \ tmp[1][1]\ -\/=\ 1.0;}
\DoxyCodeLine{01400\ \ \ \ \ \ \ \ \ tmp[2][2]\ -\/=\ 1.0;}
\DoxyCodeLine{01401\ \ \ \ \ \ \ \ \ btMatrix3x3\ invI\_lower\_left\ =\ (Binv\ *\ tmp);}
\DoxyCodeLine{01402\ }
\DoxyCodeLine{01403\ \ \ \ \ \ \ \ \ \textcolor{comment}{//multiply\ result\ =\ invI\ *\ rhs}}
\DoxyCodeLine{01404\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01405\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ vtop\ =\ invI\_upper\_left\ *\ rhs.getLinear();}
\DoxyCodeLine{01406\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ tmp;}
\DoxyCodeLine{01407\ \ \ \ \ \ \ \ \ \ \ \ \ tmp\ =\ invIupper\_right\ *\ rhs.getAngular();}
\DoxyCodeLine{01408\ \ \ \ \ \ \ \ \ \ \ \ \ vtop\ +=\ tmp;}
\DoxyCodeLine{01409\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ vbot\ =\ invI\_lower\_left\ *\ rhs.getLinear();}
\DoxyCodeLine{01410\ \ \ \ \ \ \ \ \ \ \ \ \ tmp\ =\ invI\_lower\_right\ *\ rhs.getAngular();}
\DoxyCodeLine{01411\ \ \ \ \ \ \ \ \ \ \ \ \ vbot\ +=\ tmp;}
\DoxyCodeLine{01412\ \ \ \ \ \ \ \ \ \ \ \ \ result.setVector(vtop,\ vbot);}
\DoxyCodeLine{01413\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01414\ \ \ \ \ \}}
\DoxyCodeLine{01415\ \}}
\DoxyCodeLine{01416\ }
\DoxyCodeLine{01417\ \textcolor{keywordtype}{void}\ btMultiBody::mulMatrix(\textcolor{keyword}{const}\ btScalar\ *pA,\ \textcolor{keyword}{const}\ btScalar\ *pB,\ \textcolor{keywordtype}{int}\ rowsA,\ \textcolor{keywordtype}{int}\ colsA,\ \textcolor{keywordtype}{int}\ rowsB,\ \textcolor{keywordtype}{int}\ colsB,\ btScalar\ *pC)\textcolor{keyword}{\ const}}
\DoxyCodeLine{01418\ \textcolor{keyword}{}\{}
\DoxyCodeLine{01419\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ row\ =\ 0;\ \mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}}\ <\ rowsA;\ \mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}}++)}
\DoxyCodeLine{01420\ \ \ \ \ \{}
\DoxyCodeLine{01421\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ col\ =\ 0;\ col\ <\ colsB;\ col++)}
\DoxyCodeLine{01422\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01423\ \ \ \ \ \ \ \ \ \ \ \ \ pC[\mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}}\ *\ colsB\ +\ col]\ =\ 0.f;}
\DoxyCodeLine{01424\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ inner\ =\ 0;\ inner\ <\ rowsB;\ inner++)}
\DoxyCodeLine{01425\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01426\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pC[\mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}}\ *\ colsB\ +\ col]\ +=\ pA[\mbox{\hyperlink{group__gtc__matrix__access_ga259e5ebd0f31ec3f83440f8cae7f5dba}{row}}\ *\ colsA\ +\ inner]\ *\ pB[col\ +\ inner\ *\ colsB];}
\DoxyCodeLine{01427\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01428\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01429\ \ \ \ \ \}}
\DoxyCodeLine{01430\ \}}
\DoxyCodeLine{01431\ }
\DoxyCodeLine{01432\ \textcolor{keywordtype}{void}\ btMultiBody::calcAccelerationDeltasMultiDof(\textcolor{keyword}{const}\ btScalar\ *force,\ btScalar\ *output,}
\DoxyCodeLine{01433\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btScalar>}}\ \&scratch\_r,\ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btVector3>}}\ \&scratch\_v)\textcolor{keyword}{\ const}}
\DoxyCodeLine{01434\ \textcolor{keyword}{}\{}
\DoxyCodeLine{01435\ \ \ \ \ \textcolor{comment}{//\ Temporary\ matrices/vectors\ -\/-\/\ use\ scratch\ space\ from\ caller}}
\DoxyCodeLine{01436\ \ \ \ \ \textcolor{comment}{//\ so\ that\ we\ don't\ have\ to\ keep\ reallocating\ every\ frame}}
\DoxyCodeLine{01437\ }
\DoxyCodeLine{01438\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{01439\ \ \ \ \ scratch\_r.resize(m\_dofCount);}
\DoxyCodeLine{01440\ \ \ \ \ scratch\_v.resize(4\ *\ num\_links\ +\ 4);}
\DoxyCodeLine{01441\ }
\DoxyCodeLine{01442\ \ \ \ \ btScalar\ *r\_ptr\ =\ m\_dofCount\ ?\ \&scratch\_r[0]\ :\ 0;}
\DoxyCodeLine{01443\ \ \ \ \ btVector3\ *v\_ptr\ =\ \&scratch\_v[0];}
\DoxyCodeLine{01444\ }
\DoxyCodeLine{01445\ \ \ \ \ \textcolor{comment}{//\ zhat\_i\string^A\ (scratch\ space)}}
\DoxyCodeLine{01446\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ *zeroAccSpatFrc\ =\ (\mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ *)v\_ptr;}
\DoxyCodeLine{01447\ \ \ \ \ v\_ptr\ +=\ num\_links\ *\ 2\ +\ 2;}
\DoxyCodeLine{01448\ }
\DoxyCodeLine{01449\ \ \ \ \ \textcolor{comment}{//\ rot\_from\_parent\ (cached\ from\ calcAccelerations)}}
\DoxyCodeLine{01450\ \ \ \ \ \textcolor{keyword}{const}\ btMatrix3x3\ *rot\_from\_parent\ =\ \&m\_matrixBuf[0];}
\DoxyCodeLine{01451\ }
\DoxyCodeLine{01452\ \ \ \ \ \textcolor{comment}{//\ hhat\ (cached),\ accel\ (scratch)}}
\DoxyCodeLine{01453\ \ \ \ \ \textcolor{comment}{//\ hhat\ is\ NOT\ stored\ for\ the\ base\ (but\ ahat\ is)}}
\DoxyCodeLine{01454\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ *h\ =\ (\mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ *)(m\_dofCount\ >\ 0\ ?\ \&m\_vectorBuf[0]\ :\ 0);}
\DoxyCodeLine{01455\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ *spatAcc\ =\ (\mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ *)v\_ptr;}
\DoxyCodeLine{01456\ \ \ \ \ v\_ptr\ +=\ num\_links\ *\ 2\ +\ 2;}
\DoxyCodeLine{01457\ }
\DoxyCodeLine{01458\ \ \ \ \ \textcolor{comment}{//\ Y\_i\ (scratch),\ invD\_i\ (cached)}}
\DoxyCodeLine{01459\ \ \ \ \ \textcolor{keyword}{const}\ btScalar\ *invD\ =\ m\_dofCount\ >\ 0\ ?\ \&m\_realBuf[6\ +\ m\_dofCount]\ :\ 0;}
\DoxyCodeLine{01460\ \ \ \ \ btScalar\ *Y\ =\ r\_ptr;}
\DoxyCodeLine{01462\ \ \ \ \ \textcolor{comment}{//aux\ variables}}
\DoxyCodeLine{01463\ \ \ \ \ btScalar\ invD\_times\_Y[6];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//D\string^\{-\/1\}\ *\ Y\ [dofxdof\ x\ dofx1\ =\ dofx1]\ <=>\ D\string^\{-\/1\}\ *\ u;\ better\ moved\ to\ buffers\ since\ it\ is\ recalced\ in\ calcAccelerationDeltasMultiDof;\ num\_dof\ of\ btScalar\ would\ cover\ all\ bodies}}
\DoxyCodeLine{01464\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_motion_vector}{btSpatialMotionVector}}\ result;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//holds\ results\ of\ the\ SolveImatrix\ op;\ it\ is\ a\ spatial\ motion\ vector\ (accel)}}
\DoxyCodeLine{01465\ \ \ \ \ btScalar\ Y\_minus\_hT\_a[6];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//Y\ -\/\ h\string^\{T\}\ *\ a;\ it's\ dofx1\ for\ each\ body\ so\ a\ single\ 6x1\ temp\ is\ enough}}
\DoxyCodeLine{01466\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ spatForceVecTemps[6];\ \ \textcolor{comment}{//6\ temporary\ spatial\ force\ vectors}}
\DoxyCodeLine{01467\ \ \ \ \ \mbox{\hyperlink{structbt_spatial_transformation_matrix}{btSpatialTransformationMatrix}}\ fromParent;}
\DoxyCodeLine{01469\ }
\DoxyCodeLine{01470\ \ \ \ \ \textcolor{comment}{//\ First\ 'upward'\ loop.}}
\DoxyCodeLine{01471\ \ \ \ \ \textcolor{comment}{//\ Combines\ CompTreeLinkVelocities\ and\ InitTreeLinks\ from\ Mirtich.}}
\DoxyCodeLine{01472\ }
\DoxyCodeLine{01473\ \ \ \ \ \textcolor{comment}{//\ Fill\ in\ zero\_acc}}
\DoxyCodeLine{01474\ \ \ \ \ \textcolor{comment}{//\ -\/-\/\ set\ to\ force/torque\ on\ the\ base,\ zero\ otherwise}}
\DoxyCodeLine{01475\ \ \ \ \ \textcolor{keywordflow}{if}\ (isBaseStaticOrKinematic())}
\DoxyCodeLine{01476\ \ \ \ \ \{}
\DoxyCodeLine{01477\ \ \ \ \ \ \ \ \ zeroAccSpatFrc[0].setZero();}
\DoxyCodeLine{01478\ \ \ \ \ \}}
\DoxyCodeLine{01479\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01480\ \ \ \ \ \{}
\DoxyCodeLine{01481\ \ \ \ \ \ \ \ \ \textcolor{comment}{//test\ forces}}
\DoxyCodeLine{01482\ \ \ \ \ \ \ \ \ fromParent.m\_rotMat\ =\ rot\_from\_parent[0];}
\DoxyCodeLine{01483\ \ \ \ \ \ \ \ \ fromParent.transformRotationOnly(\mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}(-\/force[0],\ -\/force[1],\ -\/force[2],\ -\/force[3],\ -\/force[4],\ -\/force[5]),\ zeroAccSpatFrc[0]);}
\DoxyCodeLine{01484\ \ \ \ \ \}}
\DoxyCodeLine{01485\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{01486\ \ \ \ \ \{}
\DoxyCodeLine{01487\ \ \ \ \ \ \ \ \ zeroAccSpatFrc[i\ +\ 1].setZero();}
\DoxyCodeLine{01488\ \ \ \ \ \}}
\DoxyCodeLine{01489\ }
\DoxyCodeLine{01490\ \ \ \ \ \textcolor{comment}{//\ 'Downward'\ loop.}}
\DoxyCodeLine{01491\ \ \ \ \ \textcolor{comment}{//\ (part\ of\ TreeForwardDynamics\ in\ Mirtich.)}}
\DoxyCodeLine{01492\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ num\_links\ -\/\ 1;\ i\ >=\ 0;\ -\/-\/i)}
\DoxyCodeLine{01493\ \ \ \ \ \{}
\DoxyCodeLine{01494\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(isLinkAndAllAncestorsKinematic(i))}
\DoxyCodeLine{01495\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01496\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ m\_links[i].m\_parent;}
\DoxyCodeLine{01497\ \ \ \ \ \ \ \ \ fromParent.m\_rotMat\ =\ rot\_from\_parent[i\ +\ 1];}
\DoxyCodeLine{01498\ \ \ \ \ \ \ \ \ fromParent.m\_trnVec\ =\ m\_links[i].m\_cachedRVector;}
\DoxyCodeLine{01499\ }
\DoxyCodeLine{01500\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01501\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01502\ \ \ \ \ \ \ \ \ \ \ \ \ Y[m\_links[i].m\_dofOffset\ +\ dof]\ =\ force[6\ +\ m\_links[i].m\_dofOffset\ +\ dof]\ -\/\ m\_links[i].m\_axes[dof].dot(zeroAccSpatFrc[i\ +\ 1]);}
\DoxyCodeLine{01503\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01504\ }
\DoxyCodeLine{01505\ \ \ \ \ \ \ \ \ btVector3\ in\_top,\ in\_bottom,\ out\_top,\ out\_bottom;}
\DoxyCodeLine{01506\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btScalar\ *invDi\ =\ \&invD[m\_links[i].m\_dofOffset\ *\ m\_links[i].m\_dofOffset];}
\DoxyCodeLine{01507\ }
\DoxyCodeLine{01508\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01509\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01510\ \ \ \ \ \ \ \ \ \ \ \ \ invD\_times\_Y[dof]\ =\ 0.f;}
\DoxyCodeLine{01511\ }
\DoxyCodeLine{01512\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof2\ =\ 0;\ dof2\ <\ m\_links[i].m\_dofCount;\ ++dof2)}
\DoxyCodeLine{01513\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01514\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ invD\_times\_Y[dof]\ +=\ invDi[dof\ *\ m\_links[i].m\_dofCount\ +\ dof2]\ *\ Y[m\_links[i].m\_dofOffset\ +\ dof2];}
\DoxyCodeLine{01515\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01516\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01517\ }
\DoxyCodeLine{01518\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Zp\ +=\ pXi\ *\ (Zi\ +\ hi*Yi/Di)}}
\DoxyCodeLine{01519\ \ \ \ \ \ \ \ \ spatForceVecTemps[0]\ =\ zeroAccSpatFrc[i\ +\ 1];}
\DoxyCodeLine{01520\ }
\DoxyCodeLine{01521\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01522\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01523\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&hDof\ =\ h[m\_links[i].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{01524\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01525\ \ \ \ \ \ \ \ \ \ \ \ \ spatForceVecTemps[0]\ +=\ hDof\ *\ invD\_times\_Y[dof];}
\DoxyCodeLine{01526\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01527\ }
\DoxyCodeLine{01528\ \ \ \ \ \ \ \ \ fromParent.transformInverse(spatForceVecTemps[0],\ spatForceVecTemps[1]);}
\DoxyCodeLine{01529\ }
\DoxyCodeLine{01530\ \ \ \ \ \ \ \ \ zeroAccSpatFrc[parent\ +\ 1]\ +=\ spatForceVecTemps[1];}
\DoxyCodeLine{01531\ \ \ \ \ \}}
\DoxyCodeLine{01532\ }
\DoxyCodeLine{01533\ \ \ \ \ \textcolor{comment}{//\ ptr\ to\ the\ joint\ accel\ part\ of\ the\ output}}
\DoxyCodeLine{01534\ \ \ \ \ btScalar\ *joint\_accel\ =\ output\ +\ 6;}
\DoxyCodeLine{01535\ }
\DoxyCodeLine{01536\ \ \ \ \ \textcolor{comment}{//\ Second\ 'upward'\ loop}}
\DoxyCodeLine{01537\ \ \ \ \ \textcolor{comment}{//\ (part\ of\ TreeForwardDynamics\ in\ Mirtich)}}
\DoxyCodeLine{01538\ }
\DoxyCodeLine{01539\ \ \ \ \ \textcolor{keywordflow}{if}\ (isBaseStaticOrKinematic())}
\DoxyCodeLine{01540\ \ \ \ \ \{}
\DoxyCodeLine{01541\ \ \ \ \ \ \ \ \ spatAcc[0].setZero();}
\DoxyCodeLine{01542\ \ \ \ \ \}}
\DoxyCodeLine{01543\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01544\ \ \ \ \ \{}
\DoxyCodeLine{01545\ \ \ \ \ \ \ \ \ solveImatrix(zeroAccSpatFrc[0],\ result);}
\DoxyCodeLine{01546\ \ \ \ \ \ \ \ \ spatAcc[0]\ =\ -\/result;}
\DoxyCodeLine{01547\ \ \ \ \ \}}
\DoxyCodeLine{01548\ }
\DoxyCodeLine{01549\ \ \ \ \ \textcolor{comment}{//\ now\ do\ the\ loop\ over\ the\ m\_links}}
\DoxyCodeLine{01550\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{01551\ \ \ \ \ \{}
\DoxyCodeLine{01552\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(isLinkAndAllAncestorsKinematic(i))}
\DoxyCodeLine{01553\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{01554\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ m\_links[i].m\_parent;}
\DoxyCodeLine{01555\ \ \ \ \ \ \ \ \ fromParent.m\_rotMat\ =\ rot\_from\_parent[i\ +\ 1];}
\DoxyCodeLine{01556\ \ \ \ \ \ \ \ \ fromParent.m\_trnVec\ =\ m\_links[i].m\_cachedRVector;}
\DoxyCodeLine{01557\ }
\DoxyCodeLine{01558\ \ \ \ \ \ \ \ \ fromParent.transform(spatAcc[parent\ +\ 1],\ spatAcc[i\ +\ 1]);}
\DoxyCodeLine{01559\ }
\DoxyCodeLine{01560\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01561\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01562\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structbt_spatial_force_vector}{btSpatialForceVector}}\ \&hDof\ =\ h[m\_links[i].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{01563\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01564\ \ \ \ \ \ \ \ \ \ \ \ \ Y\_minus\_hT\_a[dof]\ =\ Y[m\_links[i].m\_dofOffset\ +\ dof]\ -\/\ spatAcc[i\ +\ 1].dot(hDof);}
\DoxyCodeLine{01565\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01566\ }
\DoxyCodeLine{01567\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btScalar\ *invDi\ =\ \&invD[m\_links[i].m\_dofOffset\ *\ m\_links[i].m\_dofOffset];}
\DoxyCodeLine{01568\ \ \ \ \ \ \ \ \ mulMatrix(\textcolor{keyword}{const\_cast<}btScalar\ *\textcolor{keyword}{>}(invDi),\ Y\_minus\_hT\_a,\ m\_links[i].m\_dofCount,\ m\_links[i].m\_dofCount,\ m\_links[i].m\_dofCount,\ 1,\ \&joint\_accel[m\_links[i].m\_dofOffset]);}
\DoxyCodeLine{01569\ }
\DoxyCodeLine{01570\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[i].m\_dofCount;\ ++dof)}
\DoxyCodeLine{01571\ \ \ \ \ \ \ \ \ \ \ \ \ spatAcc[i\ +\ 1]\ +=\ m\_links[i].m\_axes[dof]\ *\ joint\_accel[m\_links[i].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{01572\ \ \ \ \ \}}
\DoxyCodeLine{01573\ }
\DoxyCodeLine{01574\ \ \ \ \ \textcolor{comment}{//\ transform\ base\ accelerations\ back\ to\ the\ world\ frame.}}
\DoxyCodeLine{01575\ \ \ \ \ btVector3\ omegadot\_out;}
\DoxyCodeLine{01576\ \ \ \ \ omegadot\_out\ =\ rot\_from\_parent[0].transpose()\ *\ spatAcc[0].getAngular();}
\DoxyCodeLine{01577\ \ \ \ \ output[0]\ =\ omegadot\_out[0];}
\DoxyCodeLine{01578\ \ \ \ \ output[1]\ =\ omegadot\_out[1];}
\DoxyCodeLine{01579\ \ \ \ \ output[2]\ =\ omegadot\_out[2];}
\DoxyCodeLine{01580\ }
\DoxyCodeLine{01581\ \ \ \ \ btVector3\ vdot\_out;}
\DoxyCodeLine{01582\ \ \ \ \ vdot\_out\ =\ rot\_from\_parent[0].transpose()\ *\ spatAcc[0].getLinear();}
\DoxyCodeLine{01583\ \ \ \ \ output[3]\ =\ vdot\_out[0];}
\DoxyCodeLine{01584\ \ \ \ \ output[4]\ =\ vdot\_out[1];}
\DoxyCodeLine{01585\ \ \ \ \ output[5]\ =\ vdot\_out[2];}
\DoxyCodeLine{01586\ }
\DoxyCodeLine{01588\ \ \ \ \ \textcolor{comment}{//printf("{}delta\ =\ ["{});}}
\DoxyCodeLine{01589\ \ \ \ \ \textcolor{comment}{//for(int\ dof\ =\ 0;\ dof\ <\ getNumDofs()\ +\ 6;\ ++dof)}}
\DoxyCodeLine{01590\ \ \ \ \ \textcolor{comment}{//\ \ printf("{}\%.2f\ "{},\ output[dof]);}}
\DoxyCodeLine{01591\ \ \ \ \ \textcolor{comment}{//printf("{}]\(\backslash\)n"{});}}
\DoxyCodeLine{01593\ \}}
\DoxyCodeLine{01594\ \textcolor{keywordtype}{void}\ btMultiBody::predictPositionsMultiDof(btScalar\ dt)}
\DoxyCodeLine{01595\ \{}
\DoxyCodeLine{01596\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{01597\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!isBaseKinematic())}
\DoxyCodeLine{01598\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01599\ \ \ \ \ \ \ \textcolor{comment}{//\ step\ position\ by\ adding\ dt\ *\ velocity}}
\DoxyCodeLine{01600\ \ \ \ \ \ \ \textcolor{comment}{//btVector3\ v\ =\ getBaseVel();}}
\DoxyCodeLine{01601\ \ \ \ \ \ \ \textcolor{comment}{//m\_basePos\ +=\ dt\ *\ v;}}
\DoxyCodeLine{01602\ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01603\ \ \ \ \ \ \ btScalar\ *pBasePos;}
\DoxyCodeLine{01604\ \ \ \ \ \ \ btScalar\ *pBaseVel\ =\ \&m\_realBuf[3];\ \ \textcolor{comment}{//note:\ the\ !pqd\ case\ assumes\ m\_realBuf\ holds\ with\ base\ velocity\ at\ 3,4,5\ (should\ be\ wrapped\ for\ safety)}}
\DoxyCodeLine{01605\ \ \ \ \ }
\DoxyCodeLine{01606\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ reset\ to\ current\ position}}
\DoxyCodeLine{01607\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 3;\ ++i)}
\DoxyCodeLine{01608\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01609\ \ \ \ \ \ \ \ \ \ \ \ \ m\_basePos\_interpolate[i]\ =\ m\_basePos[i];}
\DoxyCodeLine{01610\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01611\ \ \ \ \ \ \ \ \ pBasePos\ =\ m\_basePos\_interpolate;}
\DoxyCodeLine{01612\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01613\ \ \ \ \ \ \ \ \ pBasePos[0]\ +=\ dt\ *\ pBaseVel[0];}
\DoxyCodeLine{01614\ \ \ \ \ \ \ \ \ pBasePos[1]\ +=\ dt\ *\ pBaseVel[1];}
\DoxyCodeLine{01615\ \ \ \ \ \ \ \ \ pBasePos[2]\ +=\ dt\ *\ pBaseVel[2];}
\DoxyCodeLine{01616\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01617\ \ \ \ \ }
\DoxyCodeLine{01619\ \ \ \ \ \textcolor{comment}{//local\ functor\ for\ quaternion\ integration\ (to\ avoid\ error\ prone\ redundancy)}}
\DoxyCodeLine{01620\ \ \ \ \ \textcolor{keyword}{struct}}
\DoxyCodeLine{01621\ \ \ \ \ \{}
\DoxyCodeLine{01622\ \ \ \ \ \ \ \ \ \textcolor{comment}{//"{}exponential\ map"{}\ based\ on\ btTransformUtil::integrateTransform(..)}}
\DoxyCodeLine{01623\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ operator()(\textcolor{keyword}{const}\ btVector3\ \&omega,\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&quat,\ \textcolor{keywordtype}{bool}\ baseBody,\ btScalar\ dt)}
\DoxyCodeLine{01624\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01625\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//baseBody\ \ \ \ =>\ \ \ \ quat\ is\ alias\ and\ omega\ is\ global\ coor}}
\DoxyCodeLine{01627\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01628\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}};}
\DoxyCodeLine{01629\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ angvel;}
\DoxyCodeLine{01630\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01631\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!baseBody)}
\DoxyCodeLine{01632\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ angvel\ =\ quatRotate(quat,\ omega);\ \ \textcolor{comment}{//if\ quat\ is\ not\ m\_baseQuat,\ it\ is\ alibi\ =>\ ok}}
\DoxyCodeLine{01633\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01634\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ angvel\ =\ omega;}
\DoxyCodeLine{01635\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01636\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ fAngle\ =\ angvel.length();}
\DoxyCodeLine{01637\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//limit\ the\ angular\ motion}}
\DoxyCodeLine{01638\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fAngle\ *\ dt\ >\ ANGULAR\_MOTION\_THRESHOLD)}
\DoxyCodeLine{01639\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01640\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fAngle\ =\ btScalar(0.5)\ *\ SIMD\_HALF\_PI\ /\ dt;}
\DoxyCodeLine{01641\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01642\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01643\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fAngle\ <\ btScalar(0.001))}
\DoxyCodeLine{01644\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01645\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ use\ Taylor's\ expansions\ of\ sync\ function}}
\DoxyCodeLine{01646\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}\ =\ angvel\ *\ (btScalar(0.5)\ *\ dt\ -\/\ (dt\ *\ dt\ *\ dt)\ *\ (btScalar(0.020833333333))\ *\ fAngle\ *\ fAngle);}
\DoxyCodeLine{01647\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01648\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01649\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01650\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ sync(fAngle)\ =\ sin(c*fAngle)/t}}
\DoxyCodeLine{01651\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}\ =\ angvel\ *\ (btSin(btScalar(0.5)\ *\ fAngle\ *\ dt)\ /\ fAngle);}
\DoxyCodeLine{01652\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01653\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01654\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!baseBody)}
\DoxyCodeLine{01655\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}\ =\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(\mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.x(),\ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.y(),\ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.z(),\ btCos(fAngle\ *\ dt\ *\ btScalar(0.5)))\ *\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}};}
\DoxyCodeLine{01656\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01657\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}\ =\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}\ *\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(-\/\mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.x(),\ -\/\mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.y(),\ -\/\mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.z(),\ btCos(fAngle\ *\ dt\ *\ btScalar(0.5)));}
\DoxyCodeLine{01658\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//equivalent\ to:\ quat\ =\ (btQuaternion(axis.x(),axis.y(),axis.z(),btCos(\ fAngle*dt*btScalar(0.5)\ ))\ *\ quat.inverse()).inverse();}}
\DoxyCodeLine{01659\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01660\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}.normalize();}
\DoxyCodeLine{01661\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01662\ \ \ \ \ \}\ pQuatUpdateFun;}
\DoxyCodeLine{01664\ \ \ \ \ }
\DoxyCodeLine{01665\ \ \ \ \ \textcolor{comment}{//pQuatUpdateFun(getBaseOmega(),\ m\_baseQuat,\ true,\ dt);}}
\DoxyCodeLine{01666\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01667\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(!isBaseKinematic())}
\DoxyCodeLine{01668\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01669\ \ \ \ \ \ \ \ \ btScalar\ *pBaseQuat;}
\DoxyCodeLine{01670\ }
\DoxyCodeLine{01671\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ reset\ to\ current\ orientation}}
\DoxyCodeLine{01672\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 4;\ ++i)}
\DoxyCodeLine{01673\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01674\ \ \ \ \ \ \ \ \ \ \ \ \ m\_baseQuat\_interpolate[i]\ =\ m\_baseQuat[i];}
\DoxyCodeLine{01675\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01676\ \ \ \ \ \ \ \ \ pBaseQuat\ =\ m\_baseQuat\_interpolate;}
\DoxyCodeLine{01677\ }
\DoxyCodeLine{01678\ \ \ \ \ \ \ \ \ btScalar\ *pBaseOmega\ =\ \&m\_realBuf[0];\ \ \textcolor{comment}{//note:\ the\ !pqd\ case\ assumes\ m\_realBuf\ starts\ with\ base\ omega\ (should\ be\ wrapped\ for\ safety)}}
\DoxyCodeLine{01679\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01680\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ baseQuat;}
\DoxyCodeLine{01681\ \ \ \ \ \ \ \ \ baseQuat.setValue(pBaseQuat[0],\ pBaseQuat[1],\ pBaseQuat[2],\ pBaseQuat[3]);}
\DoxyCodeLine{01682\ \ \ \ \ \ \ \ \ btVector3\ baseOmega;}
\DoxyCodeLine{01683\ \ \ \ \ \ \ \ \ baseOmega.setValue(pBaseOmega[0],\ pBaseOmega[1],\ pBaseOmega[2]);}
\DoxyCodeLine{01684\ \ \ \ \ \ \ \ \ pQuatUpdateFun(baseOmega,\ baseQuat,\ \textcolor{keyword}{true},\ dt);}
\DoxyCodeLine{01685\ \ \ \ \ \ \ \ \ pBaseQuat[0]\ =\ baseQuat.x();}
\DoxyCodeLine{01686\ \ \ \ \ \ \ \ \ pBaseQuat[1]\ =\ baseQuat.y();}
\DoxyCodeLine{01687\ \ \ \ \ \ \ \ \ pBaseQuat[2]\ =\ baseQuat.z();}
\DoxyCodeLine{01688\ \ \ \ \ \ \ \ \ pBaseQuat[3]\ =\ baseQuat.w();}
\DoxyCodeLine{01689\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01690\ }
\DoxyCodeLine{01691\ \ \ \ \ \textcolor{comment}{//\ Finally\ we\ can\ update\ m\_jointPos\ for\ each\ of\ the\ m\_links}}
\DoxyCodeLine{01692\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{01693\ \ \ \ \ \{}
\DoxyCodeLine{01694\ \ \ \ \ \ \ \ \ btScalar\ *pJointPos;}
\DoxyCodeLine{01695\ \ \ \ \ \ \ \ \ pJointPos\ =\ \&m\_links[i].m\_jointPos\_interpolate[0];}
\DoxyCodeLine{01696\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01697\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_links[i].m\_collider\ \&\&\ m\_links[i].m\_collider-\/>isStaticOrKinematic())\ }
\DoxyCodeLine{01698\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01699\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (m\_links[i].m\_jointType)\ }
\DoxyCodeLine{01700\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01701\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePrismatic:}
\DoxyCodeLine{01702\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eRevolute:}
\DoxyCodeLine{01703\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01704\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[0]\ =\ m\_links[i].m\_jointPos[0];}
\DoxyCodeLine{01705\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01706\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01707\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eSpherical:}
\DoxyCodeLine{01708\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01709\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ 4;\ ++j)}
\DoxyCodeLine{01710\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01711\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[j]\ =\ m\_links[i].m\_jointPos[j];}
\DoxyCodeLine{01712\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01713\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01714\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01715\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePlanar:}
\DoxyCodeLine{01716\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01717\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ 3;\ ++j)}
\DoxyCodeLine{01718\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01719\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[j]\ =\ m\_links[i].m\_jointPos[j];}
\DoxyCodeLine{01720\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01721\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01722\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01723\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01724\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01725\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01726\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01727\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01728\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01729\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ *pJointVel\ =\ getJointVelMultiDof(i);\ }
\DoxyCodeLine{01730\ }
\DoxyCodeLine{01731\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (m\_links[i].m\_jointType)}
\DoxyCodeLine{01732\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01733\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePrismatic:}
\DoxyCodeLine{01734\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eRevolute:}
\DoxyCodeLine{01735\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01736\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//reset\ to\ current\ pos}}
\DoxyCodeLine{01737\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[0]\ =\ m\_links[i].m\_jointPos[0];}
\DoxyCodeLine{01738\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ jointVel\ =\ pJointVel[0];}
\DoxyCodeLine{01739\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[0]\ +=\ dt\ *\ jointVel;}
\DoxyCodeLine{01740\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01741\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01742\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eSpherical:}
\DoxyCodeLine{01743\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01744\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//reset\ to\ current\ pos}}
\DoxyCodeLine{01745\ }
\DoxyCodeLine{01746\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ 4;\ ++j)}
\DoxyCodeLine{01747\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01748\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[j]\ =\ m\_links[i].m\_jointPos[j];}
\DoxyCodeLine{01749\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01750\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01751\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ jointVel;}
\DoxyCodeLine{01752\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ jointVel.setValue(pJointVel[0],\ pJointVel[1],\ pJointVel[2]);}
\DoxyCodeLine{01753\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ jointOri;}
\DoxyCodeLine{01754\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ jointOri.setValue(pJointPos[0],\ pJointPos[1],\ pJointPos[2],\ pJointPos[3]);}
\DoxyCodeLine{01755\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pQuatUpdateFun(jointVel,\ jointOri,\ \textcolor{keyword}{false},\ dt);}
\DoxyCodeLine{01756\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[0]\ =\ jointOri.x();}
\DoxyCodeLine{01757\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[1]\ =\ jointOri.y();}
\DoxyCodeLine{01758\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[2]\ =\ jointOri.z();}
\DoxyCodeLine{01759\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[3]\ =\ jointOri.w();}
\DoxyCodeLine{01760\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01761\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01762\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePlanar:}
\DoxyCodeLine{01763\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01764\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ j\ =\ 0;\ j\ <\ 3;\ ++j)}
\DoxyCodeLine{01765\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01766\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[j]\ =\ m\_links[i].m\_jointPos[j];}
\DoxyCodeLine{01767\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01768\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[0]\ +=\ dt\ *\ getJointVelMultiDof(i)[0];}
\DoxyCodeLine{01769\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01770\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ q0\_coors\_qd1qd2\ =\ getJointVelMultiDof(i)[1]\ *\ m\_links[i].getAxisBottom(1)\ +\ getJointVelMultiDof(i)[2]\ *\ m\_links[i].getAxisBottom(2);}
\DoxyCodeLine{01771\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ no\_q0\_coors\_qd1qd2\ =\ quatRotate(\mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(m\_links[i].getAxisTop(0),\ pJointPos[0]),\ q0\_coors\_qd1qd2);}
\DoxyCodeLine{01772\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[1]\ +=\ m\_links[i].getAxisBottom(1).dot(no\_q0\_coors\_qd1qd2)\ *\ dt;}
\DoxyCodeLine{01773\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[2]\ +=\ m\_links[i].getAxisBottom(2).dot(no\_q0\_coors\_qd1qd2)\ *\ dt;}
\DoxyCodeLine{01774\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01775\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01776\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01777\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01778\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01779\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01780\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01781\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01782\ \ \ \ \ \ \ \ \ m\_links[i].updateInterpolationCacheMultiDof();}
\DoxyCodeLine{01783\ \ \ \ \ \}}
\DoxyCodeLine{01784\ \}}
\DoxyCodeLine{01785\ }
\DoxyCodeLine{01786\ \textcolor{keywordtype}{void}\ btMultiBody::stepPositionsMultiDof(btScalar\ dt,\ btScalar\ *pq,\ btScalar\ *pqd)}
\DoxyCodeLine{01787\ \{}
\DoxyCodeLine{01788\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{01789\ \ \ \ \ \textcolor{keywordflow}{if}(!isBaseKinematic())}
\DoxyCodeLine{01790\ \ \ \ \ \{}
\DoxyCodeLine{01791\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ step\ position\ by\ adding\ dt\ *\ velocity}}
\DoxyCodeLine{01792\ \ \ \ \ \ \ \ \ \textcolor{comment}{//btVector3\ v\ =\ getBaseVel();}}
\DoxyCodeLine{01793\ \ \ \ \ \ \ \ \ \textcolor{comment}{//m\_basePos\ +=\ dt\ *\ v;}}
\DoxyCodeLine{01794\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01795\ \ \ \ \ \ \ btScalar\ *pBasePos\ =\ (pq\ ?\ \&pq[4]\ :\ m\_basePos);}
\DoxyCodeLine{01796\ \ \ \ \ \ \ btScalar\ *pBaseVel\ =\ (pqd\ ?\ \&pqd[3]\ :\ \&m\_realBuf[3]);\ \ \textcolor{comment}{//note:\ the\ !pqd\ case\ assumes\ m\_realBuf\ holds\ with\ base\ velocity\ at\ 3,4,5\ (should\ be\ wrapped\ for\ safety)}}
\DoxyCodeLine{01797\ \ \ \ \ \ \ }
\DoxyCodeLine{01798\ \ \ \ \ \ \ \ \ pBasePos[0]\ +=\ dt\ *\ pBaseVel[0];}
\DoxyCodeLine{01799\ \ \ \ \ \ \ \ \ pBasePos[1]\ +=\ dt\ *\ pBaseVel[1];}
\DoxyCodeLine{01800\ \ \ \ \ \ \ \ \ pBasePos[2]\ +=\ dt\ *\ pBaseVel[2];}
\DoxyCodeLine{01801\ \ \ \ \ \}}
\DoxyCodeLine{01802\ }
\DoxyCodeLine{01804\ \ \ \ \ \textcolor{comment}{//local\ functor\ for\ quaternion\ integration\ (to\ avoid\ error\ prone\ redundancy)}}
\DoxyCodeLine{01805\ \ \ \ \ \textcolor{keyword}{struct}}
\DoxyCodeLine{01806\ \ \ \ \ \{}
\DoxyCodeLine{01807\ \ \ \ \ \ \ \ \ \textcolor{comment}{//"{}exponential\ map"{}\ based\ on\ btTransformUtil::integrateTransform(..)}}
\DoxyCodeLine{01808\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ operator()(\textcolor{keyword}{const}\ btVector3\ \&omega,\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ \&quat,\ \textcolor{keywordtype}{bool}\ baseBody,\ btScalar\ dt)}
\DoxyCodeLine{01809\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01810\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//baseBody\ \ =>\ \ quat\ is\ alias\ and\ omega\ is\ global\ coor}}
\DoxyCodeLine{01812\ }
\DoxyCodeLine{01813\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}};}
\DoxyCodeLine{01814\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ angvel;}
\DoxyCodeLine{01815\ }
\DoxyCodeLine{01816\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!baseBody)}
\DoxyCodeLine{01817\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ angvel\ =\ quatRotate(quat,\ omega);\ \ \textcolor{comment}{//if\ quat\ is\ not\ m\_baseQuat,\ it\ is\ alibi\ =>\ ok}}
\DoxyCodeLine{01818\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01819\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ angvel\ =\ omega;}
\DoxyCodeLine{01820\ }
\DoxyCodeLine{01821\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ fAngle\ =\ angvel.length();}
\DoxyCodeLine{01822\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//limit\ the\ angular\ motion}}
\DoxyCodeLine{01823\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fAngle\ *\ dt\ >\ ANGULAR\_MOTION\_THRESHOLD)}
\DoxyCodeLine{01824\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01825\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fAngle\ =\ btScalar(0.5)\ *\ SIMD\_HALF\_PI\ /\ dt;}
\DoxyCodeLine{01826\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01827\ }
\DoxyCodeLine{01828\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (fAngle\ <\ btScalar(0.001))}
\DoxyCodeLine{01829\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01830\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ use\ Taylor's\ expansions\ of\ sync\ function}}
\DoxyCodeLine{01831\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}\ =\ angvel\ *\ (btScalar(0.5)\ *\ dt\ -\/\ (dt\ *\ dt\ *\ dt)\ *\ (btScalar(0.020833333333))\ *\ fAngle\ *\ fAngle);}
\DoxyCodeLine{01832\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01833\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01834\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01835\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ sync(fAngle)\ =\ sin(c*fAngle)/t}}
\DoxyCodeLine{01836\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}\ =\ angvel\ *\ (btSin(btScalar(0.5)\ *\ fAngle\ *\ dt)\ /\ fAngle);}
\DoxyCodeLine{01837\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01838\ }
\DoxyCodeLine{01839\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!baseBody)}
\DoxyCodeLine{01840\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}\ =\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(\mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.x(),\ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.y(),\ \mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.z(),\ btCos(fAngle\ *\ dt\ *\ btScalar(0.5)))\ *\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}};}
\DoxyCodeLine{01841\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{01842\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}\ =\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}\ *\ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(-\/\mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.x(),\ -\/\mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.y(),\ -\/\mbox{\hyperlink{group__ext__quaternion__trigonometric_gac2b65b953ea72827e172fc39035964a7}{axis}}.z(),\ btCos(fAngle\ *\ dt\ *\ btScalar(0.5)));}
\DoxyCodeLine{01843\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//equivalent\ to:\ quat\ =\ (btQuaternion(axis.x(),axis.y(),axis.z(),btCos(\ fAngle*dt*btScalar(0.5)\ ))\ *\ quat.inverse()).inverse();}}
\DoxyCodeLine{01844\ }
\DoxyCodeLine{01845\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}.normalize();}
\DoxyCodeLine{01846\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01847\ \ \ \ \ \}\ pQuatUpdateFun;}
\DoxyCodeLine{01849\ }
\DoxyCodeLine{01850\ \ \ \ \ \textcolor{comment}{//pQuatUpdateFun(getBaseOmega(),\ m\_baseQuat,\ true,\ dt);}}
\DoxyCodeLine{01851\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01852\ \ \ \ \ \textcolor{keywordflow}{if}(!isBaseKinematic())}
\DoxyCodeLine{01853\ \ \ \ \ \{}
\DoxyCodeLine{01854\ \ \ \ \ \ \ \ \ btScalar\ *pBaseQuat\ =\ pq\ ?\ pq\ :\ m\_baseQuat;}
\DoxyCodeLine{01855\ \ \ \ \ \ \ \ \ btScalar\ *pBaseOmega\ =\ pqd\ ?\ pqd\ :\ \&m\_realBuf[0];\ \ \textcolor{comment}{//note:\ the\ !pqd\ case\ assumes\ m\_realBuf\ starts\ with\ base\ omega\ (should\ be\ wrapped\ for\ safety)}}
\DoxyCodeLine{01856\ \ \ \ \ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{01857\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ baseQuat;}
\DoxyCodeLine{01858\ \ \ \ \ \ \ \ \ baseQuat.setValue(pBaseQuat[0],\ pBaseQuat[1],\ pBaseQuat[2],\ pBaseQuat[3]);}
\DoxyCodeLine{01859\ \ \ \ \ \ \ \ \ btVector3\ baseOmega;}
\DoxyCodeLine{01860\ \ \ \ \ \ \ \ \ baseOmega.setValue(pBaseOmega[0],\ pBaseOmega[1],\ pBaseOmega[2]);}
\DoxyCodeLine{01861\ \ \ \ \ \ \ \ \ pQuatUpdateFun(baseOmega,\ baseQuat,\ \textcolor{keyword}{true},\ dt);}
\DoxyCodeLine{01862\ \ \ \ \ \ \ \ \ pBaseQuat[0]\ =\ baseQuat.x();}
\DoxyCodeLine{01863\ \ \ \ \ \ \ \ \ pBaseQuat[1]\ =\ baseQuat.y();}
\DoxyCodeLine{01864\ \ \ \ \ \ \ \ \ pBaseQuat[2]\ =\ baseQuat.z();}
\DoxyCodeLine{01865\ \ \ \ \ \ \ \ \ pBaseQuat[3]\ =\ baseQuat.w();}
\DoxyCodeLine{01866\ }
\DoxyCodeLine{01867\ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}pBaseOmega\ =\ \%.4f\ \%.4f\ \%.4f\(\backslash\)n"{},\ pBaseOmega-\/>x(),\ pBaseOmega-\/>y(),\ pBaseOmega-\/>z());}}
\DoxyCodeLine{01868\ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}pBaseVel\ =\ \%.4f\ \%.4f\ \%.4f\(\backslash\)n"{},\ pBaseVel-\/>x(),\ pBaseVel-\/>y(),\ pBaseVel-\/>z());}}
\DoxyCodeLine{01869\ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}baseQuat\ =\ \%.4f\ \%.4f\ \%.4f\ \%.4f\(\backslash\)n"{},\ pBaseQuat-\/>x(),\ pBaseQuat-\/>y(),\ pBaseQuat-\/>z(),\ pBaseQuat-\/>w());}}
\DoxyCodeLine{01870\ \ \ \ \ \}}
\DoxyCodeLine{01871\ }
\DoxyCodeLine{01872\ \ \ \ \ \textcolor{keywordflow}{if}\ (pq)}
\DoxyCodeLine{01873\ \ \ \ \ \ \ \ \ pq\ +=\ 7;}
\DoxyCodeLine{01874\ \ \ \ \ \textcolor{keywordflow}{if}\ (pqd)}
\DoxyCodeLine{01875\ \ \ \ \ \ \ \ \ pqd\ +=\ 6;}
\DoxyCodeLine{01876\ }
\DoxyCodeLine{01877\ \ \ \ \ \textcolor{comment}{//\ Finally\ we\ can\ update\ m\_jointPos\ for\ each\ of\ the\ m\_links}}
\DoxyCodeLine{01878\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{01879\ \ \ \ \ \{}
\DoxyCodeLine{01880\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(m\_links[i].m\_collider\ \&\&\ m\_links[i].m\_collider-\/>isStaticOrKinematic()))}
\DoxyCodeLine{01881\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01882\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ *pJointPos;}
\DoxyCodeLine{01883\ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos=\ (pq\ ?\ pq\ :\ \&m\_links[i].m\_jointPos[0]);}
\DoxyCodeLine{01884\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{01885\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ *pJointVel\ =\ (pqd\ ?\ pqd\ :\ getJointVelMultiDof(i));}
\DoxyCodeLine{01886\ }
\DoxyCodeLine{01887\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (m\_links[i].m\_jointType)}
\DoxyCodeLine{01888\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01889\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePrismatic:}
\DoxyCodeLine{01890\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eRevolute:}
\DoxyCodeLine{01891\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01892\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//reset\ to\ current\ pos}}
\DoxyCodeLine{01893\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ jointVel\ =\ pJointVel[0];}
\DoxyCodeLine{01894\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[0]\ +=\ dt\ *\ jointVel;}
\DoxyCodeLine{01895\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01896\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01897\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eSpherical:}
\DoxyCodeLine{01898\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01899\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//reset\ to\ current\ pos}}
\DoxyCodeLine{01900\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ jointVel;}
\DoxyCodeLine{01901\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ jointVel.setValue(pJointVel[0],\ pJointVel[1],\ pJointVel[2]);}
\DoxyCodeLine{01902\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_quaternion}{btQuaternion}}\ jointOri;}
\DoxyCodeLine{01903\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ jointOri.setValue(pJointPos[0],\ pJointPos[1],\ pJointPos[2],\ pJointPos[3]);}
\DoxyCodeLine{01904\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pQuatUpdateFun(jointVel,\ jointOri,\ \textcolor{keyword}{false},\ dt);}
\DoxyCodeLine{01905\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[0]\ =\ jointOri.x();}
\DoxyCodeLine{01906\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[1]\ =\ jointOri.y();}
\DoxyCodeLine{01907\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[2]\ =\ jointOri.z();}
\DoxyCodeLine{01908\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[3]\ =\ jointOri.w();}
\DoxyCodeLine{01909\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01910\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01911\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePlanar:}
\DoxyCodeLine{01912\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01913\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[0]\ +=\ dt\ *\ getJointVelMultiDof(i)[0];}
\DoxyCodeLine{01914\ }
\DoxyCodeLine{01915\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ q0\_coors\_qd1qd2\ =\ getJointVelMultiDof(i)[1]\ *\ m\_links[i].getAxisBottom(1)\ +\ getJointVelMultiDof(i)[2]\ *\ m\_links[i].getAxisBottom(2);}
\DoxyCodeLine{01916\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ no\_q0\_coors\_qd1qd2\ =\ quatRotate(\mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(m\_links[i].getAxisTop(0),\ pJointPos[0]),\ q0\_coors\_qd1qd2);}
\DoxyCodeLine{01917\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[1]\ +=\ m\_links[i].getAxisBottom(1).dot(no\_q0\_coors\_qd1qd2)\ *\ dt;}
\DoxyCodeLine{01918\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pJointPos[2]\ +=\ m\_links[i].getAxisBottom(2).dot(no\_q0\_coors\_qd1qd2)\ *\ dt;}
\DoxyCodeLine{01919\ }
\DoxyCodeLine{01920\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{01921\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01922\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{01923\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{01924\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01925\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01926\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{01927\ }
\DoxyCodeLine{01928\ \ \ \ \ \ \ \ \ m\_links[i].updateCacheMultiDof(pq);}
\DoxyCodeLine{01929\ }
\DoxyCodeLine{01930\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pq)}
\DoxyCodeLine{01931\ \ \ \ \ \ \ \ \ \ \ \ \ pq\ +=\ m\_links[i].m\_posVarCount;}
\DoxyCodeLine{01932\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pqd)}
\DoxyCodeLine{01933\ \ \ \ \ \ \ \ \ \ \ \ \ pqd\ +=\ m\_links[i].m\_dofCount;}
\DoxyCodeLine{01934\ \ \ \ \ \}}
\DoxyCodeLine{01935\ \}}
\DoxyCodeLine{01936\ }
\DoxyCodeLine{01937\ \textcolor{keywordtype}{void}\ btMultiBody::fillConstraintJacobianMultiDof(\textcolor{keywordtype}{int}\ link,}
\DoxyCodeLine{01938\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&contact\_point,}
\DoxyCodeLine{01939\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&normal\_ang,}
\DoxyCodeLine{01940\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&normal\_lin,}
\DoxyCodeLine{01941\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ *jac,}
\DoxyCodeLine{01942\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btScalar>}}\ \&scratch\_r1,}
\DoxyCodeLine{01943\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btVector3>}}\ \&scratch\_v,}
\DoxyCodeLine{01944\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btMatrix3x3>}}\ \&scratch\_m)\textcolor{keyword}{\ const}}
\DoxyCodeLine{01945\ \textcolor{keyword}{}\{}
\DoxyCodeLine{01946\ \ \ \ \ \textcolor{comment}{//\ temporary\ space}}
\DoxyCodeLine{01947\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{01948\ \ \ \ \ \textcolor{keywordtype}{int}\ m\_dofCount\ =\ getNumDofs();}
\DoxyCodeLine{01949\ \ \ \ \ scratch\_v.resize(3\ *\ num\_links\ +\ 3);\ \ \textcolor{comment}{//(num\_links\ +\ base)\ offsets\ +\ (num\_links\ +\ base)\ normals\_lin\ +\ (num\_links\ +\ base)\ normals\_ang}}
\DoxyCodeLine{01950\ \ \ \ \ scratch\_m.resize(num\_links\ +\ 1);}
\DoxyCodeLine{01951\ }
\DoxyCodeLine{01952\ \ \ \ \ btVector3\ *v\_ptr\ =\ \&scratch\_v[0];}
\DoxyCodeLine{01953\ \ \ \ \ btVector3\ *p\_minus\_com\_local\ =\ v\_ptr;}
\DoxyCodeLine{01954\ \ \ \ \ v\_ptr\ +=\ num\_links\ +\ 1;}
\DoxyCodeLine{01955\ \ \ \ \ btVector3\ *n\_local\_lin\ =\ v\_ptr;}
\DoxyCodeLine{01956\ \ \ \ \ v\_ptr\ +=\ num\_links\ +\ 1;}
\DoxyCodeLine{01957\ \ \ \ \ btVector3\ *n\_local\_ang\ =\ v\_ptr;}
\DoxyCodeLine{01958\ \ \ \ \ v\_ptr\ +=\ num\_links\ +\ 1;}
\DoxyCodeLine{01959\ \ \ \ \ btAssert(v\_ptr\ -\/\ \&scratch\_v[0]\ ==\ scratch\_v.\mbox{\hyperlink{classbt_aligned_object_array_a31de8d83d29c6edd1493fc583091194c}{size}}());}
\DoxyCodeLine{01960\ }
\DoxyCodeLine{01961\ \ \ \ \ \textcolor{comment}{//scratch\_r.resize(m\_dofCount);}}
\DoxyCodeLine{01962\ \ \ \ \ \textcolor{comment}{//btScalar\ *results\ =\ m\_dofCount\ >\ 0\ ?\ \&scratch\_r[0]\ :\ 0;}}
\DoxyCodeLine{01963\ }
\DoxyCodeLine{01964\ \ \ \ \ scratch\_r1.resize(m\_dofCount+num\_links);}
\DoxyCodeLine{01965\ \ \ \ \ btScalar\ *\ results\ =\ m\_dofCount\ >\ 0\ ?\ \&scratch\_r1[0]\ :\ 0;}
\DoxyCodeLine{01966\ \ \ \ \ btScalar*\ links\ =\ num\_links?\ \&scratch\_r1[m\_dofCount]\ :\ 0;}
\DoxyCodeLine{01967\ \ \ \ \ \textcolor{keywordtype}{int}\ numLinksChildToRoot=0;}
\DoxyCodeLine{01968\ \ \ \ \ \textcolor{keywordtype}{int}\ l\ =\ link;}
\DoxyCodeLine{01969\ \ \ \ \ \textcolor{keywordflow}{while}\ (l\ !=\ -\/1)}
\DoxyCodeLine{01970\ \ \ \ \ \{}
\DoxyCodeLine{01971\ \ \ \ \ \ \ \ \ links[numLinksChildToRoot++]=l;}
\DoxyCodeLine{01972\ \ \ \ \ \ \ \ \ l\ =\ m\_links[l].m\_parent;}
\DoxyCodeLine{01973\ \ \ \ \ \}}
\DoxyCodeLine{01974\ \ \ \ \ }
\DoxyCodeLine{01975\ \ \ \ \ btMatrix3x3\ *rot\_from\_world\ =\ \&scratch\_m[0];}
\DoxyCodeLine{01976\ }
\DoxyCodeLine{01977\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ p\_minus\_com\_world\ =\ contact\_point\ -\/\ m\_basePos;}
\DoxyCodeLine{01978\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&normal\_lin\_world\ =\ normal\_lin;\ \ \textcolor{comment}{//convenience}}
\DoxyCodeLine{01979\ \ \ \ \ \textcolor{keyword}{const}\ btVector3\ \&normal\_ang\_world\ =\ normal\_ang;}
\DoxyCodeLine{01980\ }
\DoxyCodeLine{01981\ \ \ \ \ rot\_from\_world[0]\ =\ btMatrix3x3(m\_baseQuat);}
\DoxyCodeLine{01982\ }
\DoxyCodeLine{01983\ \ \ \ \ \textcolor{comment}{//\ omega\ coeffients\ first.}}
\DoxyCodeLine{01984\ \ \ \ \ btVector3\ omega\_coeffs\_world;}
\DoxyCodeLine{01985\ \ \ \ \ omega\_coeffs\_world\ =\ p\_minus\_com\_world.cross(normal\_lin\_world);}
\DoxyCodeLine{01986\ \ \ \ \ jac[0]\ =\ omega\_coeffs\_world[0]\ +\ normal\_ang\_world[0];}
\DoxyCodeLine{01987\ \ \ \ \ jac[1]\ =\ omega\_coeffs\_world[1]\ +\ normal\_ang\_world[1];}
\DoxyCodeLine{01988\ \ \ \ \ jac[2]\ =\ omega\_coeffs\_world[2]\ +\ normal\_ang\_world[2];}
\DoxyCodeLine{01989\ \ \ \ \ \textcolor{comment}{//\ then\ v\ coefficients}}
\DoxyCodeLine{01990\ \ \ \ \ jac[3]\ =\ normal\_lin\_world[0];}
\DoxyCodeLine{01991\ \ \ \ \ jac[4]\ =\ normal\_lin\_world[1];}
\DoxyCodeLine{01992\ \ \ \ \ jac[5]\ =\ normal\_lin\_world[2];}
\DoxyCodeLine{01993\ }
\DoxyCodeLine{01994\ \ \ \ \ \textcolor{comment}{//create\ link-\/local\ versions\ of\ p\_minus\_com\ and\ normal}}
\DoxyCodeLine{01995\ \ \ \ \ p\_minus\_com\_local[0]\ =\ rot\_from\_world[0]\ *\ p\_minus\_com\_world;}
\DoxyCodeLine{01996\ \ \ \ \ n\_local\_lin[0]\ =\ rot\_from\_world[0]\ *\ normal\_lin\_world;}
\DoxyCodeLine{01997\ \ \ \ \ n\_local\_ang[0]\ =\ rot\_from\_world[0]\ *\ normal\_ang\_world;}
\DoxyCodeLine{01998\ }
\DoxyCodeLine{01999\ \ \ \ \ \textcolor{comment}{//\ Set\ remaining\ jac\ values\ to\ zero\ for\ now.}}
\DoxyCodeLine{02000\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 6;\ i\ <\ 6\ +\ m\_dofCount;\ ++i)}
\DoxyCodeLine{02001\ \ \ \ \ \{}
\DoxyCodeLine{02002\ \ \ \ \ \ \ \ \ jac[i]\ =\ 0;}
\DoxyCodeLine{02003\ \ \ \ \ \}}
\DoxyCodeLine{02004\ }
\DoxyCodeLine{02005\ \ \ \ \ \textcolor{comment}{//\ Qdot\ coefficients,\ if\ necessary.}}
\DoxyCodeLine{02006\ \ \ \ \ \textcolor{keywordflow}{if}\ (num\_links\ >\ 0\ \&\&\ link\ >\ -\/1)}
\DoxyCodeLine{02007\ \ \ \ \ \{}
\DoxyCodeLine{02008\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO:\ (Also,\ we\ are\ making\ 3\ separate\ calls\ to\ this\ function,\ for\ the\ normal\ \&\ the\ 2\ friction\ directions,}}
\DoxyCodeLine{02009\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ which\ is\ resulting\ in\ repeated\ work\ being\ done...)}}
\DoxyCodeLine{02010\ }
\DoxyCodeLine{02011\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ calculate\ required\ normals\ \&\ positions\ in\ the\ local\ frames.}}
\DoxyCodeLine{02012\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ a\ =\ 0;\ a\ <\ numLinksChildToRoot;\ a++)}
\DoxyCodeLine{02013\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02014\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ i\ =\ links[numLinksChildToRoot-\/1-\/a];}
\DoxyCodeLine{02015\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ transform\ to\ local\ frame}}
\DoxyCodeLine{02016\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ m\_links[i].m\_parent;}
\DoxyCodeLine{02017\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ btMatrix3x3\ mtx(m\_links[i].m\_cachedRotParentToThis);}
\DoxyCodeLine{02018\ \ \ \ \ \ \ \ \ \ \ \ \ rot\_from\_world[i\ +\ 1]\ =\ mtx\ *\ rot\_from\_world[parent\ +\ 1];}
\DoxyCodeLine{02019\ }
\DoxyCodeLine{02020\ \ \ \ \ \ \ \ \ \ \ \ \ n\_local\_lin[i\ +\ 1]\ =\ mtx\ *\ n\_local\_lin[parent\ +\ 1];}
\DoxyCodeLine{02021\ \ \ \ \ \ \ \ \ \ \ \ \ n\_local\_ang[i\ +\ 1]\ =\ mtx\ *\ n\_local\_ang[parent\ +\ 1];}
\DoxyCodeLine{02022\ \ \ \ \ \ \ \ \ \ \ \ \ p\_minus\_com\_local[i\ +\ 1]\ =\ mtx\ *\ p\_minus\_com\_local[parent\ +\ 1]\ -\/\ m\_links[i].m\_cachedRVector;}
\DoxyCodeLine{02023\ }
\DoxyCodeLine{02024\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ calculate\ the\ jacobian\ entry}}
\DoxyCodeLine{02025\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (m\_links[i].m\_jointType)}
\DoxyCodeLine{02026\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02027\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eRevolute:}
\DoxyCodeLine{02028\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02029\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset]\ =\ n\_local\_lin[i\ +\ 1].dot(m\_links[i].getAxisTop(0).cross(p\_minus\_com\_local[i\ +\ 1])\ +\ m\_links[i].getAxisBottom(0));}
\DoxyCodeLine{02030\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset]\ +=\ n\_local\_ang[i\ +\ 1].dot(m\_links[i].getAxisTop(0));}
\DoxyCodeLine{02031\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02032\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02033\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePrismatic:}
\DoxyCodeLine{02034\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02035\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset]\ =\ n\_local\_lin[i\ +\ 1].dot(m\_links[i].getAxisBottom(0));}
\DoxyCodeLine{02036\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02037\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02038\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::eSpherical:}
\DoxyCodeLine{02039\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02040\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 0]\ =\ n\_local\_lin[i\ +\ 1].dot(m\_links[i].getAxisTop(0).cross(p\_minus\_com\_local[i\ +\ 1])\ +\ m\_links[i].getAxisBottom(0));}
\DoxyCodeLine{02041\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 1]\ =\ n\_local\_lin[i\ +\ 1].dot(m\_links[i].getAxisTop(1).cross(p\_minus\_com\_local[i\ +\ 1])\ +\ m\_links[i].getAxisBottom(1));}
\DoxyCodeLine{02042\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 2]\ =\ n\_local\_lin[i\ +\ 1].dot(m\_links[i].getAxisTop(2).cross(p\_minus\_com\_local[i\ +\ 1])\ +\ m\_links[i].getAxisBottom(2));}
\DoxyCodeLine{02043\ }
\DoxyCodeLine{02044\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 0]\ +=\ n\_local\_ang[i\ +\ 1].dot(m\_links[i].getAxisTop(0));}
\DoxyCodeLine{02045\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 1]\ +=\ n\_local\_ang[i\ +\ 1].dot(m\_links[i].getAxisTop(1));}
\DoxyCodeLine{02046\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 2]\ +=\ n\_local\_ang[i\ +\ 1].dot(m\_links[i].getAxisTop(2));}
\DoxyCodeLine{02047\ }
\DoxyCodeLine{02048\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02049\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02050\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ btMultibodyLink::ePlanar:}
\DoxyCodeLine{02051\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02052\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 0]\ =\ n\_local\_lin[i\ +\ 1].dot(m\_links[i].getAxisTop(0).cross(p\_minus\_com\_local[i\ +\ 1]));\ \ \textcolor{comment}{//\ +\ m\_links[i].getAxisBottom(0));}}
\DoxyCodeLine{02053\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 1]\ =\ n\_local\_lin[i\ +\ 1].dot(m\_links[i].getAxisBottom(1));}
\DoxyCodeLine{02054\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results[m\_links[i].m\_dofOffset\ +\ 2]\ =\ n\_local\_lin[i\ +\ 1].dot(m\_links[i].getAxisBottom(2));}
\DoxyCodeLine{02055\ }
\DoxyCodeLine{02056\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{02057\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{02059\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02060\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02061\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02062\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02063\ }
\DoxyCodeLine{02064\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ copy\ through\ to\ output.}}
\DoxyCodeLine{02065\ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}jac[\%d]\ =\ "{},\ link);}}
\DoxyCodeLine{02066\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{while}\ (link\ !=\ -\/1)}
\DoxyCodeLine{02067\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02068\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ m\_links[link].m\_dofCount;\ ++dof)}
\DoxyCodeLine{02069\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ jac[6\ +\ m\_links[link].m\_dofOffset\ +\ dof]\ =\ results[m\_links[link].m\_dofOffset\ +\ dof];}
\DoxyCodeLine{02071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}\%.2f\(\backslash\)t"{},\ jac[6\ +\ m\_links[link].m\_dofOffset\ +\ dof]);}}
\DoxyCodeLine{02072\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02073\ }
\DoxyCodeLine{02074\ \ \ \ \ \ \ \ \ \ \ \ \ link\ =\ m\_links[link].m\_parent;}
\DoxyCodeLine{02075\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02076\ \ \ \ \ \ \ \ \ \textcolor{comment}{//printf("{}]\(\backslash\)n"{});}}
\DoxyCodeLine{02077\ \ \ \ \ \}}
\DoxyCodeLine{02078\ \}}
\DoxyCodeLine{02079\ }
\DoxyCodeLine{02080\ \textcolor{keywordtype}{void}\ btMultiBody::wakeUp()}
\DoxyCodeLine{02081\ \{}
\DoxyCodeLine{02082\ \ \ \ \ m\_sleepTimer\ =\ 0;}
\DoxyCodeLine{02083\ \ \ \ \ m\_awake\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02084\ \}}
\DoxyCodeLine{02085\ }
\DoxyCodeLine{02086\ \textcolor{keywordtype}{void}\ btMultiBody::goToSleep()}
\DoxyCodeLine{02087\ \{}
\DoxyCodeLine{02088\ \ \ \ \ m\_awake\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{02089\ \}}
\DoxyCodeLine{02090\ }
\DoxyCodeLine{02091\ \textcolor{keywordtype}{void}\ btMultiBody::checkMotionAndSleepIfRequired(btScalar\ timestep)}
\DoxyCodeLine{02092\ \{}
\DoxyCodeLine{02093\ \ \ \ \ \textcolor{keyword}{extern}\ \textcolor{keywordtype}{bool}\ gDisableDeactivation;}
\DoxyCodeLine{02094\ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_canSleep\ ||\ gDisableDeactivation)}
\DoxyCodeLine{02095\ \ \ \ \ \{}
\DoxyCodeLine{02096\ \ \ \ \ \ \ \ \ m\_awake\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{02097\ \ \ \ \ \ \ \ \ m\_sleepTimer\ =\ 0;}
\DoxyCodeLine{02098\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{02099\ \ \ \ \ \}}
\DoxyCodeLine{02100\ }
\DoxyCodeLine{02101\ \ \ \ \ }
\DoxyCodeLine{02102\ }
\DoxyCodeLine{02103\ \ \ \ \ \textcolor{comment}{//\ motion\ is\ computed\ as\ omega\string^2\ +\ v\string^2\ +\ (sum\ of\ squares\ of\ joint\ velocities)}}
\DoxyCodeLine{02104\ \ \ \ \ btScalar\ motion\ =\ 0;}
\DoxyCodeLine{02105\ \ \ \ \ \{}
\DoxyCodeLine{02106\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 6\ +\ m\_dofCount;\ ++i)}
\DoxyCodeLine{02107\ \ \ \ \ \ \ \ \ \ \ \ \ motion\ +=\ m\_realBuf[i]\ *\ m\_realBuf[i];}
\DoxyCodeLine{02108\ \ \ \ \ \}}
\DoxyCodeLine{02109\ }
\DoxyCodeLine{02110\ \ \ \ \ \textcolor{keywordflow}{if}\ (motion\ <\ m\_sleepEpsilon)}
\DoxyCodeLine{02111\ \ \ \ \ \{}
\DoxyCodeLine{02112\ \ \ \ \ \ \ \ \ m\_sleepTimer\ +=\ timestep;}
\DoxyCodeLine{02113\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_sleepTimer\ >\ m\_sleepTimeout)}
\DoxyCodeLine{02114\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02115\ \ \ \ \ \ \ \ \ \ \ \ \ goToSleep();}
\DoxyCodeLine{02116\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02117\ \ \ \ \ \}}
\DoxyCodeLine{02118\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02119\ \ \ \ \ \{}
\DoxyCodeLine{02120\ \ \ \ \ \ \ \ \ m\_sleepTimer\ =\ 0;}
\DoxyCodeLine{02121\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_canWakeup)}
\DoxyCodeLine{02122\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02123\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!m\_awake)}
\DoxyCodeLine{02124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ wakeUp();}
\DoxyCodeLine{02125\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02126\ \ \ \ \ \}}
\DoxyCodeLine{02127\ \}}
\DoxyCodeLine{02128\ }
\DoxyCodeLine{02129\ \textcolor{keywordtype}{void}\ btMultiBody::forwardKinematics(\mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btQuaternion>}}\ \&world\_to\_local,\ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btVector3>}}\ \&local\_origin)}
\DoxyCodeLine{02130\ \{}
\DoxyCodeLine{02131\ \ \ \ \ \textcolor{keywordtype}{int}\ num\_links\ =\ getNumLinks();}
\DoxyCodeLine{02132\ }
\DoxyCodeLine{02133\ \ \ \ \ \textcolor{comment}{//\ Cached\ 3x3\ rotation\ matrices\ from\ parent\ frame\ to\ this\ frame.}}
\DoxyCodeLine{02134\ \ \ \ \ btMatrix3x3\ *rot\_from\_parent\ =\ (btMatrix3x3\ *)\&m\_matrixBuf[0];}
\DoxyCodeLine{02135\ }
\DoxyCodeLine{02136\ \ \ \ \ rot\_from\_parent[0]\ =\ btMatrix3x3(m\_baseQuat);\ \ \textcolor{comment}{//m\_baseQuat\ assumed\ to\ be\ alias!?}}
\DoxyCodeLine{02137\ }
\DoxyCodeLine{02138\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_links;\ ++i)}
\DoxyCodeLine{02139\ \ \ \ \ \{}
\DoxyCodeLine{02140\ \ \ \ \ \ \ \ \ rot\_from\_parent[i\ +\ 1]\ =\ btMatrix3x3(m\_links[i].m\_cachedRotParentToThis);}
\DoxyCodeLine{02141\ \ \ \ \ \}}
\DoxyCodeLine{02142\ }
\DoxyCodeLine{02143\ \ \ \ \ \textcolor{keywordtype}{int}\ nLinks\ =\ getNumLinks();}
\DoxyCodeLine{02145\ \ \ \ \ world\_to\_local.resize(nLinks\ +\ 1);}
\DoxyCodeLine{02146\ \ \ \ \ local\_origin.resize(nLinks\ +\ 1);}
\DoxyCodeLine{02147\ }
\DoxyCodeLine{02148\ \ \ \ \ world\_to\_local[0]\ =\ getWorldToBaseRot();}
\DoxyCodeLine{02149\ \ \ \ \ local\_origin[0]\ =\ getBasePos();}
\DoxyCodeLine{02150\ }
\DoxyCodeLine{02151\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ getNumLinks();\ k++)}
\DoxyCodeLine{02152\ \ \ \ \ \{}
\DoxyCodeLine{02153\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ getParent(k);}
\DoxyCodeLine{02154\ \ \ \ \ \ \ \ \ world\_to\_local[k\ +\ 1]\ =\ getParentToLocalRot(k)\ *\ world\_to\_local[parent\ +\ 1];}
\DoxyCodeLine{02155\ \ \ \ \ \ \ \ \ local\_origin[k\ +\ 1]\ =\ local\_origin[parent\ +\ 1]\ +\ (quatRotate(world\_to\_local[k\ +\ 1].inverse(),\ getRVector(k)));}
\DoxyCodeLine{02156\ \ \ \ \ \}}
\DoxyCodeLine{02157\ }
\DoxyCodeLine{02158\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ link\ =\ 0;\ link\ <\ getNumLinks();\ link++)}
\DoxyCodeLine{02159\ \ \ \ \ \{}
\DoxyCodeLine{02160\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ index\ =\ link\ +\ 1;}
\DoxyCodeLine{02161\ }
\DoxyCodeLine{02162\ \ \ \ \ \ \ \ \ btVector3\ posr\ =\ local\_origin[index];}
\DoxyCodeLine{02163\ \ \ \ \ \ \ \ \ btScalar\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}[4]\ =\ \{-\/world\_to\_local[index].x(),\ -\/world\_to\_local[index].y(),\ -\/world\_to\_local[index].z(),\ world\_to\_local[index].w()\};}
\DoxyCodeLine{02164\ \ \ \ \ \ \ \ \ btTransform\ tr;}
\DoxyCodeLine{02165\ \ \ \ \ \ \ \ \ tr.setIdentity();}
\DoxyCodeLine{02166\ \ \ \ \ \ \ \ \ tr.setOrigin(posr);}
\DoxyCodeLine{02167\ \ \ \ \ \ \ \ \ tr.setRotation(\mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(quat[0],\ quat[1],\ quat[2],\ quat[3]));}
\DoxyCodeLine{02168\ \ \ \ \ \ \ \ \ getLink(link).m\_cachedWorldTransform\ =\ tr;}
\DoxyCodeLine{02169\ \ \ \ \ \}}
\DoxyCodeLine{02170\ \}}
\DoxyCodeLine{02171\ }
\DoxyCodeLine{02172\ \textcolor{keywordtype}{void}\ btMultiBody::updateCollisionObjectWorldTransforms(\mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btQuaternion>}}\ \&world\_to\_local,\ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btVector3>}}\ \&local\_origin)}
\DoxyCodeLine{02173\ \{}
\DoxyCodeLine{02174\ \ \ \ \ world\_to\_local.resize(getNumLinks()\ +\ 1);}
\DoxyCodeLine{02175\ \ \ \ \ local\_origin.resize(getNumLinks()\ +\ 1);}
\DoxyCodeLine{02176\ }
\DoxyCodeLine{02177\ \ \ \ \ world\_to\_local[0]\ =\ getWorldToBaseRot();}
\DoxyCodeLine{02178\ \ \ \ \ local\_origin[0]\ =\ getBasePos();}
\DoxyCodeLine{02179\ }
\DoxyCodeLine{02180\ \ \ \ \ \textcolor{keywordflow}{if}\ (getBaseCollider())}
\DoxyCodeLine{02181\ \ \ \ \ \{}
\DoxyCodeLine{02182\ \ \ \ \ \ \ \ \ btVector3\ posr\ =\ local\_origin[0];}
\DoxyCodeLine{02183\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ float\ pos[4]=\{posr.x(),posr.y(),posr.z(),1\};}}
\DoxyCodeLine{02184\ \ \ \ \ \ \ \ \ btScalar\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}[4]\ =\ \{-\/world\_to\_local[0].x(),\ -\/world\_to\_local[0].y(),\ -\/world\_to\_local[0].z(),\ world\_to\_local[0].w()\};}
\DoxyCodeLine{02185\ \ \ \ \ \ \ \ \ btTransform\ tr;}
\DoxyCodeLine{02186\ \ \ \ \ \ \ \ \ tr.setIdentity();}
\DoxyCodeLine{02187\ \ \ \ \ \ \ \ \ tr.setOrigin(posr);}
\DoxyCodeLine{02188\ \ \ \ \ \ \ \ \ tr.setRotation(\mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(quat[0],\ quat[1],\ quat[2],\ quat[3]));}
\DoxyCodeLine{02189\ }
\DoxyCodeLine{02190\ \ \ \ \ \ \ \ \ getBaseCollider()-\/>setWorldTransform(tr);}
\DoxyCodeLine{02191\ \ \ \ \ \ \ \ \ getBaseCollider()-\/>setInterpolationWorldTransform(tr);}
\DoxyCodeLine{02192\ \ \ \ \ \}}
\DoxyCodeLine{02193\ }
\DoxyCodeLine{02194\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ getNumLinks();\ k++)}
\DoxyCodeLine{02195\ \ \ \ \ \{}
\DoxyCodeLine{02196\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ getParent(k);}
\DoxyCodeLine{02197\ \ \ \ \ \ \ \ \ world\_to\_local[k\ +\ 1]\ =\ getParentToLocalRot(k)\ *\ world\_to\_local[parent\ +\ 1];}
\DoxyCodeLine{02198\ \ \ \ \ \ \ \ \ local\_origin[k\ +\ 1]\ =\ local\_origin[parent\ +\ 1]\ +\ (quatRotate(world\_to\_local[k\ +\ 1].inverse(),\ getRVector(k)));}
\DoxyCodeLine{02199\ \ \ \ \ \}}
\DoxyCodeLine{02200\ }
\DoxyCodeLine{02201\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ m\ =\ 0;\ m\ <\ getNumLinks();\ m++)}
\DoxyCodeLine{02202\ \ \ \ \ \{}
\DoxyCodeLine{02203\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_multi_body_link_collider}{btMultiBodyLinkCollider}}\ *col\ =\ getLink(m).m\_collider;}
\DoxyCodeLine{02204\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (col)}
\DoxyCodeLine{02205\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02206\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ link\ =\ col-\/>m\_link;}
\DoxyCodeLine{02207\ \ \ \ \ \ \ \ \ \ \ \ \ btAssert(link\ ==\ m);}
\DoxyCodeLine{02208\ }
\DoxyCodeLine{02209\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ index\ =\ link\ +\ 1;}
\DoxyCodeLine{02210\ }
\DoxyCodeLine{02211\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ posr\ =\ local\_origin[index];}
\DoxyCodeLine{02212\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ float\ pos[4]=\{posr.x(),posr.y(),posr.z(),1\};}}
\DoxyCodeLine{02213\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}[4]\ =\ \{-\/world\_to\_local[index].x(),\ -\/world\_to\_local[index].y(),\ -\/world\_to\_local[index].z(),\ world\_to\_local[index].w()\};}
\DoxyCodeLine{02214\ \ \ \ \ \ \ \ \ \ \ \ \ btTransform\ tr;}
\DoxyCodeLine{02215\ \ \ \ \ \ \ \ \ \ \ \ \ tr.setIdentity();}
\DoxyCodeLine{02216\ \ \ \ \ \ \ \ \ \ \ \ \ tr.setOrigin(posr);}
\DoxyCodeLine{02217\ \ \ \ \ \ \ \ \ \ \ \ \ tr.setRotation(\mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(quat[0],\ quat[1],\ quat[2],\ quat[3]));}
\DoxyCodeLine{02218\ }
\DoxyCodeLine{02219\ \ \ \ \ \ \ \ \ \ \ \ \ col-\/>setWorldTransform(tr);}
\DoxyCodeLine{02220\ \ \ \ \ \ \ \ \ \ \ \ \ col-\/>setInterpolationWorldTransform(tr);}
\DoxyCodeLine{02221\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02222\ \ \ \ \ \}}
\DoxyCodeLine{02223\ \}}
\DoxyCodeLine{02224\ }
\DoxyCodeLine{02225\ \textcolor{keywordtype}{void}\ btMultiBody::updateCollisionObjectInterpolationWorldTransforms(\mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btQuaternion>}}\ \&world\_to\_local,\ \mbox{\hyperlink{classbt_aligned_object_array}{btAlignedObjectArray<btVector3>}}\ \&local\_origin)}
\DoxyCodeLine{02226\ \{}
\DoxyCodeLine{02227\ \ \ \ \ world\_to\_local.resize(getNumLinks()\ +\ 1);}
\DoxyCodeLine{02228\ \ \ \ \ local\_origin.resize(getNumLinks()\ +\ 1);}
\DoxyCodeLine{02229\ \ \ \ \ }
\DoxyCodeLine{02230\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}(isBaseKinematic())\{}
\DoxyCodeLine{02231\ \ \ \ \ \ \ \ \ world\_to\_local[0]\ =\ getWorldToBaseRot();}
\DoxyCodeLine{02232\ \ \ \ \ \ \ \ \ local\_origin[0]\ =\ getBasePos();}
\DoxyCodeLine{02233\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02234\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02235\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02236\ \ \ \ \ \ \ \ \ world\_to\_local[0]\ =\ getInterpolateWorldToBaseRot();}
\DoxyCodeLine{02237\ \ \ \ \ \ \ \ \ local\_origin[0]\ =\ getInterpolateBasePos();}
\DoxyCodeLine{02238\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02239\ \ \ \ \ }
\DoxyCodeLine{02240\ \ \ \ \ \textcolor{keywordflow}{if}\ (getBaseCollider())}
\DoxyCodeLine{02241\ \ \ \ \ \{}
\DoxyCodeLine{02242\ \ \ \ \ \ \ \ \ btVector3\ posr\ =\ local\_origin[0];}
\DoxyCodeLine{02243\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ float\ pos[4]=\{posr.x(),posr.y(),posr.z(),1\};}}
\DoxyCodeLine{02244\ \ \ \ \ \ \ \ \ btScalar\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}[4]\ =\ \{-\/world\_to\_local[0].x(),\ -\/world\_to\_local[0].y(),\ -\/world\_to\_local[0].z(),\ world\_to\_local[0].w()\};}
\DoxyCodeLine{02245\ \ \ \ \ \ \ \ \ btTransform\ tr;}
\DoxyCodeLine{02246\ \ \ \ \ \ \ \ \ tr.setIdentity();}
\DoxyCodeLine{02247\ \ \ \ \ \ \ \ \ tr.setOrigin(posr);}
\DoxyCodeLine{02248\ \ \ \ \ \ \ \ \ tr.setRotation(\mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(quat[0],\ quat[1],\ quat[2],\ quat[3]));}
\DoxyCodeLine{02249\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{02250\ \ \ \ \ \ \ \ \ getBaseCollider()-\/>setInterpolationWorldTransform(tr);}
\DoxyCodeLine{02251\ \ \ \ \ \}}
\DoxyCodeLine{02252\ \ \ \ \ }
\DoxyCodeLine{02253\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ k\ =\ 0;\ k\ <\ getNumLinks();\ k++)}
\DoxyCodeLine{02254\ \ \ \ \ \{}
\DoxyCodeLine{02255\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ parent\ =\ getParent(k);}
\DoxyCodeLine{02256\ \ \ \ \ \ \ \ \ world\_to\_local[k\ +\ 1]\ =\ getInterpolateParentToLocalRot(k)\ *\ world\_to\_local[parent\ +\ 1];}
\DoxyCodeLine{02257\ \ \ \ \ \ \ \ \ local\_origin[k\ +\ 1]\ =\ local\_origin[parent\ +\ 1]\ +\ (quatRotate(world\_to\_local[k\ +\ 1].inverse(),\ getInterpolateRVector(k)));}
\DoxyCodeLine{02258\ \ \ \ \ \}}
\DoxyCodeLine{02259\ \ \ \ \ }
\DoxyCodeLine{02260\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ m\ =\ 0;\ m\ <\ getNumLinks();\ m++)}
\DoxyCodeLine{02261\ \ \ \ \ \{}
\DoxyCodeLine{02262\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_multi_body_link_collider}{btMultiBodyLinkCollider}}\ *col\ =\ getLink(m).m\_collider;}
\DoxyCodeLine{02263\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (col)}
\DoxyCodeLine{02264\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02265\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ link\ =\ col-\/>m\_link;}
\DoxyCodeLine{02266\ \ \ \ \ \ \ \ \ \ \ \ \ btAssert(link\ ==\ m);}
\DoxyCodeLine{02267\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{02268\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ index\ =\ link\ +\ 1;}
\DoxyCodeLine{02269\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{02270\ \ \ \ \ \ \ \ \ \ \ \ \ btVector3\ posr\ =\ local\_origin[index];}
\DoxyCodeLine{02271\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ float\ pos[4]=\{posr.x(),posr.y(),posr.z(),1\};}}
\DoxyCodeLine{02272\ \ \ \ \ \ \ \ \ \ \ \ \ btScalar\ \mbox{\hyperlink{group__ext__quaternion__float_gac1f6a5957091b849730ea6f05a6b7ad6}{quat}}[4]\ =\ \{-\/world\_to\_local[index].x(),\ -\/world\_to\_local[index].y(),\ -\/world\_to\_local[index].z(),\ world\_to\_local[index].w()\};}
\DoxyCodeLine{02273\ \ \ \ \ \ \ \ \ \ \ \ \ btTransform\ tr;}
\DoxyCodeLine{02274\ \ \ \ \ \ \ \ \ \ \ \ \ tr.setIdentity();}
\DoxyCodeLine{02275\ \ \ \ \ \ \ \ \ \ \ \ \ tr.setOrigin(posr);}
\DoxyCodeLine{02276\ \ \ \ \ \ \ \ \ \ \ \ \ tr.setRotation(\mbox{\hyperlink{classbt_quaternion}{btQuaternion}}(quat[0],\ quat[1],\ quat[2],\ quat[3]));}
\DoxyCodeLine{02277\ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{02278\ \ \ \ \ \ \ \ \ \ \ \ \ col-\/>setInterpolationWorldTransform(tr);}
\DoxyCodeLine{02279\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02280\ \ \ \ \ \}}
\DoxyCodeLine{02281\ \}}
\DoxyCodeLine{02282\ }
\DoxyCodeLine{02283\ \textcolor{keywordtype}{int}\ btMultiBody::calculateSerializeBufferSize()\textcolor{keyword}{\ const}}
\DoxyCodeLine{02284\ \textcolor{keyword}{}\{}
\DoxyCodeLine{02285\ \ \ \ \ \textcolor{keywordtype}{int}\ sz\ =\ \textcolor{keyword}{sizeof}(btMultiBodyData);}
\DoxyCodeLine{02286\ \ \ \ \ \textcolor{keywordflow}{return}\ sz;}
\DoxyCodeLine{02287\ \}}
\DoxyCodeLine{02288\ }
\DoxyCodeLine{02290\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ *btMultiBody::serialize(\textcolor{keywordtype}{void}\ *dataBuffer,\ \textcolor{keyword}{class}\ \mbox{\hyperlink{classbt_serializer}{btSerializer}}\ *serializer)\textcolor{keyword}{\ const}}
\DoxyCodeLine{02291\ \textcolor{keyword}{}\{}
\DoxyCodeLine{02292\ \ \ \ \ btMultiBodyData\ *mbd\ =\ (btMultiBodyData\ *)dataBuffer;}
\DoxyCodeLine{02293\ \ \ \ \ getBasePos().serialize(mbd-\/>m\_baseWorldPosition);}
\DoxyCodeLine{02294\ \ \ \ \ getWorldToBaseRot().\mbox{\hyperlink{classbt_quaternion_ab2f4fcf35da5e846ceba91af625062f7}{inverse}}().\mbox{\hyperlink{classbt_quaternion_a54df750e6a69c4c5b186329662ee331f}{serialize}}(mbd-\/>m\_baseWorldOrientation);}
\DoxyCodeLine{02295\ \ \ \ \ getBaseVel().serialize(mbd-\/>m\_baseLinearVelocity);}
\DoxyCodeLine{02296\ \ \ \ \ getBaseOmega().serialize(mbd-\/>m\_baseAngularVelocity);}
\DoxyCodeLine{02297\ }
\DoxyCodeLine{02298\ \ \ \ \ mbd-\/>m\_baseMass\ =\ this-\/>getBaseMass();}
\DoxyCodeLine{02299\ \ \ \ \ getBaseInertia().serialize(mbd-\/>m\_baseInertia);}
\DoxyCodeLine{02300\ \ \ \ \ \{}
\DoxyCodeLine{02301\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ *name\ =\ (\textcolor{keywordtype}{char}\ *)serializer-\/>findNameForPointer(m\_baseName);}
\DoxyCodeLine{02302\ \ \ \ \ \ \ \ \ mbd-\/>m\_baseName\ =\ (\textcolor{keywordtype}{char}\ *)serializer-\/>getUniquePointer(name);}
\DoxyCodeLine{02303\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (mbd-\/>m\_baseName)}
\DoxyCodeLine{02304\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02305\ \ \ \ \ \ \ \ \ \ \ \ \ serializer-\/>serializeName(name);}
\DoxyCodeLine{02306\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02307\ \ \ \ \ \}}
\DoxyCodeLine{02308\ \ \ \ \ mbd-\/>m\_numLinks\ =\ this-\/>getNumLinks();}
\DoxyCodeLine{02309\ \ \ \ \ \textcolor{keywordflow}{if}\ (mbd-\/>m\_numLinks)}
\DoxyCodeLine{02310\ \ \ \ \ \{}
\DoxyCodeLine{02311\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ sz\ =\ \textcolor{keyword}{sizeof}(btMultiBodyLinkData);}
\DoxyCodeLine{02312\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ numElem\ =\ mbd-\/>m\_numLinks;}
\DoxyCodeLine{02313\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classbt_chunk}{btChunk}}\ *chunk\ =\ serializer-\/>allocate(sz,\ numElem);}
\DoxyCodeLine{02314\ \ \ \ \ \ \ \ \ btMultiBodyLinkData\ *memPtr\ =\ (btMultiBodyLinkData\ *)chunk-\/>m\_oldPtr;}
\DoxyCodeLine{02315\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ numElem;\ i++,\ memPtr++)}
\DoxyCodeLine{02316\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02317\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointType\ =\ getLink(i).m\_jointType;}
\DoxyCodeLine{02318\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_dofCount\ =\ getLink(i).m\_dofCount;}
\DoxyCodeLine{02319\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_posVarCount\ =\ getLink(i).m\_posVarCount;}
\DoxyCodeLine{02320\ }
\DoxyCodeLine{02321\ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).m\_inertiaLocal.serialize(memPtr-\/>m\_linkInertia);}
\DoxyCodeLine{02322\ }
\DoxyCodeLine{02323\ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).m\_absFrameTotVelocity.m\_topVec.serialize(memPtr-\/>m\_absFrameTotVelocityTop);}
\DoxyCodeLine{02324\ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).m\_absFrameTotVelocity.m\_bottomVec.serialize(memPtr-\/>m\_absFrameTotVelocityBottom);}
\DoxyCodeLine{02325\ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).m\_absFrameLocVelocity.m\_topVec.serialize(memPtr-\/>m\_absFrameLocVelocityTop);}
\DoxyCodeLine{02326\ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).m\_absFrameLocVelocity.m\_bottomVec.serialize(memPtr-\/>m\_absFrameLocVelocityBottom);}
\DoxyCodeLine{02327\ }
\DoxyCodeLine{02328\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_linkMass\ =\ getLink(i).m\_mass;}
\DoxyCodeLine{02329\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_parentIndex\ =\ getLink(i).m\_parent;}
\DoxyCodeLine{02330\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointDamping\ =\ getLink(i).m\_jointDamping;}
\DoxyCodeLine{02331\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointFriction\ =\ getLink(i).m\_jointFriction;}
\DoxyCodeLine{02332\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointLowerLimit\ =\ getLink(i).m\_jointLowerLimit;}
\DoxyCodeLine{02333\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointUpperLimit\ =\ getLink(i).m\_jointUpperLimit;}
\DoxyCodeLine{02334\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointMaxForce\ =\ getLink(i).m\_jointMaxForce;}
\DoxyCodeLine{02335\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointMaxVelocity\ =\ getLink(i).m\_jointMaxVelocity;}
\DoxyCodeLine{02336\ }
\DoxyCodeLine{02337\ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).m\_eVector.serialize(memPtr-\/>m\_parentComToThisPivotOffset);}
\DoxyCodeLine{02338\ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).m\_dVector.serialize(memPtr-\/>m\_thisPivotToThisComOffset);}
\DoxyCodeLine{02339\ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).m\_zeroRotParentToThis.\mbox{\hyperlink{classbt_quaternion_a54df750e6a69c4c5b186329662ee331f}{serialize}}(memPtr-\/>m\_zeroRotParentToThis);}
\DoxyCodeLine{02340\ \ \ \ \ \ \ \ \ \ \ \ \ btAssert(memPtr-\/>m\_dofCount\ <=\ 3);}
\DoxyCodeLine{02341\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ dof\ =\ 0;\ dof\ <\ getLink(i).m\_dofCount;\ dof++)}
\DoxyCodeLine{02342\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02343\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).getAxisBottom(dof).serialize(memPtr-\/>m\_jointAxisBottom[dof]);}
\DoxyCodeLine{02344\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ getLink(i).getAxisTop(dof).serialize(memPtr-\/>m\_jointAxisTop[dof]);}
\DoxyCodeLine{02345\ }
\DoxyCodeLine{02346\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointTorque[dof]\ =\ getLink(i).m\_jointTorque[dof];}
\DoxyCodeLine{02347\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointVel[dof]\ =\ getJointVelMultiDof(i)[dof];}
\DoxyCodeLine{02348\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02349\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ numPosVar\ =\ getLink(i).m\_posVarCount;}
\DoxyCodeLine{02350\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ posvar\ =\ 0;\ posvar\ <\ numPosVar;\ posvar++)}
\DoxyCodeLine{02351\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02352\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointPos[posvar]\ =\ getLink(i).m\_jointPos[posvar];}
\DoxyCodeLine{02353\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02354\ }
\DoxyCodeLine{02355\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02356\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ *name\ =\ (\textcolor{keywordtype}{char}\ *)serializer-\/>findNameForPointer(m\_links[i].m\_linkName);}
\DoxyCodeLine{02357\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_linkName\ =\ (\textcolor{keywordtype}{char}\ *)serializer-\/>getUniquePointer(name);}
\DoxyCodeLine{02358\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (memPtr-\/>m\_linkName)}
\DoxyCodeLine{02359\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02360\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ serializer-\/>serializeName(name);}
\DoxyCodeLine{02361\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02362\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02363\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02364\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ *name\ =\ (\textcolor{keywordtype}{char}\ *)serializer-\/>findNameForPointer(m\_links[i].m\_jointName);}
\DoxyCodeLine{02365\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_jointName\ =\ (\textcolor{keywordtype}{char}\ *)serializer-\/>getUniquePointer(name);}
\DoxyCodeLine{02366\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (memPtr-\/>m\_jointName)}
\DoxyCodeLine{02367\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02368\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ serializer-\/>serializeName(name);}
\DoxyCodeLine{02369\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02370\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02371\ \ \ \ \ \ \ \ \ \ \ \ \ memPtr-\/>m\_linkCollider\ =\ (btCollisionObjectData\ *)serializer-\/>getUniquePointer(getLink(i).m\_collider);}
\DoxyCodeLine{02372\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02373\ \ \ \ \ \ \ \ \ serializer-\/>finalizeChunk(chunk,\ btMultiBodyLinkDataName,\ BT\_ARRAY\_CODE,\ (\textcolor{keywordtype}{void}\ *)\&m\_links[0]);}
\DoxyCodeLine{02374\ \ \ \ \ \}}
\DoxyCodeLine{02375\ \ \ \ \ mbd-\/>m\_links\ =\ mbd-\/>m\_numLinks\ ?\ (btMultiBodyLinkData\ *)serializer-\/>getUniquePointer((\textcolor{keywordtype}{void}\ *)\&m\_links[0])\ :\ 0;}
\DoxyCodeLine{02376\ }
\DoxyCodeLine{02377\ \ \ \ \ \textcolor{comment}{//\ Fill\ padding\ with\ zeros\ to\ appease\ msan.}}
\DoxyCodeLine{02378\ \textcolor{preprocessor}{\#ifdef\ BT\_USE\_DOUBLE\_PRECISION}}
\DoxyCodeLine{02379\ \ \ \ \ memset(mbd-\/>m\_padding,\ 0,\ \textcolor{keyword}{sizeof}(mbd-\/>m\_padding));}
\DoxyCodeLine{02380\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{02381\ }
\DoxyCodeLine{02382\ \ \ \ \ \textcolor{keywordflow}{return}\ btMultiBodyDataName;}
\DoxyCodeLine{02383\ \}}
\DoxyCodeLine{02384\ }
\DoxyCodeLine{02385\ \textcolor{keywordtype}{void}\ btMultiBody::saveKinematicState(btScalar\ timeStep)}
\DoxyCodeLine{02386\ \{}
\DoxyCodeLine{02387\ \ \ \ \ \textcolor{comment}{//todo:\ clamp\ to\ some\ (user\ definable)\ safe\ minimum\ timestep,\ to\ limit\ maximum\ angular/linear\ velocities}}
\DoxyCodeLine{02388\ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_kinematic\_calculate\_velocity\ \&\&\ timeStep\ !=\ btScalar(0.))}
\DoxyCodeLine{02389\ \ \ \ \ \{}
\DoxyCodeLine{02390\ \ \ \ \ \ \ \ \ btVector3\ linearVelocity,\ angularVelocity;}
\DoxyCodeLine{02391\ \ \ \ \ \ \ \ \ btTransformUtil::calculateVelocity(getInterpolateBaseWorldTransform(),\ getBaseWorldTransform(),\ timeStep,\ linearVelocity,\ angularVelocity);}
\DoxyCodeLine{02392\ \ \ \ \ \ \ \ \ setBaseVel(linearVelocity);}
\DoxyCodeLine{02393\ \ \ \ \ \ \ \ \ setBaseOmega(angularVelocity);}
\DoxyCodeLine{02394\ \ \ \ \ \ \ \ \ setInterpolateBaseWorldTransform(getBaseWorldTransform());}
\DoxyCodeLine{02395\ \ \ \ \ \}}
\DoxyCodeLine{02396\ \}}
\DoxyCodeLine{02397\ }
\DoxyCodeLine{02398\ \textcolor{keywordtype}{void}\ btMultiBody::setLinkDynamicType(\textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ i,\ \textcolor{keywordtype}{int}\ type)}
\DoxyCodeLine{02399\ \{}
\DoxyCodeLine{02400\ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ -\/1)}
\DoxyCodeLine{02401\ \ \ \ \ \{}
\DoxyCodeLine{02402\ \ \ \ \ \ \ \ \ setBaseDynamicType(type);}
\DoxyCodeLine{02403\ \ \ \ \ \}}
\DoxyCodeLine{02404\ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (i\ >=\ 0\ \&\&\ i\ <\ getNumLinks())}
\DoxyCodeLine{02405\ \ \ \ \ \{}
\DoxyCodeLine{02406\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_links[i].m\_collider)}
\DoxyCodeLine{02407\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{02408\ \ \ \ \ \ \ \ \ \ \ \ \ m\_links[i].m\_collider-\/>setDynamicType(type);}
\DoxyCodeLine{02409\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{02410\ \ \ \ \ \}}
\DoxyCodeLine{02411\ \}}
\DoxyCodeLine{02412\ }
\DoxyCodeLine{02413\ \textcolor{keywordtype}{bool}\ btMultiBody::isLinkStaticOrKinematic(\textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{02414\ \textcolor{keyword}{}\{}
\DoxyCodeLine{02415\ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ -\/1)}
\DoxyCodeLine{02416\ \ \ \ \ \{}
\DoxyCodeLine{02417\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ isBaseStaticOrKinematic();}
\DoxyCodeLine{02418\ \ \ \ \ \}}
\DoxyCodeLine{02419\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02420\ \ \ \ \ \{}
\DoxyCodeLine{02421\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_links[i].m\_collider)}
\DoxyCodeLine{02422\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_collider-\/>isStaticOrKinematic();}
\DoxyCodeLine{02423\ \ \ \ \ \}}
\DoxyCodeLine{02424\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02425\ \}}
\DoxyCodeLine{02426\ }
\DoxyCodeLine{02427\ \textcolor{keywordtype}{bool}\ btMultiBody::isLinkKinematic(\textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{02428\ \textcolor{keyword}{}\{}
\DoxyCodeLine{02429\ \ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ -\/1)}
\DoxyCodeLine{02430\ \ \ \ \ \{}
\DoxyCodeLine{02431\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ isBaseKinematic();}
\DoxyCodeLine{02432\ \ \ \ \ \}}
\DoxyCodeLine{02433\ \ \ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{02434\ \ \ \ \ \{}
\DoxyCodeLine{02435\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (m\_links[i].m\_collider)}
\DoxyCodeLine{02436\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ m\_links[i].m\_collider-\/>isKinematic();}
\DoxyCodeLine{02437\ \ \ \ \ \}}
\DoxyCodeLine{02438\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02439\ \}}
\DoxyCodeLine{02440\ }
\DoxyCodeLine{02441\ \textcolor{keywordtype}{bool}\ btMultiBody::isLinkAndAllAncestorsStaticOrKinematic(\textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{02442\ \textcolor{keyword}{}\{}
\DoxyCodeLine{02443\ \ \ \ \ \textcolor{keywordtype}{int}\ link\ =\ i;}
\DoxyCodeLine{02444\ \ \ \ \ \textcolor{keywordflow}{while}\ (link\ !=\ -\/1)\ \{}
\DoxyCodeLine{02445\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!isLinkStaticOrKinematic(link))}
\DoxyCodeLine{02446\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02447\ \ \ \ \ \ \ \ \ link\ =\ m\_links[link].m\_parent;}
\DoxyCodeLine{02448\ \ \ \ \ \}}
\DoxyCodeLine{02449\ \ \ \ \ \textcolor{keywordflow}{return}\ isBaseStaticOrKinematic();}
\DoxyCodeLine{02450\ \}}
\DoxyCodeLine{02451\ }
\DoxyCodeLine{02452\ \textcolor{keywordtype}{bool}\ btMultiBody::isLinkAndAllAncestorsKinematic(\textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ i)\textcolor{keyword}{\ const}}
\DoxyCodeLine{02453\ \textcolor{keyword}{}\{}
\DoxyCodeLine{02454\ \ \ \ \ \textcolor{keywordtype}{int}\ link\ =\ i;}
\DoxyCodeLine{02455\ \ \ \ \ \textcolor{keywordflow}{while}\ (link\ !=\ -\/1)\ \{}
\DoxyCodeLine{02456\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!isLinkKinematic(link))}
\DoxyCodeLine{02457\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{02458\ \ \ \ \ \ \ \ \ link\ =\ m\_links[link].m\_parent;}
\DoxyCodeLine{02459\ \ \ \ \ \}}
\DoxyCodeLine{02460\ \ \ \ \ \textcolor{keywordflow}{return}\ isBaseKinematic();}
\DoxyCodeLine{02461\ \}}

\end{DoxyCode}
